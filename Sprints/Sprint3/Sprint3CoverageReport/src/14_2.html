<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Nick\Desktop\Capstone-Project\code\TaskManager\Controllers\AdminController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using TaskManagerWebsite.Data;
using TaskManagerWebsite.Models;
using TaskManagerWebsite.ViewModels;
using TaskManagerWebsite.ViewModels.ProjectViewModels;

namespace TaskManagerWebsite.Controllers
{
    /// &lt;summary&gt;
    /// Controller for administrative tasks, accessible only to users with the &quot;Admin&quot; role.
    /// Provides functionalities for managing users and groups.
    /// &lt;/summary&gt;
    /// &lt;seealso cref=&quot;Microsoft.AspNetCore.Mvc.Controller&quot; /&gt;
    public class AdminController(ApplicationDbContext context, UserManager&lt;User&gt; userManager, RoleManager&lt;IdentityRole&lt;int&gt;&gt; roleManager) : Controller
    {
        /// &lt;summary&gt;
        /// Retrieves and displays a list of all users.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;
        /// A view displaying all users.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; Users()
        {
            var users = await context.Users.ToListAsync();
            return View(users);
        }

        /// &lt;summary&gt;
        /// Retrieves details for a specific user by their ID.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;
        /// A view displaying user details or NotFound if the user does not exist.
        /// &lt;/returns&gt;
        public IActionResult UserAdd()
        {
            return View();
        }

        /// &lt;summary&gt;
        /// Adds the user
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;model&quot;&gt;The model.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; UserAdd(UserViewModel model)
        {
            if (!ModelState.IsValid)
                return View(model);

            var user = new User { UserName = model.UserName.Trim(), Email = model.Email };

            var createUserResult = await userManager.CreateAsync(user, model.Password);

            if (createUserResult.Succeeded)
            {
                var createUserRoleResult = await userManager.AddToRoleAsync(user, &quot;Employee&quot;);
                if (createUserRoleResult.Succeeded)
                {
                    return RedirectToAction(&quot;Users&quot;, &quot;Admin&quot;);
                }

                foreach (var error in createUserRoleResult.Errors)
                {
                    Console.WriteLine($&quot;Code: {error.Code}, Description: {error.Description}&quot;);
                    ModelState.AddModelError(string.Empty, error.Description);
                }
            }
            
            foreach (var error in createUserResult.Errors)
            {
                Console.WriteLine($&quot;Code: {error.Code}, Description: {error.Description}&quot;);
                ModelState.AddModelError(string.Empty, error.Description);
            }

            return View(model);
        }

        /// &lt;summary&gt;
        /// Retrieves the details of a user based on the provided user ID.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The unique identifier of the user.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Returns a view displaying the user details if found;
        /// otherwise, returns a &lt;see cref=&quot;NotFoundResult&quot; /&gt; if the user does not exist.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; UserDetails(int id)
        {
            var user = await context.Users.FindAsync(id);

            if (user == null)
            {
                return NotFound();
            }

            return View(user);
        }

        /// &lt;summary&gt;
        /// Retrieves and displays a list of all groups.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;
        /// A view displaying all groups.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; Groups()
        {
            var groups = await context.Groups.ToListAsync();

            foreach (var group in groups)
            {
                group.Manager = await context.Users.FindAsync(group.ManagerId);
            }

            return View(groups);
        }

        /// &lt;summary&gt;
        /// Displays the form for creating a new group.
        /// Populates managers and employees available for selection.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;
        /// A view for creating a new group.
        /// &lt;/returns&gt;
        public IActionResult CreateGroup()
        {
            var users = context.Users.ToList();

            ViewBag.Employees = users;

            return View();
        }


        /// &lt;summary&gt;
        /// Creates the group.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;model&quot;&gt;The model.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; CreateGroup(GroupViewModel model)
        {
            if (!ModelState.IsValid)
            {
                ViewBag.Employees = await context.Users.ToListAsync();
                return View(model);
            }

            var manager = await context.Users.FindAsync(model.SelectedManagerId);
            if (manager == null)
            {
                ModelState.AddModelError(&quot;SelectedManagerId&quot;, &quot;The selected manager does not exist.&quot;);
                ViewBag.Employees = await context.Users.ToListAsync();
                return View(model);
            }

            var group = new Group
            {
                Name = model.Name,
                Description = model.Description,
                Manager = manager
            };

            context.Groups.Add(group);
            await context.SaveChangesAsync();

            if (model.SelectedManagerId != null)
            {
                var managerEntry = new UserGroup
                {
                    UserId = (int)model.SelectedManagerId,
                    GroupId = group.Id,
                    Role = &quot;Manager&quot;
                };
                context.UserGroups.Add(managerEntry);
            }

            var employees = await context.Users
                .Where(u =&gt; model.SelectedUserIds.Contains(u.Id) &amp;&amp; u.Id != model.SelectedManagerId)
                .ToListAsync();

            foreach (var employee in employees)
            {
                context.UserGroups.Add(new UserGroup
                {
                    UserId = employee.Id,
                    GroupId = group.Id,
                    Role = &quot;Member&quot;
                });
            }

            await context.SaveChangesAsync();
            return RedirectToAction(&quot;Groups&quot;);
        }

        /// &lt;summary&gt;
        /// Deletes the group.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; DeleteGroup(int id)
        {
            var group = await context.Groups.FindAsync(id);
            if (group == null)
            {
                return RedirectToAction(nameof(Groups));
            }

            bool isAssignedToProject = await context.GroupProjects
                .AnyAsync(gp =&gt; gp.GroupId == id);

            if (isAssignedToProject)
            {
                TempData[&quot;ErrorMessage&quot;] = &quot;This group is assigned to one or more projects and cannot be deleted.&quot;;
                return RedirectToAction(nameof(Groups));
            }

            try
            {
                context.Groups.Remove(group);
                await context.SaveChangesAsync();
            }
            catch (DbUpdateException)
            {
                TempData[&quot;ErrorMessage&quot;] = &quot;Unable to delete this group because it is referenced elsewhere. Check project assignments&quot;;
            }

            return RedirectToAction(nameof(Groups));
        }


        /// &lt;summary&gt;
        /// Retrieves and displays detailed information for a specific group, including its users and managers,
        /// and also loads all users (excluding managers) and all managers from the database to allow adding new members.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the group.&lt;/param&gt;
        /// &lt;returns&gt;
        /// A view displaying group details or NotFound if the group does not exist.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; GroupDetails(int id)
        {
            var group = await context.Groups
                .Include(g =&gt; g.Manager)
                .FirstOrDefaultAsync(g =&gt; g.Id == id);

            if (group == null)
                return NotFound();

            var groupUsers = await context.UserGroups
                .Where(ug =&gt; ug.GroupId == id)
                .Include(ug =&gt; ug.User)
                .ToListAsync();

            var allUsers = await context.Users.ToListAsync();

            var availableEmployees = allUsers
                .Where(u =&gt; groupUsers.All(gu =&gt; gu.UserId != u.Id) &amp;&amp; (group.Manager == null || u.Id != group.Manager.Id))
                .ToList();

            var availableManagers = allUsers
                .Where(u =&gt; group.Manager == null || u.Id != group.Manager.Id)
                .ToList();

            ViewBag.Users = availableEmployees;
            ViewBag.AvailableManagers = availableManagers;
            ViewBag.GroupUsers = groupUsers;

            return View(group);
        }

        /// &lt;summary&gt;
        /// Adds a user to a specified group.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;groupId&quot;&gt;The ID of the group.&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;The ID of the user to be added.&lt;/param&gt;
        /// &lt;returns&gt;
        /// A redirect to the group&#39;s details page.
        /// &lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; AddUserToGroup(int groupId, int userId)
        {
            var group = await context.Groups.FindAsync(groupId);
            var user = await context.Users.FindAsync(userId);

            if (group == null || user == null)
            {
                return NotFound();
            }

            bool alreadyInGroup = await context.UserGroups.AnyAsync(ug =&gt; ug.GroupId == groupId &amp;&amp; ug.UserId == userId);
            if (!alreadyInGroup)
            {
                context.UserGroups.Add(new UserGroup
                {
                    UserId = userId,
                    GroupId = groupId,
                    Role = &quot;Member&quot;
                });

                await context.SaveChangesAsync();
            }

            group = await context.Groups.FirstOrDefaultAsync(g =&gt; g.Id == groupId);
            var groupUsers = await context.UserGroups
                .Where(ug =&gt; ug.GroupId == groupId)
                .Include(ug =&gt; ug.User)
                .ToListAsync();
            var allUsers = await context.Users.ToListAsync();

            var availableEmployees = allUsers
                .Where(u =&gt; groupUsers.All(gu =&gt; gu.UserId != u.Id) &amp;&amp; (group.Manager == null || u.Id != group.Manager.Id))
                .ToList();

            ViewBag.Users = availableEmployees;
            ViewBag.GroupUsers = groupUsers;

            return PartialView(&quot;_GroupUserAssignmentPartial&quot;, group);
        }

        /// &lt;summary&gt;
        /// Removes the user from group.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;groupId&quot;&gt;The group identifier.&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;The user identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; RemoveUserFromGroup(int groupId, int userId)
        {
            var userGroupEntry = await context.UserGroups.FirstOrDefaultAsync(ug =&gt; ug.GroupId == groupId &amp;&amp; ug.UserId == userId);
            if (userGroupEntry != null)
            {
                context.UserGroups.Remove(userGroupEntry);
                await context.SaveChangesAsync();
            }

            var group = await context.Groups.FirstOrDefaultAsync(g =&gt; g.Id == groupId);
            var groupUsers = await context.UserGroups
                .Where(ug =&gt; ug.GroupId == groupId)
                .Include(ug =&gt; ug.User)
                .ToListAsync();
            var allUsers = await context.Users.ToListAsync();

            var availableEmployees = allUsers
                .Where(u =&gt; groupUsers.All(gu =&gt; gu.UserId != u.Id) &amp;&amp; (group.Manager == null || u.Id != group.Manager.Id))
                .ToList();

            ViewBag.Users = availableEmployees;
            ViewBag.GroupUsers = groupUsers;

            return PartialView(&quot;_GroupUserAssignmentPartial&quot;, group);
        }

        /// &lt;summary&gt;
        /// Adds a manager to a specified group, with an option to set them as the primary manager.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;groupId&quot;&gt;The ID of the group.&lt;/param&gt;
        /// &lt;param name=&quot;managerId&quot;&gt;The ID of the manager to be added.&lt;/param&gt;
        /// &lt;param name=&quot;isPrimary&quot;&gt;Indicates if the manager should be the primary manager.&lt;/param&gt;
        /// &lt;returns&gt;
        /// A redirect to the group&#39;s details page.
        /// &lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; AddManagerToGroup(int groupId, int managerId, bool isPrimary)
        {
            var group = await context.Groups.FirstOrDefaultAsync(g =&gt; g.Id == groupId);
            var user = await context.Users.FindAsync(managerId);

            if (group == null || user == null)
            {
                return NotFound();
            }

            var userGroupEntry = await context.UserGroups
                .FirstOrDefaultAsync(ug =&gt; ug.GroupId == groupId &amp;&amp; ug.UserId == managerId);

            if (userGroupEntry == null)
            {
                userGroupEntry = new UserGroup
                {
                    UserId = managerId,
                    GroupId = groupId,
                    Role = &quot;Manager&quot;
                };
                context.UserGroups.Add(userGroupEntry);
            }
            else
            {
                userGroupEntry.Role = &quot;Manager&quot;;
                context.UserGroups.Update(userGroupEntry);
            }

            if (isPrimary)
            {
                group.ManagerId = managerId;
            }

            await context.SaveChangesAsync();
            return RedirectToAction(&quot;GroupDetails&quot;, new { id = groupId });
        }

        /// &lt;summary&gt;
        /// Changes the manager.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;groupId&quot;&gt;The group identifier.&lt;/param&gt;
        /// &lt;param name=&quot;newManagerId&quot;&gt;The new manager identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; ChangeManager(int groupId, int newManagerId)
        {
            var group = await context.Groups
                .Include(g =&gt; g.Manager)
                .FirstOrDefaultAsync(g =&gt; g.Id == groupId);

            if (group == null)
            {
                return NotFound();
            }

            var newManager = await context.Users.FindAsync(newManagerId);
            if (newManager == null)
            {
                return NotFound();
            }

            var newManagerEntry = await context.UserGroups
                .FirstOrDefaultAsync(ug =&gt; ug.GroupId == groupId &amp;&amp; ug.UserId == newManagerId);

            if (newManagerEntry == null)
            {
                newManagerEntry = new UserGroup
                {
                    GroupId = groupId,
                    UserId = newManagerId,
                    Role = &quot;Manager&quot;
                };
                context.UserGroups.Add(newManagerEntry);
            }
            else
            {
                newManagerEntry.Role = &quot;Manager&quot;;
                context.UserGroups.Update(newManagerEntry);
            }

            if (group.ManagerId.HasValue)
            {
                var previousManagerEntry = await context.UserGroups
                    .FirstOrDefaultAsync(ug =&gt; ug.GroupId == groupId &amp;&amp; ug.UserId == group.ManagerId);

                if (previousManagerEntry != null)
                {
                    previousManagerEntry.Role = &quot;Member&quot;;
                    context.UserGroups.Update(previousManagerEntry);
                }
            }

            group.ManagerId = newManagerId;
            await context.SaveChangesAsync();

            return RedirectToAction(&quot;GroupDetails&quot;, new { id = groupId });
        }

        /// &lt;summary&gt;
        /// Handles the creation of a new group, assigning selected managers and users.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;
        /// A redirect to the Groups list if successful, or returns the form with validation errors.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; Projects()
        {
            var projects = await context.Projects.ToListAsync();

            foreach (var project in projects)
            {
                project.ProjectLead = await context.Users.FindAsync(project.ProjectLeadId);
            }

            return View(projects);
        }

        /// &lt;summary&gt;
        /// Displays the form for creating a new project.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;
        /// A view with a list of available users to select as project leads.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; CreateProject()
        {
            var users = await context.Users.ToListAsync();
            var leads = context.Groups
                .Where(g =&gt; g.ManagerId != null) 
                .AsEnumerable()
                .Select(g =&gt; context.Users.FirstOrDefault(u =&gt; u.Id == g.ManagerId)) 
                .Where(u =&gt; u != null) 
                .Distinct() 
                .ToList();


            var currentAdmin = await userManager.GetUserAsync(User);
            leads.Add(currentAdmin);
            ViewBag.Groups = await context.Groups.ToListAsync();

            // Build the view model
            var model = new CreateProjectViewModel
            {
                ProjectLeads = leads.Select(u =&gt; new SelectListItem
                {
                    Value = u.Id.ToString(),
                    Text = u.UserName
                }).ToList()
            };

            return View(model);
        }

        /// &lt;summary&gt;
        /// Handles the submission of a new project creation form.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;model&quot;&gt;The CreateProjectViewModel containing user input.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Redirects to the projects list upon successful creation.
        /// If the model state is invalid or user is not logged in, returns the form with validation errors.
        /// &lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; CreateProject(CreateProjectViewModel model)
        {
            var users = await context.Users.ToListAsync();
            var leads = context.Groups
                .Where(g =&gt; g.ManagerId != null)
                .AsEnumerable()
                .Select(g =&gt; context.Users.FirstOrDefault(u =&gt; u.Id == g.ManagerId))
                .Where(u =&gt; u != null)
                .Distinct()
                .ToList();

            var currentAdmin = await userManager.GetUserAsync(User);
            leads.Add(currentAdmin);
            ViewBag.Groups = await context.Groups.ToListAsync();

            model.ProjectLeads = leads.Select(u =&gt; new SelectListItem
            {
                Value = u.Id.ToString(),
                Text = u.UserName
            }).ToList();

            if (!ModelState.IsValid)
            {
                return View(model);
            }

            var currentUserId = userManager.GetUserId(User);

            if (string.IsNullOrEmpty(currentUserId))
            {
                ModelState.AddModelError(&quot;&quot;, &quot;Unable to determine the logged-in user.&quot;);

                return View(model);
            }

            var project = new Project
            {
                Name = model.Name,
                Description = model.Description,
                ProjectLeadId = model.ProjectLeadId,
                ProjectCreatorId = int.Parse(currentUserId)
            };

            context.Projects.Add(project);
            await context.SaveChangesAsync();

            var selectedGroupIds = Request.Form[&quot;GroupId&quot;].ToList();
            if (selectedGroupIds.Count &gt; 0)
            {
                foreach (var groupId in selectedGroupIds)
                {
                    await this.AssignGroupToProject(project.Id, int.Parse(groupId));
                }

            }

            return RedirectToAction(nameof(Projects));
        }

        /// &lt;summary&gt;
        /// Retrieves the details of a specific project, including its lead and associated groups.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The unique identifier of the project.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Returns a view displaying the project details if found;
        /// otherwise, returns a &lt;see cref=&quot;NotFoundResult&quot; /&gt; if the project does not exist.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; ProjectDetails(int id)
        {
            var project = await context.Projects
                .Include(p =&gt; p.ProjectLead)
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == id);

            if (project == null)
            {
                return NotFound();
            }
            ViewBag.Groups = await context.Groups.ToListAsync();
            return View(project);
        }

        /// &lt;summary&gt;
        /// Assigns a group to a specified project if it is not already assigned.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;projectId&quot;&gt;The ID of the project.&lt;/param&gt;
        /// &lt;param name=&quot;groupId&quot;&gt;The ID of the group to be assigned.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Redirects to the project details page if successful; otherwise, returns
        /// a &lt;see cref=&quot;NotFoundResult&quot; /&gt; if the project or group is not found.
        /// &lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public virtual async Task&lt;IActionResult&gt; AssignGroupToProject(int projectId, int groupId)
        {
            var project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == projectId);

            if (project == null)
                return NotFound();

            var group = await context.Groups.FindAsync(groupId);
            if (group == null)
                return NotFound();

            if (project.ProjectGroups.All(pg =&gt; pg.GroupId != groupId))
            {
                context.GroupProjects.Add(new GroupProject { ProjectId = projectId, GroupId = groupId });
                await context.SaveChangesAsync();
            }

            project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == projectId);

            var allGroups = await context.Groups.ToListAsync();
            var assignedGroupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            ViewBag.Groups = allGroups.Where(g =&gt; !assignedGroupIds.Contains(g.Id)).ToList();

            return PartialView(&quot;_ProjectGroupAssignmentPartial&quot;, project);
        }


        /// &lt;summary&gt;
        /// Removes a group from a specified project if it is currently assigned.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;projectId&quot;&gt;The ID of the project.&lt;/param&gt;
        /// &lt;param name=&quot;groupId&quot;&gt;The ID of the group to be removed.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Redirects to the project details page if successful; otherwise, returns
        /// a &lt;see cref=&quot;NotFoundResult&quot; /&gt; if the project does not exist.
        /// &lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; RemoveGroupFromProject(int projectId, int groupId)
        {
            var project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == projectId);

            if (project == null)
                return NotFound();

            var projectGroup = project.ProjectGroups.FirstOrDefault(pg =&gt; pg.GroupId == groupId);
            if (projectGroup != null)
            {
                context.GroupProjects.Remove(projectGroup);
                await context.SaveChangesAsync();
            }

            project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == projectId);

            var allGroups = await context.Groups.ToListAsync();
            var assignedGroupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            ViewBag.Groups = allGroups.Where(g =&gt; !assignedGroupIds.Contains(g.Id)).ToList();

            return PartialView(&quot;_ProjectGroupAssignmentPartial&quot;, project);
        }

        /// &lt;summary&gt;
        /// Retrieves the project details for editing.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the project to edit.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Returns the edit view with the project details if found; otherwise, returns
        /// a &lt;see cref=&quot;NotFoundResult&quot; /&gt;.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; EditProject(int id)
        {
            var project = await context.Projects.FindAsync(id);
            if (project == null)
            {
                return NotFound();
            }

            ViewBag.ProjectLeads = await context.Users.ToListAsync();
            return View(project);
        }

        /// &lt;summary&gt;
        /// Updates the details of an existing project.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the project being edited.&lt;/param&gt;
        /// &lt;param name=&quot;project&quot;&gt;The updated project details.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Redirects to the project details page if successful.
        /// If the ID does not match or the project does not exist, returns
        /// a &lt;see cref=&quot;BadRequestResult&quot; /&gt; or &lt;see cref=&quot;NotFoundResult&quot; /&gt;.
        /// If an error occurs, the edit view is returned with validation messages.
        /// &lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; EditProject(int id, Project project)
        {
            if (id != project.Id)
            {
                return BadRequest();
            }

            if (ModelState.IsValid)
            {
                try
                {
                    var currentUserId = userManager.GetUserId(User);

                    if (string.IsNullOrEmpty(currentUserId))
                    {
                        ModelState.AddModelError(&quot;&quot;, &quot;Unable to determine the logged-in user.&quot;);
                        return View(project);
                    }

                    project.ProjectCreatorId = int.Parse(currentUserId);

                    context.Update(project);
                    await context.SaveChangesAsync();

                    return RedirectToAction(&quot;ProjectDetails&quot;, new { id = project.Id });
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!context.Projects.Any(p =&gt; p.Id == project.Id))
                    {
                        return NotFound();
                    }
                    throw;
                }
            }

            ViewBag.ProjectLeads = await context.Users.ToListAsync();
            return View(project);
        }

        /// &lt;summary&gt;
        /// Deletes a specified project from the system.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the project to delete.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Redirects to the project list after deletion.
        /// &lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; DeleteProject(int id)
        {
            var project = await context.Projects.FindAsync(id);
            if (project != null)
            {
                context.Projects.Remove(project);
                await context.SaveChangesAsync();
            }
            return RedirectToAction(nameof(Projects));
        }

        /// &lt;summary&gt;
        /// Displays the edit page for a specific user.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the user.&lt;/param&gt;
        /// &lt;returns&gt;
        /// A view displaying user edit options or NotFound if the user does not exist.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; UserEdit(string id)
        {
            var user = await userManager.FindByIdAsync(id);
            if (user == null)
            {
                return NotFound();
            }

            var roles = roleManager.Roles.Select(r =&gt; r.Name).ToList();

            var userRoles = await userManager.GetRolesAsync(user);
            string currentRole = userRoles.FirstOrDefault() ?? string.Empty;

            ViewBag.Roles = roles;
            ViewBag.CurrentRole = currentRole;

            return View(user);
        }

        /// &lt;summary&gt;
        /// Updates the details of a specific user, including their username, email, and role.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the user.&lt;/param&gt;
        /// &lt;param name=&quot;userName&quot;&gt;Name of the user.&lt;/param&gt;
        /// &lt;param name=&quot;email&quot;&gt;The email.&lt;/param&gt;
        /// &lt;param name=&quot;role&quot;&gt;The role.&lt;/param&gt;
        /// &lt;returns&gt;
        /// A redirect to the Users list.
        /// &lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; UserEdit(string id, string userName, string email, string role)
        {
            var user = await userManager.FindByIdAsync(id);
            if (user == null)
            {
                return NotFound();
            }

            user.UserName = userName;
            user.Email = email;
            await userManager.UpdateAsync(user);

            var userRoles = await userManager.GetRolesAsync(user);

            if (userRoles.Any())
            {
                await userManager.RemoveFromRolesAsync(user, userRoles);
            }

            if (!string.IsNullOrEmpty(role))
            {
                await userManager.AddToRoleAsync(user, role);

                if (role.Equals(&quot;Admin&quot;))
                {
                    var admin = new Admin
                    {
                        UserId = user.Id
                    };

                    context.Admins.Add(admin);
                    await context.SaveChangesAsync();
                }
            }

            return RedirectToAction(&quot;Users&quot;);
        }

        /// &lt;summary&gt;
        /// Displays the confirmation page for deleting a user, checking if they are a manager of any groups.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the user.&lt;/param&gt;
        /// &lt;returns&gt;
        /// A view displaying the user and their related groups if applicable.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; UserDelete(int id)
        {
            var user = await context.Users.FindAsync(id);
            if (user == null)
            {
                return NotFound();
            }

            var managedGroups = await context.Groups
                .Where(g =&gt; g.ManagerId == id)
                .ToListAsync();

            var managedGroupIds = managedGroups.Select(g =&gt; g.Id).ToList();

            var projects = await context.GroupProjects
                .Where(gp =&gt; managedGroupIds.Contains(gp.GroupId)) 
                .Select(gp =&gt; gp.Project)
                .Distinct()
                .ToListAsync();

            var viewModel = new UserDeleteViewModel
            {
                User = user,
                RelatedGroups = managedGroups,
                RelatedProjects = projects
            };

            return View(viewModel);
        }

        /// &lt;summary&gt;
        /// Confirms and executes the deletion of a user along with related groups if they are a manager.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the user to be deleted.&lt;/param&gt;
        /// &lt;returns&gt;
        /// A redirect to the Users list.
        /// &lt;/returns&gt;
        [HttpPost, ActionName(&quot;DeleteConfirmed&quot;)]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; DeleteConfirmed(int id)
        {
            var user = await context.Users.FindAsync(id);
            if (user == null)
            {
                return NotFound();
            }

            var managedGroups = await context.Groups
                .Where(g =&gt; g.ManagerId == id)
                .ToListAsync();

            if (managedGroups.Any())
            {
                TempData[&quot;ErrorMessage&quot;] = &quot;Cannot delete this user because they are a manager of a group or a group they manage is referenced in a project.&quot;;
                return RedirectToAction(nameof(UserDelete), new { id });
            }

            context.Users.Remove(user);
            await context.SaveChangesAsync();

            return RedirectToAction(nameof(Users));
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,18,20,138,1],[29,9,29,10,1],[30,13,30,59,1],[31,13,31,32,1],[32,9,32,10,1],[41,9,41,10,1],[42,13,42,27,1],[43,9,43,10,1],[53,9,53,10,1],[54,13,54,37,1],[55,17,55,36,1],[57,13,57,91,1],[59,13,59,88,1],[61,13,61,44,1],[62,13,62,14,1],[63,17,63,95,1],[64,17,64,52,1],[65,17,65,18,1],[66,21,66,63,1],[69,17,69,24,1],[69,26,69,35,1],[69,36,69,38,1],[69,39,69,66,1],[70,17,70,18,1],[71,21,71,96,1],[72,21,72,79,1],[73,17,73,18,1],[74,13,74,14,1],[76,13,76,20,1],[76,22,76,31,1],[76,32,76,34,1],[76,35,76,58,1],[77,13,77,14,1],[78,17,78,92,1],[79,17,79,75,1],[80,13,80,14,1],[82,13,82,32,1],[83,9,83,10,1],[94,9,94,10,1],[95,13,95,58,1],[97,13,97,30,1],[98,13,98,14,1],[99,17,99,35,1],[102,13,102,31,1],[103,9,103,10,1],[112,9,112,10,1],[113,13,113,61,1],[115,13,115,20,1],[115,22,115,31,1],[115,32,115,34,1],[115,35,115,41,1],[116,13,116,14,1],[117,17,117,80,1],[118,13,118,14,1],[120,13,120,33,1],[121,9,121,10,1],[131,9,131,10,1],[132,13,132,48,1],[134,13,134,39,1],[136,13,136,27,1],[137,9,137,10,1],[148,9,148,10,1],[149,13,149,37,1],[150,13,150,14,1],[151,17,151,71,1],[152,17,152,36,1],[155,13,155,82,1],[156,13,156,33,1],[157,13,157,14,1],[158,17,158,103,1],[159,17,159,71,1],[160,17,160,36,1],[163,13,168,15,1],[170,13,170,39,1],[171,13,171,46,1],[173,13,173,49,1],[174,13,174,14,1],[175,17,180,19,1],[181,17,181,54,1],[182,13,182,14,1],[184,13,186,32,1],[188,13,188,20,1],[188,22,188,34,1],[188,35,188,37,1],[188,38,188,47,1],[189,13,189,14,1],[190,17,195,20,1],[196,13,196,14,1],[198,13,198,46,1],[199,13,199,47,1],[200,9,200,10,1],[210,9,210,10,1],[211,13,211,60,1],[212,13,212,31,1],[213,13,213,14,1],[214,17,214,57,1],[217,13,218,51,1],[220,13,220,37,1],[221,13,221,14,1],[222,17,222,116,1],[223,17,223,57,1],[227,13,227,14,1],[228,17,228,46,1],[229,17,229,50,1],[230,13,230,14,1],[231,13,231,38,1],[232,13,232,14,1],[233,17,233,136,1],[234,13,234,14,1],[236,13,236,53,1],[237,9,237,10,1],[249,9,249,10,1],[250,13,252,55,1],[254,13,254,31,1],[255,17,255,35,1],[257,13,260,32,1],[262,13,262,62,1],[264,13,265,29,1],[265,29,265,50,1],[265,50,265,67,1],[265,67,265,123,1],[265,123,266,27,1],[268,13,269,29,1],[269,29,269,78,1],[269,78,270,27,1],[272,13,272,48,1],[273,13,273,59,1],[274,13,274,45,1],[276,13,276,32,1],[277,9,277,10,1],[290,9,290,10,1],[291,13,291,65,1],[292,13,292,62,1],[294,13,294,47,1],[295,13,295,14,1],[296,17,296,35,1],[299,13,299,121,1],[300,13,300,33,1],[301,13,301,14,1],[302,17,307,20,1],[309,17,309,50,1],[310,13,310,14,1],[312,13,312,84,1],[313,13,316,32,1],[317,13,317,62,1],[319,13,320,29,1],[320,29,320,50,1],[320,50,320,67,1],[320,67,320,123,1],[320,123,321,27,1],[323,13,323,48,1],[324,13,324,45,1],[326,13,326,70,1],[327,9,327,10,1],[338,9,338,10,0],[339,13,339,131,0],[340,13,340,40,0],[341,13,341,14,0],[342,17,342,59,0],[343,17,343,50,0],[344,13,344,14,0],[346,13,346,88,0],[347,13,350,32,0],[351,13,351,62,0],[353,13,354,29,0],[354,29,354,50,0],[354,50,354,67,0],[354,67,354,123,0],[354,123,355,27,0],[357,13,357,48,0],[358,13,358,45,0],[360,13,360,70,0],[361,9,361,10,0],[375,9,375,10,1],[376,13,376,88,1],[377,13,377,65,1],[379,13,379,47,1],[380,13,380,14,1],[381,17,381,35,1],[384,13,385,93,1],[387,13,387,40,1],[388,13,388,14,1],[389,17,394,19,1],[395,17,395,56,1],[396,13,396,14,1],[398,13,398,14,0],[399,17,399,49,0],[400,17,400,59,0],[401,13,401,14,0],[403,13,403,27,1],[404,13,404,14,1],[405,17,405,45,1],[406,13,406,14,1],[408,13,408,46,1],[409,13,409,75,1],[410,9,410,10,1],[421,9,421,10,1],[422,13,424,60,1],[426,13,426,31,1],[427,13,427,14,1],[428,17,428,35,1],[431,13,431,74,1],[432,13,432,36,1],[433,13,433,14,1],[434,17,434,35,1],[437,13,438,96,1],[440,13,440,41,1],[441,13,441,14,1],[442,17,447,19,1],[448,17,448,57,1],[449,13,449,14,1],[451,13,451,14,0],[452,17,452,50,0],[453,17,453,60,0],[454,13,454,14,0],[456,13,456,42,1],[457,13,457,14,1],[458,17,459,103,1],[461,17,461,50,1],[462,17,462,18,1],[463,21,463,58,1],[464,21,464,69,1],[465,17,465,18,1],[466,13,466,14,1],[468,13,468,44,1],[469,13,469,46,1],[471,13,471,75,1],[472,9,472,10,1],[481,9,481,10,1],[482,13,482,65,1],[484,13,484,20,1],[484,22,484,33,1],[484,34,484,36,1],[484,37,484,45,1],[485,13,485,14,1],[486,17,486,92,1],[487,13,487,14,1],[489,13,489,35,1],[490,9,490,10,1],[499,9,499,10,1],[500,13,500,59,1],[501,13,504,30,1],[504,30,504,84,0],[504,84,505,29,1],[505,29,505,38,0],[505,38,507,27,1],[510,13,510,69,1],[511,13,511,37,1],[512,13,512,65,1],[515,13,517,50,1],[517,50,521,18,1],[521,18,522,15,1],[524,13,524,32,1],[525,9,525,10,1],[538,9,538,10,1],[539,13,539,59,1],[540,13,543,30,1],[543,30,543,84,1],[543,84,544,29,1],[544,29,544,38,1],[544,38,546,27,1],[548,13,548,69,1],[549,13,549,37,1],[550,13,550,65,1],[552,13,552,52,1],[552,52,556,14,1],[556,14,556,25,1],[558,13,558,37,1],[559,13,559,14,1],[560,17,560,36,1],[563,13,563,61,1],[565,13,565,53,1],[566,13,566,14,1],[567,17,567,89,1],[569,17,569,36,1],[572,13,578,15,1],[580,13,580,43,1],[581,13,581,46,1],[583,13,583,69,1],[584,13,584,44,1],[585,13,585,14,1],[586,17,586,24,1],[586,26,586,37,1],[586,38,586,40,1],[586,41,586,57,1],[587,17,587,18,1],[588,21,588,85,1],[589,17,589,18,1],[591,13,591,14,1],[593,13,593,55,1],[594,9,594,10,1],[605,9,605,10,1],[606,13,610,55,1],[612,13,612,33,1],[613,13,613,14,1],[614,17,614,35,1],[616,13,616,65,0],[617,13,617,34,0],[618,9,618,10,1],[632,9,632,10,1],[633,13,636,62,1],[638,13,638,33,1],[639,17,639,35,1],[641,13,641,65,1],[642,13,642,31,1],[643,17,643,35,1],[645,13,645,49,1],[645,49,645,70,1],[645,70,645,72,1],[646,13,646,14,1],[647,17,647,106,1],[648,17,648,50,1],[649,13,649,14,1],[651,13,654,62,1],[656,13,656,64,1],[657,13,657,71,1],[657,71,657,81,1],[657,81,657,92,1],[658,13,658,51,1],[658,51,658,83,1],[658,83,658,94,1],[660,13,660,75,1],[661,9,661,10,1],[676,9,676,10,1],[677,13,680,62,1],[682,13,682,33,1],[683,17,683,35,1],[685,13,685,75,1],[685,75,685,96,1],[685,96,685,98,1],[686,13,686,38,1],[687,13,687,14,1],[688,17,688,60,1],[689,17,689,50,1],[690,13,690,14,1],[692,13,695,62,1],[697,13,697,64,1],[698,13,698,71,1],[698,71,698,81,0],[698,81,698,92,1],[699,13,699,51,1],[699,51,699,83,0],[699,83,699,94,1],[701,13,701,75,1],[702,9,702,10,1],[713,9,713,10,1],[714,13,714,64,1],[715,13,715,33,1],[716,13,716,14,1],[717,17,717,35,1],[720,13,720,70,1],[721,13,721,34,1],[722,9,722,10,1],[738,9,738,10,1],[739,13,739,34,1],[740,13,740,14,1],[741,17,741,37,1],[744,13,744,36,1],[745,13,745,14,1],[747,17,747,18,1],[748,21,748,69,1],[750,21,750,61,1],[751,21,751,22,1],[752,25,752,97,1],[753,25,753,46,1],[756,21,756,73,1],[758,21,758,45,1],[759,21,759,54,1],[761,21,761,88,1],[763,17,763,53,1],[764,17,764,18,1],[765,21,765,72,1],[766,21,766,22,1],[767,25,767,43,1],[769,21,769,27,0],[773,13,773,70,0],[774,13,774,34,0],[775,9,775,10,1],[787,9,787,10,1],[788,13,788,64,1],[789,13,789,33,1],[790,13,790,14,1],[791,17,791,50,1],[792,17,792,50,1],[793,13,793,14,1],[794,13,794,55,1],[795,9,795,10,1],[805,9,805,10,1],[806,13,806,60,1],[807,13,807,30,1],[808,13,808,14,1],[809,17,809,35,1],[812,13,812,72,1],[814,13,814,67,1],[815,13,815,77,1],[817,13,817,35,1],[818,13,818,47,1],[820,13,820,31,1],[821,9,821,10,1],[836,9,836,10,1],[837,13,837,60,1],[838,13,838,30,1],[839,13,839,14,1],[840,17,840,35,1],[843,13,843,38,1],[844,13,844,32,1],[845,13,845,49,1],[847,13,847,67,1],[849,13,849,33,1],[850,13,850,14,1],[851,17,851,73,1],[852,13,852,14,1],[854,13,854,45,1],[855,13,855,14,1],[856,17,856,62,1],[858,17,858,42,1],[859,17,859,18,1],[860,21,863,23,1],[865,21,865,47,1],[866,21,866,54,1],[867,17,867,18,1],[868,13,868,14,1],[870,13,870,46,1],[871,9,871,10,1],[881,9,881,10,1],[882,13,882,58,1],[883,13,883,30,1],[884,13,884,14,1],[885,17,885,35,1],[888,13,890,32,1],[892,13,892,61,1],[892,61,892,65,0],[892,65,892,76,1],[894,13,898,32,1],[900,13,905,15,1],[907,13,907,36,1],[908,9,908,10,1],[920,9,920,10,1],[921,13,921,58,1],[922,13,922,30,1],[923,13,923,14,0],[924,17,924,35,0],[927,13,929,32,1],[931,13,931,37,1],[932,13,932,14,0],[933,17,933,159,0],[934,17,934,73,0],[937,13,937,40,1],[938,13,938,46,1],[940,13,940,52,1],[941,9,941,10,1]]);
    </script>
  </body>
</html>