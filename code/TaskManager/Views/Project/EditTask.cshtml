@using Microsoft.AspNetCore.Mvc.TagHelpers
@model TaskManagerWebsite.ViewModels.ProjectViewModels.CreateTaskViewModel

@{
    ViewBag.Title = "Edit Task";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@Html.ValidationSummary(true, "", new { @class = "text-danger" })

<link rel="stylesheet" href="~/css/Project/editTask.css" />

<div style="text-align:center;">
    <h2>Task @Model.Name</h2>

    <form asp-action="EditTask" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="TaskId"/>

        <div class="row mb-3">
            <div class="col-md-3">
                <label asp-for="Name" class="form-label d-block text-center">Name</label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="col-md-6">
                <label asp-for="Description" class="form-label d-block text-center">Description</label>
                <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <div class="col-md-3">
                <label asp-for="SelectedEmployeeId" class="form-label d-block text-center">Assign to</label>
                <select asp-for="SelectedEmployeeId" asp-items="Model.AvailableEmployees" class="form-control">
                    <option value="">-- None --</option>
                </select>
            </div>
        </div>



        <div class="d-flex justify-content-center gap-3 mt-3">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a asp-action="ProjectBoard" asp-route-id="@ViewBag.ProjectId" class="btn btn-secondary">Cancel</a>
        </div>


    </form>
    
    <div class="accordion mt-5" id="taskHistoryAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="historyHeader">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistory" aria-expanded="false" aria-controls="collapseHistory">
                    Task History
                </button>
            </h2>
            <div id="collapseHistory" class="accordion-collapse collapse" aria-labelledby="historyHeader" data-bs-parent="#taskHistoryAccordion">
                <div class="accordion-body">
                    @if (Model.TaskHistory != null && Model.TaskHistory.Any())
                    {
                        <ul class="list-group">
                            @foreach (var item in Model.TaskHistory)
                            {
                                <li class="list-group-item">
                                    <strong>@item.Timestamp.ToString("g")</strong> — @item.User.UserName: @item.Action
                                </li>
                            }
                        </ul>


                    }
                    else
                    {
                        <p>No history available for this task.</p>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <div class="accordion mt-5" id="commentsAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="commentsHeader">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseComments" aria-expanded="false" aria-controls="collapseComments">
                    Comments
                </button>
            </h2>
            <div id="collapseComments" class="accordion-collapse collapse" aria-labelledby="commentsHeader" data-bs-parent="#commentsAccordion">
                <div class="accordion-body">
                    @if (Model.Comments != null && Model.Comments.Any())
                    {
                        <ul class="list-group mb-3">
                            @foreach (var comment in Model.Comments)
                            {
                                <li class="list-group-item">
                                    <strong>@comment.Timestamp.ToString("g")</strong> – @comment.User.UserName: @comment.Content
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p>No comments have been added yet.</p>
                    }

                    <!-- Comment submission form inside accordion -->
                    <form asp-action="AddComment" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="TaskId" />
                        <div class="mb-3">
                            <label asp-for="NewComment" class="form-label">Add Comment:</label>
                            <textarea asp-for="NewComment" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="NewComment" class="text-danger"></span>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Comment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}