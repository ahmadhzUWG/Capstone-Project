<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\ahmad\Documents\GitHub\Capstone-Project\code\TaskManager\Controllers\ManagerController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using TaskManagerWebsite.Data;
using TaskManagerWebsite.Models;

namespace TaskManagerWebsite.Controllers
{
    [Authorize(Roles = &quot;Manager&quot;)]
    public class ManagerController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager&lt;User&gt; _userManager;
        private readonly RoleManager&lt;IdentityRole&lt;int&gt;&gt; _roleManager;

        public ManagerController(ApplicationDbContext context, UserManager&lt;User&gt; userManager, RoleManager&lt;IdentityRole&lt;int&gt;&gt; roleManager)
        {
            _context = context;
            _userManager = userManager;
            _roleManager = roleManager;
        }

        public async Task&lt;IActionResult&gt; Users()
        {
            var users = await _context.Users.ToListAsync();
            return View(users);
        }

        public async Task&lt;IActionResult&gt; Groups()
        {
            var groups = await _context.Groups.ToListAsync();
            return View(groups);
        }

        public async Task&lt;IActionResult&gt; Projects()
        {
            var userId = _userManager.GetUserId(User);
            ViewBag.UserId = userId;

            var groupRequests = await _context.GroupRequests
                .Include(gr =&gt; gr.Group)
                .Include(gr =&gt; gr.Project)
                .Where(gr =&gt; gr.Group.PrimaryManagerId == int.Parse(userId) &amp;&amp; gr.Response == null)
                .ToListAsync();
            ViewBag.GroupRequests = groupRequests;

            var sentGroupRequests = await _context.GroupRequests
                .Include(gr =&gt; gr.Group)
                .Include(gr =&gt; gr.Project)
                .Where(gr =&gt; gr.SenderId == int.Parse(userId) &amp;&amp; gr.Response != null)
                .ToListAsync();
            ViewBag.SentGroupRequests = sentGroupRequests;

            var projects = await _context.Projects.ToListAsync();
            return View(projects);
        }


        public async Task&lt;IActionResult&gt; CreateProject()
        {
            var users = await _context.Users.ToListAsync();
            ViewBag.ProjectLeads = users;
            ViewBag.Groups = await _context.Groups.ToListAsync();
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; CreateProject(Project project)
        {
            if (ModelState.IsValid)
            {
                var currentUserId = _userManager.GetUserId(User);

                if (string.IsNullOrEmpty(currentUserId))
                {
                    ModelState.AddModelError(&quot;&quot;, &quot;Unable to determine the logged-in user.&quot;);
                    return View(project);
                }

                project.ProjectCreatorId = int.Parse(currentUserId);

                _context.Projects.Add(project);
                await _context.SaveChangesAsync();
                return RedirectToAction(nameof(Projects));
            }

            ViewBag.ProjectLeads = await _context.Users.ToListAsync();
            return View(project);
        }

        public async Task&lt;IActionResult&gt; ProjectDetails(int id)
        {
            var currentUserId = _userManager.GetUserId(User);
            ViewBag.UserId = currentUserId;

            var groups = await _context.Groups.Include(group =&gt; group.Managers).ToListAsync();
            var managedGroups = groups.Where(group =&gt; group.Managers
                .Any(manager =&gt; manager.UserId == int.Parse(currentUserId))).ToList();

            var managedGroupsToRemove = new List&lt;Group&gt;();

            //Remove managed groups that are already assigned to the project
            foreach (var group1 in groups)
            {
                List&lt;Group&gt; groupsWithGivenProject = _context.GroupProjects
                    .Where(gp =&gt; gp.ProjectId == id)
                    .Select(gp =&gt; gp.Group)
                    .Distinct()
                    .ToList();
                foreach (var groupInProject in groupsWithGivenProject)
                {
                    if (groupInProject.Id == group1.Id)
                    {
                        managedGroupsToRemove.Add(group1);
                        break;
                    }
                }
            }

            managedGroups.RemoveAll(group =&gt; managedGroupsToRemove.Contains(group));
            ViewBag.ManagedGroups = managedGroups;

            var unmanagedGroups = groups.Where(group =&gt; !group.Managers
                .Any(manager =&gt; manager.UserId == int.Parse(currentUserId))).ToList();

            var groupsToRemove = new List&lt;Group&gt;();

            // Remove unmanaged groups that are already assigned to the project
            foreach (var group in unmanagedGroups)
            {
                List&lt;Group&gt; groupsWithGivenProject = _context.GroupProjects
                    .Where(gp =&gt; gp.ProjectId == id) 
                    .Select(gp =&gt; gp.Group)  
                    .Distinct() 
                    .ToList();
                foreach (var groupInProject in groupsWithGivenProject)
                {
                    if (groupInProject.Id == group.Id)
                    {
                        groupsToRemove.Add(group);
                        break;
                    }
                }
            }

            unmanagedGroups.RemoveAll(group =&gt; groupsToRemove.Contains(group));
            ViewBag.UnmanagedGroups = unmanagedGroups;

            var project = await _context.Projects
                .Include(p =&gt; p.ProjectLead)
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == id);

            if (project == null)
            {
                return NotFound();
            }

            return View(project);
        }

        public async Task&lt;IActionResult&gt; EditProject(int id)
        {
            var project = await _context.Projects.FindAsync(id);
            if (project == null)
            {
                return NotFound();
            }

            ViewBag.ProjectLeads = await _context.Users.ToListAsync();
            return View(project);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; EditProject(int id, Project project)
        {
            if (id != project.Id)
            {
                return BadRequest();
            }

            if (ModelState.IsValid)
            {
                try
                {
                    var currentUserId = _userManager.GetUserId(User);

                    if (string.IsNullOrEmpty(currentUserId))
                    {
                        ModelState.AddModelError(&quot;&quot;, &quot;Unable to determine the logged-in user.&quot;);
                        return View(project);
                    }

                    project.ProjectCreatorId = int.Parse(currentUserId);

                    _context.Update(project);
                    await _context.SaveChangesAsync();
                    return RedirectToAction(&quot;ProjectDetails&quot;, new { id = project.Id });
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!_context.Projects.Any(p =&gt; p.Id == project.Id))
                    {
                        return NotFound();
                    }
                    throw;
                }
            }

            ViewBag.ProjectLeads = await _context.Users.ToListAsync();
            return View(project);
        }


        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; DeleteProject(int id)
        {
            var project = await _context.Projects.FindAsync(id);
            if (project != null)
            {
                _context.Projects.Remove(project);
                await _context.SaveChangesAsync();
            }
            return RedirectToAction(nameof(Projects));
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; RequestGroupToProject(int projectId, int groupId)
        {
            var currentUserId = _userManager.GetUserId(User);

            if (string.IsNullOrEmpty(currentUserId))
            {
                return Unauthorized();
            }

            var projectExists = await _context.Projects.AnyAsync(p =&gt; p.Id == projectId);
            var groupExists = await _context.Groups.AnyAsync(g =&gt; g.Id == groupId);

            if (!projectExists || !groupExists)
            {
                TempData[&quot;ErrorMessage&quot;] = &quot;No group selected&quot;;
                return RedirectToAction(&quot;ProjectDetails&quot;, &quot;Manager&quot;, new { id = projectId });
            }

            var existingRequest = await _context.GroupRequests
                .Where(gr =&gt; gr.SenderId == int.Parse(currentUserId) &amp;&amp; gr.ProjectId == projectId &amp;&amp; gr.GroupId == groupId)
                .FirstOrDefaultAsync&lt;GroupRequest&gt;();

            if (existingRequest != null)
            {
                TempData[&quot;ErrorMessage&quot;] = &quot;You have already requested to assign this group to the project.&quot;;
                return RedirectToAction(&quot;ProjectDetails&quot;, &quot;Manager&quot;, new { id = projectId });  
            }

            var groupRequest = new GroupRequest
            {
                SenderId = int.Parse(currentUserId),  
                ProjectId = projectId,     
                GroupId = groupId,         
                Response = null,
                Group = _context.Groups.Find(groupId),
                Project = _context.Projects.Find(projectId)
            };

            TempData[&quot;SuccessMessage&quot;] = &quot;You have successfully requested to assign this group to the project.&quot;;

            _context.GroupRequests.Add(groupRequest);
            await _context.SaveChangesAsync();

            return RedirectToAction(&quot;ProjectDetails&quot;, &quot;Manager&quot;, new {id = projectId});
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; AssignGroupToProject(int projectId, int groupId)
        {
            var userId = _userManager.GetUserId(User);
            ViewBag.UserId = userId;

            var groups = await _context.Groups.ToListAsync();
            ViewBag.Groups = groups;


            var project = await _context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .FirstOrDefaultAsync(p =&gt; p.Id == projectId);

            var group2 = await _context.Groups.FindAsync(groupId);

            if (project == null || group2 == null)
            {
                TempData[&quot;AssignedErrorMessage&quot;] = &quot;No group selected&quot;;
                return RedirectToAction(&quot;ProjectDetails&quot;, &quot;Manager&quot;, new { id = projectId });
            }

            // Check if the group is already assigned
            if (!project.ProjectGroups.Any(pg =&gt; pg.GroupId == groupId))
            {
                project.ProjectGroups.Add(new GroupProject
                {
                    ProjectId = projectId,
                    GroupId = groupId
                });
                await _context.SaveChangesAsync();
            }

            return RedirectToAction(&quot;ProjectDetails&quot;, new { id = projectId });
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; RemoveGroupFromProject(int projectId, int groupId)
        {
            var project = await _context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .FirstOrDefaultAsync(p =&gt; p.Id == projectId);

            if (project == null)
            {
                return NotFound();
            }

            var projectGroup = project.ProjectGroups.FirstOrDefault(pg =&gt; pg.GroupId == groupId);

            if (projectGroup != null)
            {
                project.ProjectGroups.Remove(projectGroup);
                await _context.SaveChangesAsync();
            }

            return RedirectToAction(&quot;ProjectDetails&quot;, new { id = projectId });
        }

        [HttpPost]
        public async Task&lt;IActionResult&gt; AcceptRequest(int requestId)
        {
            var request = await _context.GroupRequests.FindAsync(requestId);

            if (request == null)
            {
                return NotFound();
            }

            bool isAlreadyAssigned = await _context.GroupProjects
                .AnyAsync(gp =&gt; gp.ProjectId == request.ProjectId &amp;&amp; gp.GroupId == request.GroupId);

            if (!isAlreadyAssigned)
            {
                var groupProject = new GroupProject
                {
                    ProjectId = request.ProjectId,
                    GroupId = request.GroupId
                };

                _context.GroupProjects.Add(groupProject);
            }

            request.Response = true; 
            await _context.SaveChangesAsync();

            TempData[&quot;SuccessMessage&quot;] = &quot;The group request has been accepted.&quot;;
            return RedirectToAction(&quot;Projects&quot;);
        }

        [HttpPost]
        public async Task&lt;IActionResult&gt; DenyRequest(int requestId)
        {
            var request = await _context.GroupRequests.FindAsync(requestId);

            if (request == null)
            {
                return NotFound();
            }

            request.Response = false; 
            await _context.SaveChangesAsync();

            TempData[&quot;ErrorMessage&quot;] = &quot;The group request has been denied.&quot;;
            return RedirectToAction(&quot;Projects&quot;);
        }

        [HttpPost]
        public async Task&lt;IActionResult&gt; DeleteGroupRequest(int requestId)
        {
            var groupRequest = await _context.GroupRequests.FirstOrDefaultAsync(g =&gt; g.Id == requestId);
            if (groupRequest != null)
            {
                _context.GroupRequests.Remove(groupRequest);
                await _context.SaveChangesAsync();
            }

            return RedirectToAction(&quot;Projects&quot;);  
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,138,1],[18,9,18,10,1],[19,13,19,32,1],[20,13,20,40,1],[21,13,21,40,1],[22,9,22,10,1],[25,9,25,10,1],[26,13,26,60,1],[27,13,27,32,1],[28,9,28,10,1],[31,9,31,10,1],[32,13,32,62,1],[33,13,33,33,1],[34,9,34,10,1],[37,9,37,10,1],[38,13,38,55,1],[39,13,39,37,1],[41,13,45,32,1],[46,13,46,51,1],[48,13,52,32,1],[53,13,53,59,1],[55,13,55,66,1],[56,13,56,35,1],[57,9,57,10,1],[61,9,61,10,1],[62,13,62,60,1],[63,13,63,42,1],[64,13,64,66,1],[65,13,65,27,1],[66,9,66,10,1],[71,9,71,10,1],[72,13,72,36,1],[73,13,73,14,1],[74,17,74,66,1],[76,17,76,57,1],[77,17,77,18,1],[78,21,78,93,1],[79,21,79,42,1],[82,17,82,69,1],[84,17,84,48,1],[85,17,85,51,1],[86,17,86,59,1],[89,13,89,71,1],[90,13,90,34,1],[91,9,91,10,1],[94,9,94,10,1],[95,13,95,62,1],[96,13,96,44,1],[98,13,98,95,1],[99,13,99,55,1],[99,55,100,33,1],[100,33,100,75,1],[100,75,100,76,1],[100,76,100,87,1],[102,13,102,59,1],[105,13,105,20,1],[105,22,105,32,1],[105,33,105,35,1],[105,36,105,42,1],[106,13,106,14,1],[107,17,111,31,1],[112,17,112,24,1],[112,26,112,44,1],[112,45,112,47,1],[112,48,112,70,1],[113,17,113,18,1],[114,21,114,56,1],[115,21,115,22,1],[116,25,116,59,1],[117,25,117,31,1],[119,17,119,18,1],[120,13,120,14,1],[122,13,122,46,1],[122,46,122,83,1],[122,83,122,85,1],[123,13,123,51,1],[125,13,125,57,1],[125,57,126,33,1],[126,33,126,75,1],[126,75,126,76,1],[126,76,126,87,1],[128,13,128,52,1],[131,13,131,20,1],[131,22,131,31,1],[131,32,131,34,1],[131,35,131,50,1],[132,13,132,14,1],[133,17,137,31,1],[138,17,138,24,1],[138,26,138,44,1],[138,45,138,47,1],[138,48,138,70,1],[139,17,139,18,1],[140,21,140,55,1],[141,21,141,22,1],[142,25,142,51,1],[143,25,143,31,1],[145,17,145,18,1],[146,13,146,14,1],[148,13,148,48,1],[148,48,148,78,1],[148,78,148,80,1],[149,13,149,55,1],[151,13,155,55,1],[157,13,157,33,1],[158,13,158,14,1],[159,17,159,35,1],[162,13,162,34,1],[163,9,163,10,1],[166,9,166,10,1],[167,13,167,65,1],[168,13,168,33,1],[169,13,169,14,1],[170,17,170,35,1],[173,13,173,71,1],[174,13,174,34,1],[175,9,175,10,1],[180,9,180,10,1],[181,13,181,34,1],[182,13,182,14,1],[183,17,183,37,1],[186,13,186,36,1],[187,13,187,14,1],[189,17,189,18,1],[190,21,190,70,1],[192,21,192,61,1],[193,21,193,22,1],[194,25,194,97,1],[195,25,195,46,1],[198,21,198,73,1],[200,21,200,46,1],[201,21,201,55,1],[202,21,202,88,1],[204,17,204,53,0],[205,17,205,18,0],[206,21,206,73,0],[207,21,207,22,0],[208,25,208,43,0],[210,21,210,27,0],[214,13,214,71,1],[215,13,215,34,1],[216,9,216,10,1],[222,9,222,10,1],[223,13,223,65,1],[224,13,224,33,1],[225,13,225,14,1],[226,17,226,51,1],[227,17,227,51,1],[228,13,228,14,1],[229,13,229,55,1],[230,9,230,10,1],[235,9,235,10,1],[236,13,236,62,1],[238,13,238,53,1],[239,13,239,14,1],[240,17,240,39,1],[243,13,243,90,1],[244,13,244,84,1],[246,13,246,48,1],[247,13,247,14,1],[248,17,248,64,1],[249,17,249,94,1],[252,13,254,54,1],[256,13,256,41,1],[257,13,257,14,1],[258,17,258,110,1],[259,17,259,94,1],[262,13,270,15,1],[272,13,272,113,1],[274,13,274,54,1],[275,13,275,47,1],[277,13,277,88,1],[278,9,278,10,1],[283,9,283,10,1],[284,13,284,55,1],[285,13,285,37,1],[287,13,287,62,1],[288,13,288,37,1],[291,13,293,62,1],[295,13,295,67,1],[297,13,297,51,1],[298,13,298,14,1],[299,17,299,72,1],[300,17,300,94,1],[304,13,304,50,1],[304,50,304,71,0],[304,71,304,73,1],[305,13,305,14,1],[306,17,310,20,1],[311,17,311,51,1],[312,13,312,14,1],[314,13,314,79,1],[315,9,315,10,1],[320,9,320,10,1],[321,13,323,62,1],[325,13,325,33,1],[326,13,326,14,1],[327,17,327,35,1],[330,13,330,75,1],[330,75,330,96,1],[330,96,330,98,1],[332,13,332,38,1],[333,13,333,14,1],[334,17,334,60,1],[335,17,335,51,1],[336,13,336,14,1],[338,13,338,79,1],[339,9,339,10,1],[343,9,343,10,1],[344,13,344,77,1],[346,13,346,33,1],[347,13,347,14,1],[348,17,348,35,1],[351,13,352,101,1],[354,13,354,36,1],[355,13,355,14,1],[356,17,360,19,1],[362,17,362,58,1],[363,13,363,14,1],[365,13,365,37,1],[366,13,366,47,1],[368,13,368,81,1],[369,13,369,49,1],[370,9,370,10,1],[374,9,374,10,1],[375,13,375,77,1],[377,13,377,33,1],[378,13,378,14,1],[379,17,379,35,1],[382,13,382,38,1],[383,13,383,47,1],[385,13,385,77,1],[386,13,386,49,1],[387,9,387,10,1],[391,9,391,10,1],[392,13,392,105,1],[393,13,393,38,1],[394,13,394,14,1],[395,17,395,61,1],[396,17,396,51,1],[397,13,397,14,1],[399,13,399,49,1],[400,9,400,10,1]]);
    </script>
  </body>
</html>