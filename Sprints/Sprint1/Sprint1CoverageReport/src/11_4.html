<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\ahmad\Documents\GitHub\Capstone-Project\code\TaskManager.Tests\Tests\TestControllers\EmployeeControllerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.AspNetCore.Identity;
using Moq;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Text;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using TaskManagerWebsite.Controllers;
using TaskManagerWebsite.Data;
using TaskManagerWebsite.Models;

namespace TaskManager.Tests.Tests.TestControllers
{
    public class EmployeeControllerTests
    {
        private readonly Mock&lt;UserManager&lt;User&gt;&gt; _mockUserManager;
        private readonly Mock&lt;RoleManager&lt;IdentityRole&lt;int&gt;&gt;&gt; _mockRoleManager;
        private readonly ApplicationDbContext _dbContext;

        public EmployeeControllerTests()
        {
            _mockUserManager = GetMockUserManager();
            _mockRoleManager = GetMockRoleManager();
            _dbContext = TestHelper.GetDbContext();

            var mockRoles = new List&lt;IdentityRole&lt;int&gt;&gt;
            {
                new IdentityRole&lt;int&gt; { Id = 1, Name = &quot;Admin&quot; },
                new IdentityRole&lt;int&gt; { Id = 2, Name = &quot;Manager&quot; },
                new IdentityRole&lt;int&gt; { Id = 3, Name = &quot;Employee&quot; }
            }.AsQueryable();

            _mockRoleManager
                .Setup(rm =&gt; rm.Roles)
                .Returns(mockRoles);

            _mockUserManager
                .Setup(um =&gt; um.GetRolesAsync(It.IsAny&lt;User&gt;()))
                .ReturnsAsync(new List&lt;string&gt; { &quot;Admin&quot;, &quot;Manager&quot;, &quot;Employee&quot; });
        }

        private Mock&lt;UserManager&lt;User&gt;&gt; GetMockUserManager()
        {
            var userStoreMock = new Mock&lt;IUserStore&lt;User&gt;&gt;();
            return new Mock&lt;UserManager&lt;User&gt;&gt;(userStoreMock.Object, null, null, null, null, null, null, null, null);
        }

        private Mock&lt;RoleManager&lt;IdentityRole&lt;int&gt;&gt;&gt; GetMockRoleManager()
        {
            var roleStoreMock = new Mock&lt;IRoleStore&lt;IdentityRole&lt;int&gt;&gt;&gt;();
            return new Mock&lt;RoleManager&lt;IdentityRole&lt;int&gt;&gt;&gt;(roleStoreMock.Object, null, null, null, null);
        }

        [Fact]
        public async Task Users_ReturnsViewResult()
        {
            var controller = new EmployeeController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.Users();

            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
            var model = Assert.IsAssignableFrom&lt;IEnumerable&lt;User&gt;&gt;(viewResult.Model);
            Assert.Empty(model);
        }

        [Fact]
        public async Task Groups_ReturnsViewResult()
        {
            var controller = new EmployeeController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.Groups();

            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
            var model = Assert.IsAssignableFrom&lt;IEnumerable&lt;Group&gt;&gt;(viewResult.Model);
            Assert.Empty(model);
        }

        [Fact]
        public async Task Projects_ReturnsViewResult()
        {
            var controller = new EmployeeController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            _dbContext.Users.Add(user);
            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;()))
                .Returns(user.Id.ToString());

            var result = await controller.Projects();

            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
            var model = Assert.IsAssignableFrom&lt;IEnumerable&lt;Project&gt;&gt;(viewResult.Model);
            Assert.Empty(model);
        }

        [Fact]
        public async Task ProjectDetails_ReturnsViewResult_WithCorrectManagedAndUnmanagedGroups()
        {
            var controller = new EmployeeController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            var otherUser = new User
            {
                Id = 2,
                UserName = &quot;Test2User&quot;,
                Email = &quot;user2@gmail.com&quot;
            };

            var managedGroup = new Group
            {
                Id = 1,
                Name = &quot;TestGroup&quot;,
                Description = &quot;TestDescription&quot;,
                PrimaryManagerId = 1,
                PrimaryManager = user
            };

            var unmanagedGroup = new Group
            {
                Id = 2,
                Name = &quot;Test2Group&quot;,
                Description = &quot;Test2Description&quot;,
                PrimaryManagerId = 2,
                PrimaryManager = otherUser
            };

            var anotherUnmanagedGroup = new Group
            {
                Id = 3,
                Name = &quot;Test3Group&quot;,
                Description = &quot;Test3Description&quot;,
                PrimaryManagerId = 2,
                PrimaryManager = otherUser
            };

            var managedGroupManager = new GroupManager
            {
                GroupId = 1,
                Group = managedGroup,
                UserId = 1,
                User = user
            };

            var unmanagedGroupManager = new GroupManager
            {
                GroupId = 2,
                Group = unmanagedGroup,
                UserId = 2,
                User = otherUser
            };

            var project = new Project
            {
                Id = 1,
                Name = &quot;Test1Project&quot;,
                Description = &quot;Test1Description&quot;,
                ProjectLeadId = 1,
                ProjectLead = user
            };

            var groupProject1 = new GroupProject
            {
                GroupId = 1,
                Group = managedGroup,
                ProjectId = 1,
                Project = project
            };

            var groupProject2 = new GroupProject
            {
                GroupId = 2,
                Group = unmanagedGroup,
                ProjectId = 1,
                Project = project
            };

            _dbContext.Users.Add(user);
            _dbContext.Users.Add(otherUser);
            _dbContext.Groups.Add(managedGroup);
            _dbContext.Groups.Add(unmanagedGroup);
            _dbContext.Groups.Add(anotherUnmanagedGroup);
            _dbContext.Projects.Add(project);
            _dbContext.GroupManagers.Add(managedGroupManager);
            _dbContext.GroupManagers.Add(unmanagedGroupManager);
            _dbContext.GroupProjects.Add(groupProject1);
            _dbContext.GroupProjects.Add(groupProject2);
            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());

            var result = await controller.ProjectDetails(1);

            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);

            var managedGroups = Assert.IsAssignableFrom&lt;List&lt;Group&gt;&gt;(viewResult.ViewData[&quot;ManagedGroups&quot;]);
            var unmanagedGroups = Assert.IsAssignableFrom&lt;List&lt;Group&gt;&gt;(viewResult.ViewData[&quot;UnmanagedGroups&quot;]);

            Assert.NotNull(managedGroups);
            Assert.NotNull(unmanagedGroups);

            Assert.DoesNotContain(managedGroups, g =&gt; g.Id == 1);

            Assert.DoesNotContain(unmanagedGroups, g =&gt; g.Id == 2);

            Assert.Contains(unmanagedGroups, g =&gt; g.Id == 3);

            Assert.Empty(managedGroups);

            Assert.Single(unmanagedGroups);
        }

        [Fact]
        public async Task ProjectDetails_ReturnsNotFound_WithNullProject()
        {
            var controller = new EmployeeController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.ProjectDetails(999);

            Assert.IsType&lt;NotFoundResult&gt;(result);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,41,1],[23,9,23,10,1],[24,13,24,53,1],[25,13,25,53,1],[26,13,26,52,1],[28,13,33,29,1],[35,13,37,37,1],[39,13,41,84,1],[42,9,42,10,1],[45,9,45,10,1],[46,13,46,62,1],[47,13,47,118,1],[48,9,48,10,1],[51,9,51,10,1],[52,13,52,75,1],[53,13,53,107,1],[54,9,54,10,1],[58,9,58,10,1],[59,13,59,115,1],[61,13,61,51,1],[63,13,63,64,1],[64,13,64,86,1],[65,13,65,33,1],[66,9,66,10,1],[70,9,70,10,1],[71,13,71,115,1],[73,13,73,52,1],[75,13,75,64,1],[76,13,76,87,1],[77,13,77,33,1],[78,9,78,10,1],[82,9,82,10,1],[83,13,83,115,1],[85,13,90,15,1],[92,13,92,40,1],[93,13,93,49,1],[95,13,96,46,1],[98,13,98,54,1],[100,13,100,64,1],[101,13,101,89,1],[102,13,102,33,1],[103,9,103,10,1],[107,9,107,10,1],[108,13,108,115,1],[110,13,115,15,1],[117,13,122,15,1],[124,13,131,15,1],[133,13,140,15,1],[142,13,149,15,1],[151,13,157,15,1],[159,13,165,15,1],[167,13,174,15,1],[176,13,182,15,1],[184,13,190,15,1],[192,13,192,40,1],[193,13,193,45,1],[194,13,194,49,1],[195,13,195,51,1],[196,13,196,58,1],[197,13,197,46,1],[198,13,198,63,1],[199,13,199,65,1],[200,13,200,57,1],[201,13,201,57,1],[202,13,202,49,1],[204,13,204,113,1],[206,13,206,61,1],[208,13,208,64,1],[210,13,210,108,1],[211,13,211,112,1],[213,13,213,43,1],[214,13,214,45,1],[216,13,216,55,1],[216,55,216,64,0],[216,64,216,66,1],[218,13,218,57,1],[218,57,218,66,1],[218,66,218,68,1],[220,13,220,51,1],[220,51,220,60,1],[220,60,220,62,1],[222,13,222,41,1],[224,13,224,44,1],[225,9,225,10,1],[229,9,229,10,1],[230,13,230,115,1],[232,13,232,63,1],[234,13,234,51,1],[235,9,235,10,1]]);
    </script>
  </body>
</html>