<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\ahmad\Documents\GitHub\Capstone-Project\code\TaskManager.Tests\Tests\TestControllers\ManagerControllerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.AspNetCore.Identity;
using Moq;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Text;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using TaskManagerWebsite.Controllers;
using TaskManagerWebsite.Data;
using TaskManagerWebsite.Models;
using Microsoft.AspNetCore.SignalR;
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc.ViewFeatures;

namespace TaskManager.Tests.Tests.TestControllers
{
    public class ManagerControllerTests
    {
        private readonly Mock&lt;UserManager&lt;User&gt;&gt; _mockUserManager;
        private readonly Mock&lt;RoleManager&lt;IdentityRole&lt;int&gt;&gt;&gt; _mockRoleManager;
        private readonly ApplicationDbContext _dbContext;

        public ManagerControllerTests()
        {
            _mockUserManager = GetMockUserManager();
            _mockRoleManager = GetMockRoleManager();
            _dbContext = TestHelper.GetDbContext();

            var mockRoles = new List&lt;IdentityRole&lt;int&gt;&gt;
            {
                new IdentityRole&lt;int&gt; { Id = 1, Name = &quot;Admin&quot; },
                new IdentityRole&lt;int&gt; { Id = 2, Name = &quot;Manager&quot; },
                new IdentityRole&lt;int&gt; { Id = 3, Name = &quot;Employee&quot; }
            }.AsQueryable();

            _mockRoleManager
                .Setup(rm =&gt; rm.Roles)
                .Returns(mockRoles);

            _mockUserManager
                .Setup(um =&gt; um.GetRolesAsync(It.IsAny&lt;User&gt;()))
                .ReturnsAsync(new List&lt;string&gt; { &quot;Admin&quot;, &quot;Manager&quot;, &quot;Employee&quot; });
        }

        private Mock&lt;UserManager&lt;User&gt;&gt; GetMockUserManager()
        {
            var userStoreMock = new Mock&lt;IUserStore&lt;User&gt;&gt;();
            return new Mock&lt;UserManager&lt;User&gt;&gt;(userStoreMock.Object, null, null, null, null, null, null, null, null);
        }

        private Mock&lt;RoleManager&lt;IdentityRole&lt;int&gt;&gt;&gt; GetMockRoleManager()
        {
            var roleStoreMock = new Mock&lt;IRoleStore&lt;IdentityRole&lt;int&gt;&gt;&gt;();
            return new Mock&lt;RoleManager&lt;IdentityRole&lt;int&gt;&gt;&gt;(roleStoreMock.Object, null, null, null, null);
        }

        [Fact]
        public async Task Users_ReturnsViewResult()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.Users();

            Assert.IsType&lt;ViewResult&gt;(result);
        }

        [Fact]
        public async Task Groups_ReturnsViewResult()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.Groups();

            Assert.IsType&lt;ViewResult&gt;(result);
        }

        [Fact]
        public async Task Projects_ReturnsViewResult()
        {
            var user = setupGroupRequestsScenario(out var requestingUser, out var group1, out var group2, out var groupManager1, out var groupManager2, out var requestingProject1, out var requestingProject2, out var groupRequest1, out var groupRequest2);

            _dbContext.Users.Add(user);
            _dbContext.Users.Add(requestingUser);
            _dbContext.Groups.Add(group1);
            _dbContext.Groups.Add(group2);
            _dbContext.GroupManagers.Add(groupManager1);
            _dbContext.GroupManagers.Add(groupManager2);
            _dbContext.Projects.Add(requestingProject1);
            _dbContext.Projects.Add(requestingProject2);
            _dbContext.GroupRequests.Add(groupRequest1);
            _dbContext.GroupRequests.Add(groupRequest2);

            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());

            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.Projects();

            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
            var model = Assert.IsAssignableFrom&lt;List&lt;GroupRequest&gt;&gt;(viewResult.ViewData[&quot;GroupRequests&quot;]);
            var model2 = Assert.IsAssignableFrom&lt;List&lt;GroupRequest&gt;&gt;(viewResult.ViewData[&quot;SentGroupRequests&quot;]);
            Assert.NotNull(model);
            Assert.NotNull(model2);
            Assert.Single(model);
            Assert.Single(model2);
        }

        [Fact]
        public async Task CreateProject_ReturnsViewResult()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.CreateProject();

            Assert.IsType&lt;ViewResult&gt;(result);
        }

        [Fact]
        public async Task CreateProjectWithArg_ReturnsViewResult_WithInvalidModelState()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            controller.ModelState.AddModelError(&quot;Name&quot;, &quot;Required&quot;);

            var result = await controller.CreateProject(new Project());

            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
            Assert.IsType&lt;Project&gt;(viewResult.Model);
        }

        [Fact]
        public async Task CreateProjectWithArg_ReturnsViewResult_WithEmptyUserId()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(&quot;&quot;);

            var result = await controller.CreateProject(new Project());

            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
            Assert.IsType&lt;Project&gt;(viewResult.Model);
            Assert.Single(controller.ModelState[&quot;&quot;]!.Errors);
        }

        [Fact]
        public async Task CreateProjectWithArg_ReturnsRedirectToActionResult()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            _dbContext.Users.Add(user);

            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());

            var result = await controller.CreateProject(new Project
            {
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;,
                ProjectLeadId = 1
            });

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.Equal(1, _dbContext.Projects.First().ProjectCreatorId);
        }

        [Fact]
        public async Task ProjectDetails_ReturnsNotFound_WithNullProject()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.ProjectDetails(999);

            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task ProjectDetails_ReturnsViewResult()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            var otherUser = new User
            {
                Id = 2,
                UserName = &quot;Test2User&quot;,
                Email = &quot;user2@gmail.com&quot;
            };

            var managedGroup = new Group
            {
                Id = 1,
                Name = &quot;TestGroup&quot;,
                Description = &quot;TestDescription&quot;,
                PrimaryManagerId = 1,
                PrimaryManager = user
            };

            var unmanagedGroup = new Group
            {
                Id = 2,
                Name = &quot;Test2Group&quot;,
                Description = &quot;Test2Description&quot;,
                PrimaryManagerId = 2,
                PrimaryManager = otherUser
            };

            var anotherUnmanagedGroup = new Group
            {
                Id = 3,
                Name = &quot;Test3Group&quot;,
                Description = &quot;Test3Description&quot;,
                PrimaryManagerId = 2,
                PrimaryManager = otherUser
            };

            var managedGroupManager = new GroupManager
            {
                GroupId = 1,
                Group = managedGroup,
                UserId = 1,
                User = user
            };

            var unmanagedGroupManager = new GroupManager
            {
                GroupId = 2,
                Group = unmanagedGroup,
                UserId = 2,
                User = otherUser
            };

            var project = new Project
            {
                Id = 1,
                Name = &quot;Test1Project&quot;,
                Description = &quot;Test1Description&quot;,
                ProjectLeadId = 1,
                ProjectLead = user
            };

            var groupProject1 = new GroupProject
            {
                GroupId = 1,
                Group = managedGroup,
                ProjectId = 1,
                Project = project
            };

            var groupProject2 = new GroupProject
            {
                GroupId = 2,
                Group = unmanagedGroup,
                ProjectId = 1,
                Project = project
            };

            _dbContext.Users.Add(user);
            _dbContext.Users.Add(otherUser);
            _dbContext.Groups.Add(managedGroup);
            _dbContext.Groups.Add(unmanagedGroup);
            _dbContext.Groups.Add(anotherUnmanagedGroup);
            _dbContext.Projects.Add(project);
            _dbContext.GroupManagers.Add(managedGroupManager);
            _dbContext.GroupManagers.Add(unmanagedGroupManager);
            _dbContext.GroupProjects.Add(groupProject1);
            _dbContext.GroupProjects.Add(groupProject2);
            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());


            var result = await controller.ProjectDetails(1);


            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);


            var managedGroups = Assert.IsAssignableFrom&lt;List&lt;Group&gt;&gt;(viewResult.ViewData[&quot;ManagedGroups&quot;]);
            var unmanagedGroups = Assert.IsAssignableFrom&lt;List&lt;Group&gt;&gt;(viewResult.ViewData[&quot;UnmanagedGroups&quot;]);

            Assert.NotNull(managedGroups);
            Assert.NotNull(unmanagedGroups);

            Assert.DoesNotContain(managedGroups, g =&gt; g.Id == 1);


            Assert.DoesNotContain(unmanagedGroups, g =&gt; g.Id == 2);


            Assert.Contains(unmanagedGroups, g =&gt; g.Id == 3);


            Assert.Empty(managedGroups);

            Assert.Single(unmanagedGroups);
        }


        [Fact]
        public async Task EditProject_ReturnsNotFound_WithNullProject()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.EditProject(999);

            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task EditProject_ReturnsViewResult()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var project = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;,
                ProjectLeadId = 1
            };

            _dbContext.Projects.Add(project);
            await _dbContext.SaveChangesAsync();

            var result = await controller.EditProject(1);

            Assert.IsType&lt;ViewResult&gt;(result);
        }

        [Fact]
        public async Task EditProjectWithArg_ReturnsBadRequest()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.EditProject(1, new Project { Id = 2, Description = &quot;N/A&quot; });

            Assert.IsType&lt;BadRequestResult&gt;(result);
        }

        [Fact]
        public async Task EditProjectWithArg_ReturnsViewResult_WithInvalidModelState()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            controller.ModelState.AddModelError(&quot;Name&quot;, &quot;Required&quot;);

            var result = await controller.EditProject(1, new Project { Id = 1, Description = &quot;N/A&quot; });

            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
            Assert.IsType&lt;Project&gt;(viewResult.Model);
            Assert.False(controller.ModelState.IsValid);
        }

        [Fact]
        public async Task EditProjectWithArg_ReturnsViewResult_WithEmptyUserId()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(&quot;&quot;);

            var result = await controller.EditProject(1, new Project { Id = 1, Description = &quot;N/A&quot; });

            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
            Assert.IsType&lt;Project&gt;(viewResult.Model);
            Assert.Single(controller.ModelState[&quot;&quot;]!.Errors);
        }

        [Fact]
        public async Task EditProjectWithArg_ReturnsRedirectToActionResult()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
            var project = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;,
                ProjectLeadId = 1
            };

            _dbContext.Projects.Add(project);
            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(project.ProjectLeadId.ToString());
            _dbContext.Entry(project).State = EntityState.Detached;

            var result = await controller.EditProject(1, new Project
            {
                Id = 1,
                Name = &quot;Test2Project&quot;,
                Description = &quot;Test2Description&quot;,
                ProjectLeadId = 1
            });

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.Equal(&quot;Test2Project&quot;, _dbContext.Projects.First().Name);
        }

        [Fact]
        public async Task DeleteProject_ReturnsRedirectToAction()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var project = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;
            };

            _dbContext.Projects.Add(project);
            await _dbContext.SaveChangesAsync();

            var result = await controller.DeleteProject(1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
        }

        [Fact]
        public async Task RequestGroupToProject_ReturnsUnauthorized_WithEmptyUserId()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(&quot;&quot;);

            var result = await controller.RequestGroupToProject(1, 1);

            Assert.IsType&lt;UnauthorizedResult&gt;(result);
        }

        [Fact]
        public async Task RequestGroupToProject_ReturnsRedirectToActionResult_WithNoFoundProject()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
            controller.TempData = new TempDataDictionary(new DefaultHttpContext(), Mock.Of&lt;ITempDataProvider&gt;());

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            _dbContext.Users.Add(user);
            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());

            var result = await controller.RequestGroupToProject(1, 1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.True(controller.TempData.ContainsKey(&quot;ErrorMessage&quot;));
            Assert.Equal(&quot;No group selected&quot;, controller.TempData[&quot;ErrorMessage&quot;]);
        }

        [Fact]
        public async Task RequestGroupToProject_ReturnsRedirectToActionResult_WithNoFoundGroup()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
            controller.TempData = new TempDataDictionary(new DefaultHttpContext(), Mock.Of&lt;ITempDataProvider&gt;());

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };
            var project = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;,
                ProjectLeadId = 1,
                ProjectLead = user
            };

            _dbContext.Users.Add(user);
            _dbContext.Projects.Add(project);
            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());

            var result = await controller.RequestGroupToProject(1, 1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.True(controller.TempData.ContainsKey(&quot;ErrorMessage&quot;));
            Assert.Equal(&quot;No group selected&quot;, controller.TempData[&quot;ErrorMessage&quot;]);
        }

        [Fact]
        public async Task RequestGroupToProject_ReturnsRedirectToActionResult_WithExistingRequest()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
            controller.TempData = new TempDataDictionary(new DefaultHttpContext(), Mock.Of&lt;ITempDataProvider&gt;());

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            var group = new Group
            {
                Id = 1,
                Name = &quot;TestGroup&quot;,
                Description = &quot;TestDescription&quot;,
                PrimaryManagerId = 1,
                PrimaryManager = user
            };

            var project = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;,
                ProjectLeadId = 1,
                ProjectLead = user
            };

            var groupRequest = new GroupRequest
            {
                Id = 1,
                GroupId = 1,
                Group = group,
                SenderId = 1,
                ProjectId = 1,
                Project = project,
                Response = null
            };

            _dbContext.Users.Add(user);
            _dbContext.Projects.Add(project);
            _dbContext.Groups.Add(group);
            _dbContext.GroupRequests.Add(groupRequest);
            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());

            var result = await controller.RequestGroupToProject(1, 1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.True(controller.TempData.ContainsKey(&quot;ErrorMessage&quot;));
            Assert.Equal(&quot;You have already requested to assign this group to the project.&quot;, controller.TempData[&quot;ErrorMessage&quot;]);
        }

        [Fact]
        public async Task RequestGroupToProject_ReturnsRedirectToActionResult()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
            controller.TempData = new TempDataDictionary(new DefaultHttpContext(), Mock.Of&lt;ITempDataProvider&gt;());

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            var group = new Group
            {
                Id = 1,
                Name = &quot;TestGroup&quot;,
                Description = &quot;TestDescription&quot;,
            };

            var project = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;,
                ProjectLeadId = 1,
                ProjectLead = user
            };

            _dbContext.Users.Add(user);
            _dbContext.Projects.Add(project);
            _dbContext.Groups.Add(group);
            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());

            var result = await controller.RequestGroupToProject(1, 1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.Equal(1, _dbContext.GroupRequests.First().GroupId);
            Assert.Equal(1, _dbContext.GroupRequests.First().ProjectId);
            Assert.True(controller.TempData.ContainsKey(&quot;SuccessMessage&quot;));
            Assert.Equal(&quot;You have successfully requested to assign this group to the project.&quot;, controller.TempData[&quot;SuccessMessage&quot;]);
        }

        [Fact]
        public async Task AssignGroupToProject_ReturnsRedirectToActionResult_WithNoFoundProject()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
            controller.TempData = new TempDataDictionary(new DefaultHttpContext(), Mock.Of&lt;ITempDataProvider&gt;());

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            _dbContext.Users.Add(user);
            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());

            var result = await controller.AssignGroupToProject(1, 1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.True(controller.TempData.ContainsKey(&quot;AssignedErrorMessage&quot;));
            Assert.Equal(&quot;No group selected&quot;, controller.TempData[&quot;AssignedErrorMessage&quot;]);
        }

        [Fact]
        public async Task AssignGroupToProject_ReturnsRedirectToActionResult_WithNoFoundGroup()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
            controller.TempData = new TempDataDictionary(new DefaultHttpContext(), Mock.Of&lt;ITempDataProvider&gt;());

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            var project = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;,
                ProjectLeadId = 1,
                ProjectLead = user
            };

            _dbContext.Users.Add(user);
            _dbContext.Projects.Add(project);
            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());

            var result = await controller.AssignGroupToProject(1, 1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.True(controller.TempData.ContainsKey(&quot;AssignedErrorMessage&quot;));
            Assert.Equal(&quot;No group selected&quot;, controller.TempData[&quot;AssignedErrorMessage&quot;]);
        }

        [Fact]
        public async Task AssignGroupToProject_ReturnsRedirectToActionResult()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
            controller.TempData = new TempDataDictionary(new DefaultHttpContext(), Mock.Of&lt;ITempDataProvider&gt;());

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            var group = new Group
            {
                Id = 1,
                Name = &quot;TestGroup&quot;,
                Description = &quot;TestDescription&quot;,
            };

            var project = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;,
                ProjectLeadId = 1,
                ProjectLead = user
            };

            _dbContext.Users.Add(user);
            _dbContext.Projects.Add(project);
            _dbContext.Groups.Add(group);
            await _dbContext.SaveChangesAsync();

            _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());

            var result = await controller.AssignGroupToProject(1, 1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.Equal(1, _dbContext.GroupProjects.First().GroupId);
            Assert.Equal(1, _dbContext.GroupProjects.First().ProjectId);
        }

        [Fact]
        public async Task RemoveGroupFromProject_ReturnsNotFound_WithNoFoundProject()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.RemoveGroupFromProject(1, 1);

            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task RemoveGroupFromProject_ReturnsRedirectToAction()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var group = new Group
            {
                Id = 1,
                Name = &quot;TestGroup&quot;,
                Description = &quot;TestDescription&quot;
            };

            var project = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;
            };

            var groupProject = new GroupProject
            {
                GroupId = 1,
                ProjectId = 1
            };

            _dbContext.Groups.Add(group);
            _dbContext.Projects.Add(project);
            _dbContext.GroupProjects.Add(groupProject);
            await _dbContext.SaveChangesAsync();

            var result = await controller.RemoveGroupFromProject(1, 1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.Equal(0, _dbContext.GroupProjects.Count());
        }

        [Fact]
        public async Task AcceptGroupRequest_ReturnsNotFound_WithNoFoundRequest()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.AcceptRequest(1);

            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task AcceptGroupRequest_ReturnsRedirectToAction()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
            controller.TempData = new TempDataDictionary(new DefaultHttpContext(), Mock.Of&lt;ITempDataProvider&gt;());

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            var group = new Group
            {
                Id = 1,
                Name = &quot;TestGroup&quot;,
                Description = &quot;TestDescription&quot;,
                PrimaryManagerId = 1,
                PrimaryManager = user
            };

            var project = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;,
                ProjectLeadId = 1,
                ProjectLead = user
            };

            var groupRequest = new GroupRequest
            {
                Id = 1,
                GroupId = 1,
                ProjectId = 1,
                Response = null
            };

            _dbContext.Users.Add(user);
            _dbContext.Groups.Add(group);
            _dbContext.Projects.Add(project);
            _dbContext.GroupRequests.Add(groupRequest);
            await _dbContext.SaveChangesAsync();

            var result = await controller.AcceptRequest(1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.True(_dbContext.GroupRequests.First().Response);
            Assert.True(controller.TempData.ContainsKey(&quot;SuccessMessage&quot;));
            Assert.Equal(&quot;The group request has been accepted.&quot;, controller.TempData[&quot;SuccessMessage&quot;]);
        }

        [Fact]
        public async Task DenyRequest_ReturnsNotFound_WithNoFoundRequest()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var result = await controller.DenyRequest(1);

            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task DenyRequest_ReturnsRedirectToAction()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
            controller.TempData = new TempDataDictionary(new DefaultHttpContext(), Mock.Of&lt;ITempDataProvider&gt;());

            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;
            };

            var group = new Group
            {
                Id = 1,
                Name = &quot;TestGroup&quot;,
                Description = &quot;TestDescription&quot;,
                PrimaryManagerId = 1,
                PrimaryManager = user
            };

            var project = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;,
                ProjectLeadId = 1,
                ProjectLead = user
            };

            var groupRequest = new GroupRequest
            {
                Id = 1,
                GroupId = 1,
                ProjectId = 1,
                Response = null
            };

            _dbContext.Users.Add(user);
            _dbContext.Groups.Add(group);
            _dbContext.Projects.Add(project);
            _dbContext.GroupRequests.Add(groupRequest);
            await _dbContext.SaveChangesAsync();

            var result = await controller.DenyRequest(1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.False(_dbContext.GroupRequests.First().Response);
            Assert.True(controller.TempData.ContainsKey(&quot;ErrorMessage&quot;));
            Assert.Equal(&quot;The group request has been denied.&quot;, controller.TempData[&quot;ErrorMessage&quot;]);
        }

        [Fact]
        public async Task DeleteGroupRequest_ReturnsRedirectToAction()
        {
            var controller = new ManagerController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

            var groupRequest = new GroupRequest
            {
                Id = 1,
                GroupId = 1,
                ProjectId = 1,
                Response = null
            };

            _dbContext.GroupRequests.Add(groupRequest);
            await _dbContext.SaveChangesAsync();

            var result = await controller.DeleteGroupRequest(1);

            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.Empty(_dbContext.GroupRequests);
        }

        private static User setupGroupRequestsScenario(out User requestingUser, out Group group1, out Group group2,
            out GroupManager groupManager1, out GroupManager groupManager2, out Project requestingProject1,
            out Project requestingProject2, out GroupRequest groupRequest1, out GroupRequest groupRequest2)
        {
            var user = new User
            {
                Id = 1,
                UserName = &quot;TestUser&quot;,
                Email = &quot;user@gmail.com&quot;,
            };

            requestingUser = new User
            {
                Id = 2,
                UserName = &quot;RequestingUser&quot;,
                Email = &quot;user2@gmail.com&quot;
            };

            group1 = new Group
            {
                Id = 1,
                Name = &quot;TestGroup&quot;,
                Description = &quot;TestDescription&quot;,
                PrimaryManagerId = 1,
                PrimaryManager = user
            };

            group2 = new Group
            {
                Id = 2,
                Name = &quot;Test2Group&quot;,
                Description = &quot;Test2Description&quot;,
                PrimaryManagerId = 2,
                PrimaryManager = requestingUser
            };

            groupManager1 = new GroupManager
            {
                GroupId = 1,
                Group = group1,
                UserId = 1,
                User = user
            };

            groupManager2 = new GroupManager
            {
                GroupId = 2,
                Group = group2,
                UserId = 2,
                User = requestingUser
            };

            requestingProject1 = new Project
            {
                Id = 1,
                Name = &quot;TestProject&quot;,
                Description = &quot;TestDescription&quot;,
                ProjectLeadId = 2,
                ProjectLead = requestingUser
            };

            requestingProject2 = new Project
            {
                Id = 2,
                Name = &quot;Test2Project&quot;,
                Description = &quot;Test2Description&quot;,
                ProjectLeadId = 1,
                ProjectLead = user
            };

            groupRequest1 = new GroupRequest
            {
                Id = 1,
                GroupId = 1,
                Group = group1,
                SenderId = 2,
                ProjectId = 1,
                Project = requestingProject1,
                Response = null
            };

            groupRequest2 = new GroupRequest
            {
                Id = 2,
                GroupId = 2,
                Group = group2,
                SenderId = 1,
                ProjectId = 2,
                Project = requestingProject2,
                Response = false
            };
            return user;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,40,1],[27,9,27,10,1],[28,13,28,53,1],[29,13,29,53,1],[30,13,30,52,1],[32,13,37,29,1],[39,13,41,37,1],[43,13,45,84,1],[46,9,46,10,1],[49,9,49,10,1],[50,13,50,62,1],[51,13,51,118,1],[52,9,52,10,1],[55,9,55,10,1],[56,13,56,75,1],[57,13,57,107,1],[58,9,58,10,1],[62,9,62,10,1],[63,13,63,114,1],[65,13,65,51,1],[67,13,67,47,1],[68,9,68,10,1],[72,9,72,10,1],[73,13,73,114,1],[75,13,75,52,1],[77,13,77,47,1],[78,9,78,10,1],[82,9,82,10,1],[83,13,83,255,1],[85,13,85,40,1],[86,13,86,50,1],[87,13,87,43,1],[88,13,88,43,1],[89,13,89,57,1],[90,13,90,57,1],[91,13,91,57,1],[92,13,92,57,1],[93,13,93,57,1],[94,13,94,57,1],[96,13,96,49,1],[98,13,98,113,1],[100,13,100,114,1],[102,13,102,54,1],[104,13,104,64,1],[105,13,105,107,1],[106,13,106,112,1],[107,13,107,35,1],[108,13,108,36,1],[109,13,109,34,1],[110,13,110,35,1],[111,9,111,10,1],[115,9,115,10,1],[116,13,116,114,1],[118,13,118,59,1],[120,13,120,47,1],[121,9,121,10,1],[125,9,125,10,1],[126,13,126,114,1],[128,13,128,69,1],[130,13,130,72,1],[132,13,132,64,1],[133,13,133,54,1],[134,9,134,10,1],[138,9,138,10,1],[139,13,139,114,1],[140,13,140,97,1],[142,13,142,72,1],[144,13,144,64,1],[145,13,145,54,1],[146,13,146,62,1],[147,9,147,10,1],[151,9,151,10,1],[152,13,152,114,1],[154,13,159,15,1],[161,13,161,40,1],[163,13,163,49,1],[165,13,165,113,1],[167,13,172,16,1],[174,13,174,59,1],[175,13,175,75,1],[176,9,176,10,1],[180,9,180,10,1],[181,13,181,114,1],[183,13,183,63,1],[185,13,185,51,1],[186,9,186,10,1],[190,9,190,10,1],[191,13,191,114,1],[193,13,198,15,1],[200,13,205,15,1],[207,13,214,15,1],[216,13,223,15,1],[225,13,232,15,1],[234,13,240,15,1],[242,13,248,15,1],[250,13,257,15,1],[259,13,265,15,1],[267,13,273,15,1],[275,13,275,40,1],[276,13,276,45,1],[277,13,277,49,1],[278,13,278,51,1],[279,13,279,58,1],[280,13,280,46,1],[281,13,281,63,1],[282,13,282,65,1],[283,13,283,57,1],[284,13,284,57,1],[285,13,285,49,1],[287,13,287,113,1],[290,13,290,61,1],[293,13,293,64,1],[296,13,296,108,1],[297,13,297,112,1],[299,13,299,43,1],[300,13,300,45,1],[302,13,302,55,1],[302,55,302,64,0],[302,64,302,66,1],[305,13,305,57,1],[305,57,305,66,1],[305,66,305,68,1],[308,13,308,51,1],[308,51,308,60,1],[308,60,308,62,1],[311,13,311,41,1],[313,13,313,44,1],[314,9,314,10,1],[319,9,319,10,1],[320,13,320,114,1],[322,13,322,60,1],[324,13,324,51,1],[325,9,325,10,1],[329,9,329,10,1],[330,13,330,114,1],[332,13,338,15,1],[340,13,340,46,1],[341,13,341,49,1],[343,13,343,58,1],[345,13,345,47,1],[346,9,346,10,1],[350,9,350,10,1],[351,13,351,114,1],[353,13,353,103,1],[355,13,355,53,1],[356,9,356,10,1],[360,9,360,10,1],[361,13,361,114,1],[363,13,363,69,1],[365,13,365,103,1],[367,13,367,64,1],[368,13,368,54,1],[369,13,369,57,1],[370,9,370,10,1],[374,9,374,10,1],[375,13,375,114,1],[377,13,377,97,1],[379,13,379,103,1],[381,13,381,64,1],[382,13,382,54,1],[383,13,383,62,1],[384,9,384,10,1],[388,9,388,10,1],[389,13,389,114,1],[390,13,396,15,1],[398,13,398,46,1],[399,13,399,49,1],[401,13,401,127,1],[402,13,402,68,1],[404,13,410,16,1],[412,13,412,59,1],[413,13,413,76,1],[414,9,414,10,1],[418,9,418,10,1],[419,13,419,114,1],[421,13,426,15,1],[428,13,428,46,1],[429,13,429,49,1],[431,13,431,60,1],[433,13,433,59,1],[434,9,434,10,1],[438,9,438,10,1],[439,13,439,114,1],[441,13,441,97,1],[443,13,443,71,1],[445,13,445,55,1],[446,9,446,10,1],[450,9,450,10,1],[451,13,451,114,1],[452,13,452,114,1],[454,13,459,15,1],[461,13,461,40,1],[462,13,462,49,1],[464,13,464,113,1],[466,13,466,71,1],[468,13,468,59,1],[469,13,469,74,1],[470,13,470,84,1],[471,9,471,10,1],[475,9,475,10,1],[476,13,476,114,1],[477,13,477,114,1],[479,13,484,15,1],[485,13,492,15,1],[494,13,494,40,1],[495,13,495,46,1],[496,13,496,49,1],[498,13,498,113,1],[500,13,500,71,1],[502,13,502,59,1],[503,13,503,74,1],[504,13,504,84,1],[505,9,505,10,1],[509,9,509,10,1],[510,13,510,114,1],[511,13,511,114,1],[513,13,518,15,1],[520,13,527,15,1],[529,13,536,15,1],[538,13,547,15,1],[549,13,549,40,1],[550,13,550,46,1],[551,13,551,42,1],[552,13,552,56,1],[553,13,553,49,1],[555,13,555,113,1],[557,13,557,71,1],[559,13,559,59,1],[560,13,560,74,1],[561,13,561,130,1],[562,9,562,10,1],[566,9,566,10,1],[567,13,567,114,1],[568,13,568,114,1],[570,13,575,15,1],[577,13,582,15,1],[584,13,591,15,1],[593,13,593,40,1],[594,13,594,46,1],[595,13,595,42,1],[596,13,596,49,1],[598,13,598,113,1],[600,13,600,71,1],[602,13,602,59,1],[603,13,603,71,1],[604,13,604,73,1],[605,13,605,76,1],[606,13,606,137,1],[607,9,607,10,1],[611,9,611,10,1],[612,13,612,114,1],[613,13,613,114,1],[615,13,620,15,1],[622,13,622,40,1],[623,13,623,49,1],[625,13,625,113,1],[627,13,627,70,1],[629,13,629,59,1],[630,13,630,82,1],[631,13,631,92,1],[632,9,632,10,1],[636,9,636,10,1],[637,13,637,114,1],[638,13,638,114,1],[640,13,645,15,1],[647,13,654,15,1],[656,13,656,40,1],[657,13,657,46,1],[658,13,658,49,1],[660,13,660,113,1],[662,13,662,70,1],[664,13,664,59,1],[665,13,665,82,1],[666,13,666,92,1],[667,9,667,10,1],[671,9,671,10,1],[672,13,672,114,1],[673,13,673,114,1],[675,13,680,15,1],[682,13,687,15,1],[689,13,696,15,1],[698,13,698,40,1],[699,13,699,46,1],[700,13,700,42,1],[701,13,701,49,1],[703,13,703,113,1],[705,13,705,70,1],[707,13,707,59,1],[708,13,708,71,1],[709,13,709,73,1],[710,9,710,10,1],[714,9,714,10,1],[715,13,715,114,1],[717,13,717,72,1],[719,13,719,51,1],[720,9,720,10,1],[724,9,724,10,1],[725,13,725,114,1],[727,13,732,15,1],[734,13,739,15,1],[741,13,745,15,1],[747,13,747,42,1],[748,13,748,46,1],[749,13,749,56,1],[750,13,750,49,1],[752,13,752,72,1],[754,13,754,59,1],[755,13,755,63,1],[756,9,756,10,1],[760,9,760,10,1],[761,13,761,114,1],[763,13,763,60,1],[765,13,765,51,1],[766,9,766,10,1],[770,9,770,10,1],[771,13,771,114,1],[772,13,772,114,1],[774,13,779,15,1],[781,13,788,15,1],[790,13,797,15,1],[799,13,805,15,1],[807,13,807,40,1],[808,13,808,42,1],[809,13,809,46,1],[810,13,810,56,1],[811,13,811,49,1],[813,13,813,60,1],[815,13,815,59,1],[816,13,816,68,1],[817,13,817,76,1],[818,13,818,105,1],[819,9,819,10,1],[823,9,823,10,1],[824,13,824,114,1],[826,13,826,58,1],[828,13,828,51,1],[829,9,829,10,1],[833,9,833,10,1],[834,13,834,114,1],[835,13,835,114,1],[837,13,842,15,1],[844,13,851,15,1],[853,13,860,15,1],[862,13,868,15,1],[870,13,870,40,1],[871,13,871,42,1],[872,13,872,46,1],[873,13,873,56,1],[874,13,874,49,1],[876,13,876,58,1],[878,13,878,59,1],[879,13,879,69,1],[880,13,880,74,1],[881,13,881,101,1],[882,9,882,10,1],[886,9,886,10,1],[887,13,887,114,1],[889,13,895,15,1],[897,13,897,56,1],[898,13,898,49,1],[900,13,900,65,1],[902,13,902,59,1],[903,13,903,52,1],[904,9,904,10,1],[909,9,909,10,1],[910,13,915,15,1],[917,13,922,15,1],[924,13,931,15,1],[933,13,940,15,1],[942,13,948,15,1],[950,13,956,15,1],[958,13,965,15,1],[967,13,974,15,1],[976,13,985,15,1],[987,13,996,15,1],[997,13,997,25,1],[998,9,998,10,1]]);
    </script>
  </body>
</html>