<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Nick\Desktop\Capstone-Project\code\TaskManager\Controllers\ProjectController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.ModelBinding;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using TaskManagerWebsite.Data;
using TaskManagerWebsite.Models;
using TaskManagerWebsite.ViewModels;
using TaskManagerWebsite.ViewModels.ProjectViewModels;
using Task = System.Threading.Tasks.Task;

namespace TaskManagerWebsite.Controllers
{
    /// &lt;summary&gt;
    /// The project controller for handling project board actions.
    /// &lt;/summary&gt;
    /// &lt;seealso cref=&quot;Microsoft.AspNetCore.Mvc.Controller&quot; /&gt;
    public class ProjectController : Controller
    {
        /// &lt;summary&gt;
        /// The context
        /// &lt;/summary&gt;
        private readonly ApplicationDbContext context;
        /// &lt;summary&gt;
        /// The user manager
        /// &lt;/summary&gt;
        private readonly UserManager&lt;User&gt; userManager;

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;ProjectController&quot; /&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;context&quot;&gt;The context.&lt;/param&gt;
        /// &lt;param name=&quot;userManager&quot;&gt;The user manager.&lt;/param&gt;
        public ProjectController(ApplicationDbContext context, UserManager&lt;User&gt; userManager)
        {
            this.context = context;
            this.userManager = userManager;
        }

        /// &lt;summary&gt;
        /// Deletes the task.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;taskStageId&quot;&gt;The task stage identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public async Task&lt;IActionResult&gt; DeleteTask(int taskStageId)
        {
            var taskStage = await context.TaskStages
                .Include(ts =&gt; ts.Task)
                .FirstOrDefaultAsync(ts =&gt; ts.Id == taskStageId);

            var stage = await context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.Id == taskStage.StageId);

            if (stage == null)
                return NotFound();

            var project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group).ThenInclude(group =&gt; group.UserGroups)
                .ThenInclude(userGroup =&gt; userGroup.User)
                .Include(p =&gt; p.ProjectBoard)
                .ThenInclude(b =&gt; b.Stages)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            if (project == null)
                return NotFound();

            context.TaskEmployees.RemoveRange(context.TaskEmployees.Where(te =&gt; te.TaskId == taskStage.TaskId));
            context.TaskStages.RemoveRange(context.TaskStages.Where(ts =&gt; ts.TaskId == taskStage.TaskId));
            context.Tasks.Remove(context.Tasks.FirstOrDefault(t =&gt; t.Id == taskStage.TaskId));

            await context.SaveChangesAsync();

            return RedirectToAction(nameof(ProjectBoard), new { id = project.Id });
        }

        /// &lt;summary&gt;
        /// Gets the create task view.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stageId&quot;&gt;The stage identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpGet]
        public async Task&lt;IActionResult&gt; CreateTask(int stageId)
        {
            var stage = await context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.Id == stageId);

            if (stage == null)
                return NotFound();

            var project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group).ThenInclude(group =&gt; group.UserGroups)
                .ThenInclude(userGroup =&gt; userGroup.User)
                .Include(p =&gt; p.ProjectBoard)
                .ThenInclude(b =&gt; b.Stages)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            if (project == null)
                return NotFound();

            ViewBag.ProjectId = project.Id;

            var vm = new CreateTaskViewModel {StageId = stageId};

            var isAssignedGroup = stage.AssignedGroup != null;
            var currentUser = await userManager.FindByIdAsync(userManager.GetUserId(User));
            bool isAdmin = await userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            bool isProjectLead = (project.ProjectLeadId == int.Parse(userManager.GetUserId(User)));
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            bool isGroupManager = await context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId)
                      &amp;&amp; ug.UserId == int.Parse(userManager.GetUserId(User))
                      &amp;&amp; ug.Role == &quot;Manager&quot;);

            setAvailableEmployees(isAdmin, vm, isProjectLead, project, isGroupManager, currentUser, stage, isAssignedGroup);

            return View(&quot;CreateTask&quot;, vm);
        }

        /// &lt;summary&gt;
        /// Creates the task.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;vm&quot;&gt;The vm.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; CreateTask(CreateTaskViewModel vm)
        {
            if (!ModelState.IsValid)
                return View(vm);

            var stage = await context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.Id == vm.StageId);

            if (stage == null)
                return NotFound();

            var projectId = stage.ProjectBoard.ProjectId;

            bool duplicateExists = await context.TaskStages
                .Where(ts =&gt; ts.Stage.ProjectBoard.ProjectId == projectId)
                .Select(ts =&gt; ts.Task)
                .AnyAsync(t =&gt; t.Name == vm.Name);

            if (duplicateExists)
            {
                ModelState.AddModelError(&quot;Name&quot;, &quot;A task with this name already exists in this project.&quot;);
                return View(vm);
            }

            var task = new Models.Task
            {
                Name = vm.Name,
                Description = vm.Description,
                CreatorUserId = int.Parse(userManager.GetUserId(User)),
                CreatorUser = await userManager.FindByIdAsync(userManager.GetUserId(User)),
            };

            context.Tasks.Add(task);
            await context.SaveChangesAsync();

            var taskStage = new TaskStage
            {
                Task = task,
                TaskId = task.Id,
                Stage = stage,
                StageId = vm.StageId,
                EnteredDate = DateTime.Now,
                CompletedDate = null,
                UpdatedByUserId = int.Parse(userManager.GetUserId(User)),
                UpdatedByUser = await userManager.FindByIdAsync(userManager.GetUserId(User))
            };

            context.TaskStages.Add(taskStage);

            if (vm.SelectedEmployeeId != null)
            {
                var taskEmployee = new TaskEmployee
                {
                    EmployeeId = vm.SelectedEmployeeId.Value,
                    Employee = await userManager.FindByIdAsync(vm.SelectedEmployeeId.Value.ToString()),
                    Task = task,
                    TaskId = task.Id,
                    AssignedDate = DateTime.Now,
                    CompletedDate = null
                };

                context.TaskEmployees.Add(taskEmployee);
            }

            await context.SaveChangesAsync();

            stage.TaskStages.Add(taskStage); // Optional if you&#39;re tracking changes to stage

            var project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group).ThenInclude(group =&gt; group.UserGroups)
                .ThenInclude(userGroup =&gt; userGroup.User)
                .Include(p =&gt; p.ProjectBoard)
                .ThenInclude(b =&gt; b.Stages)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            return RedirectToAction(nameof(ProjectBoard), new { id = project.Id });
        }
        /// &lt;summary&gt;
        /// Moves the task.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;taskId&quot;&gt;The task identifier.&lt;/param&gt;
        /// &lt;param name=&quot;currentStageId&quot;&gt;The current stage identifier.&lt;/param&gt;
        /// &lt;param name=&quot;newStageId&quot;&gt;The new stage identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; MoveTask(int taskId, int currentStageId, int newStageId)
        {
            var currentUser = await userManager.GetUserAsync(User);
            var task = await context.Tasks.FindAsync(taskId);

            if (task == null)
                return NotFound();

            var currentTaskStage = await context.TaskStages
                .FirstOrDefaultAsync(ts =&gt; ts.TaskId == taskId &amp;&amp; ts.StageId == currentStageId &amp;&amp; ts.CompletedDate == null);

            if (currentTaskStage != null)
            {
                currentTaskStage.CompletedDate = DateTime.Now;
                currentTaskStage.UpdatedByUserId = currentUser.Id;
            }

            var newTaskStage = new TaskStage
            {
                TaskId = taskId,
                StageId = newStageId,
                EnteredDate = DateTime.Now,
                CompletedDate = null,
                UpdatedByUserId = currentUser.Id
            };

            context.TaskStages.Add(newTaskStage);
            await context.SaveChangesAsync();

            var newStage = await context.Stages.Include(s =&gt; s.ProjectBoard).FirstOrDefaultAsync(s =&gt; s.Id == newStageId);
            var projectId = newStage?.ProjectBoard?.ProjectId ?? 0;

            return RedirectToAction(nameof(ProjectBoard), new { id = projectId });
        }

        /// &lt;summary&gt;
        /// Edits the task.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;taskId&quot;&gt;The task identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpGet]
        public async Task&lt;IActionResult&gt; EditTask(int taskId)
        {
            var task = await context.Tasks
                .Include(t =&gt; t.TaskEmployees)
                .ThenInclude(te =&gt; te.Employee)
                .FirstOrDefaultAsync(t =&gt; t.Id == taskId);

            if (task == null)
                return NotFound();

            var taskStage = await context.TaskStages
                .Include(ts =&gt; ts.Stage)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .Include(ts =&gt; ts.Stage.ProjectBoard)
                .ThenInclude(pb =&gt; pb.Project)
                .ThenInclude(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .ThenInclude(g =&gt; g.UserGroups)
                .ThenInclude(ug =&gt; ug.User)
                .FirstOrDefaultAsync(ts =&gt; ts.TaskId == taskId &amp;&amp; ts.CompletedDate == null);

            var project = taskStage?.Stage?.ProjectBoard?.Project;

            if (project == null)
                return NotFound();

            var currentUser = await userManager.FindByIdAsync(userManager.GetUserId(User));
            bool isAdmin = await userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            bool isProjectLead = project.ProjectLeadId == currentUser.Id;
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            bool isGroupManager = await context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId)
                      &amp;&amp; ug.UserId == currentUser.Id
                      &amp;&amp; ug.Role == &quot;Manager&quot;);

            bool isGroupMember = taskStage.Stage.AssignedGroupId != null &amp;&amp;
                                 await context.UserGroups.AnyAsync(ug =&gt;
                                     ug.GroupId == taskStage.Stage.AssignedGroupId &amp;&amp;
                                     ug.UserId == currentUser.Id);

            if (!(isAdmin || isProjectLead || isGroupManager || isGroupMember))
                return Forbid();

            var vm = new CreateTaskViewModel
            {
                TaskId = task.Id,
                Name = task.Name,
                Description = task.Description,
                SelectedEmployeeId = task.TaskEmployees.FirstOrDefault()?.EmployeeId
            };

            if (isAdmin || isProjectLead || isGroupManager)
            {
                await setAvailableEmployees(isAdmin, vm, isProjectLead, project, isGroupManager, currentUser, taskStage.Stage, taskStage.Stage.AssignedGroup != null);
            }
            else if (isGroupMember)
            {
                vm.AvailableEmployees = new List&lt;SelectListItem&gt;
        {
            new SelectListItem { Value = currentUser.Id.ToString(), Text = currentUser.UserName }
        };
            }

            ViewBag.ProjectId = project.Id;

            return View(&quot;EditTask&quot;, vm);
        }


        /// &lt;summary&gt;
        /// Edits the task.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;vm&quot;&gt;The vm.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; EditTask(CreateTaskViewModel vm)
        {
            if (!ModelState.IsValid)
                return View(vm);

            var currProjectId = await context.TaskStages
                .Where(ts =&gt; ts.TaskId == vm.TaskId)
                .Include(ts =&gt; ts.Stage)
                .ThenInclude(s =&gt; s.ProjectBoard)
                .Select(ts =&gt; ts.Stage.ProjectBoard.ProjectId)
                .FirstOrDefaultAsync();

            bool nameExists = await context.TaskStages
                .Where(ts =&gt; ts.Stage.ProjectBoard.ProjectId == currProjectId)
                .Select(ts =&gt; ts.Task)
                .AnyAsync(t =&gt; t.Name == vm.Name &amp;&amp; t.Id != vm.TaskId);
            if (nameExists)
            {
                ModelState.AddModelError(&quot;Name&quot;, &quot;A task with this name already exists.&quot;);
                return View(vm);
            }

            var task = await context.Tasks
                .Include(t =&gt; t.TaskEmployees)
                .FirstOrDefaultAsync(t =&gt; t.Id == vm.TaskId);

            if (task == null)
                return NotFound();

            task.Name = vm.Name;
            task.Description = vm.Description;

            // Handle employee reassignment
            var currentAssignment = task.TaskEmployees.FirstOrDefault();
            if (currentAssignment != null &amp;&amp; currentAssignment.EmployeeId != vm.SelectedEmployeeId)
            {
                context.TaskEmployees.Remove(currentAssignment);
            }

            if (vm.SelectedEmployeeId != null &amp;&amp; (currentAssignment == null || currentAssignment.EmployeeId != vm.SelectedEmployeeId))
            {
                var employee = await userManager.FindByIdAsync(vm.SelectedEmployeeId.Value.ToString());
                var newAssignment = new TaskEmployee
                {
                    TaskId = task.Id,
                    EmployeeId = vm.SelectedEmployeeId.Value,
                    Employee = employee,
                    AssignedDate = DateTime.Now,
                    CompletedDate = null
                };
                context.TaskEmployees.Add(newAssignment);
            }

            await context.SaveChangesAsync();

            var projectId = await context.TaskStages
                .Where(ts =&gt; ts.TaskId == task.Id)
                .Include(ts =&gt; ts.Stage)
                .ThenInclude(s =&gt; s.ProjectBoard)
                .Select(ts =&gt; ts.Stage.ProjectBoard.ProjectId)
                .FirstOrDefaultAsync();

            return RedirectToAction(nameof(ProjectBoard), new { id = projectId });
        }

        /// &lt;summary&gt;
        /// Gets the project board (and an Add Stage form if user has perm).
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpGet]
        public async Task&lt;IActionResult&gt; ProjectBoard(int id)
        {
            var project = await context.Projects
                .Include(p =&gt; p.ProjectBoard)
                    .ThenInclude(b =&gt; b.Stages)
                    .ThenInclude(s =&gt; s.AssignedGroup)
                .Include(p =&gt; p.ProjectGroups)
                    .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == id);

            if (project == null)
                return NotFound();

            if (project.ProjectBoard == null)
            {
                var currentUserId = userManager.GetUserId(User);
                var newBoard = new ProjectBoard
                {
                    ProjectId = project.Id,
                    BoardCreatorId = int.Parse(currentUserId),
                    Stages = new List&lt;Stage&gt;
                    {
                        new Stage
                        {
                            Name = &quot;To Do&quot;,
                            Position = 1,
                            CreatorUserId = int.Parse(currentUserId),
                        },
                        new Stage
                        {
                            Name = &quot;In Progess&quot;,
                            Position = 2,
                            CreatorUserId = int.Parse(currentUserId),
                        },
                        new Stage
                        {
                            Name = &quot;Done&quot;,
                            Position = 3,
                            CreatorUserId = int.Parse(currentUserId),
                        }
                    }
                };
                context.ProjectBoards.Add(newBoard);
                await context.SaveChangesAsync();

                project = await context.Projects
                    .Include(p =&gt; p.ProjectBoard)
                        .ThenInclude(b =&gt; b.Stages)
                        .ThenInclude(s =&gt; s.AssignedGroup)
                    .Include(p =&gt; p.ProjectGroups)
                        .ThenInclude(pg =&gt; pg.Group)
                    .FirstOrDefaultAsync(p =&gt; p.Id == id);
            }

            var stageForm = new CreateStageViewModel
            {
                AvailableGroups = project.ProjectGroups.Select(pg =&gt; new SelectListItem
                {
                    Value = pg.Group.Id.ToString(),
                    Text = pg.Group.Name
                }).ToList()
            };

            var vm = new ProjectBoardViewModel
            {
                Project = project,
                StageForm = stageForm
            };

            var currentUser = await userManager.FindByIdAsync(userManager.GetUserId(User));
            bool isAdmin = await userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            bool isProjectLead = (project.ProjectLeadId == int.Parse(userManager.GetUserId(User)));
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            bool isGroupManager = await context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId)
                      &amp;&amp; ug.UserId == int.Parse(userManager.GetUserId(User))
                      &amp;&amp; ug.Role == &quot;Manager&quot;);
            var isEmployeeApartOfProject = context.UserGroups
                .Any(ug =&gt; ug.UserId == currentUser.Id &amp;&amp;
                           ug.Role == &quot;Member&quot; &amp;&amp;
                           context.GroupProjects
                               .Any(pg =&gt; pg.GroupId == ug.GroupId &amp;&amp; pg.ProjectId == project.Id));

            vm.CanAddStage = (isAdmin || isProjectLead || isGroupManager);
            vm.CanDeleteAnyTask = (isAdmin || isProjectLead);

            var userGroupIds = context.UserGroups
                .Where(ug =&gt; ug.UserId == currentUser.Id)
                .Select(ug =&gt; ug.GroupId)
                .ToList();

            var stagesWithPermissions = project.ProjectBoard.Stages
                .Select(stage =&gt; new StagePermissionViewModel
                {
                    Stage = stage,
                    IsUserAssignedToGroup = stage.AssignedGroup != null &amp;&amp; userGroupIds.Contains(stage.AssignedGroup.Id),
                    IsAdminOrLead = isAdmin || isProjectLead
                })
                .ToList();

            ViewBag.StagesWithPermissions = stagesWithPermissions;

            await setViewBagManagedUsers(isGroupManager, currentUser, project);

            await this.addTaskStagesToStages(project.ProjectBoard.Id);

            if (isAdmin)
            {
                return View(&quot;~/Views/Admin/ProjectBoard.cshtml&quot;, vm);
            }
            else
            {
                return View(&quot;~/Views/Employee/ProjectBoard.cshtml&quot;, vm);
            }
        }

        /// &lt;summary&gt;
        /// Posts the project board.
        /// If a stage position is already taken, we alert the user via validation error.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The identifier.&lt;/param&gt;
        /// &lt;param name=&quot;vm&quot;&gt;The vm.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; ProjectBoard(int id, ProjectBoardViewModel vm)
        {
            var project = await context.Projects
                .Include(p =&gt; p.ProjectBoard)
                    .ThenInclude(b =&gt; b.Stages)
                    .ThenInclude(s =&gt; s.AssignedGroup)
                .Include(p =&gt; p.ProjectGroups)
                    .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == id);

            if (project == null)
                return NotFound();

            var currentUserId = userManager.GetUserId(User);
            var currentUser = await userManager.FindByIdAsync(currentUserId);
            bool isAdmin = await userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            bool isProjectLead = (project.ProjectLeadId == int.Parse(currentUserId));
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            bool isGroupManager = await context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId)
                      &amp;&amp; ug.UserId == int.Parse(currentUserId)
                      &amp;&amp; ug.Role == &quot;Manager&quot;);

            if (!(isAdmin || isProjectLead || isGroupManager))
            {
                return Forbid();
            }

            vm.StageForm.AvailableGroups = project.ProjectGroups
                .Select(pg =&gt; new SelectListItem
                {
                    Value = pg.Group.Id.ToString(),
                    Text = pg.Group.Name
                })
                .ToList();

            vm.CanAddStage = (isAdmin || isProjectLead || isGroupManager);
            vm.Project = project;

            if (project.ProjectBoard == null)
            {
                var newBoard = new ProjectBoard
                {
                    ProjectId = project.Id,
                    BoardCreatorId = int.Parse(currentUserId),
                    Stages = new List&lt;Stage&gt;
                    {
                        new Stage
                        {
                            Name = &quot;To Do&quot;,
                            Position = 1,
                            CreatorUserId = int.Parse(currentUserId),
                        },
                        new Stage
                        {
                            Name = &quot;In Progress&quot;,
                            Position = 2,
                            CreatorUserId = int.Parse(currentUserId),
                        },
                        new Stage
                        {
                            Name = &quot;Done&quot;,
                            Position = 3,
                            CreatorUserId = int.Parse(currentUserId),
                        }
                    }
                };
                context.ProjectBoards.Add(newBoard);
                await context.SaveChangesAsync();
                project.ProjectBoard = newBoard;
            }

            var occupant = project.ProjectBoard.Stages
                .FirstOrDefault(s =&gt; s.Position == vm.StageForm.Position);

            if (occupant != null)
            {
                ModelState.AddModelError(&quot;StageForm.Position&quot;, &quot;This position is already taken by another stage.&quot;);
            }

            var duplicateStage = await context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.ProjectBoard.ProjectId == id &amp;&amp; s.Name == vm.StageForm.Name);

            if (!string.IsNullOrWhiteSpace(vm.StageForm.Name) &amp;&amp; duplicateStage != null)
            {
                ModelState.AddModelError(&quot;StageForm.Name&quot;, &quot;A stage with this name already exists in this project.&quot;);
            }

            this.ForceProjectValid(ModelState);

            if (!ModelState.IsValid)
            {
                if (isAdmin)
                {
                    return View(&quot;~/Views/Admin/ProjectBoard.cshtml&quot;, vm);
                }
                else
                {
                    return View(&quot;~/Views/Employee/ProjectBoard.cshtml&quot;, vm);
                }
            }

            var newStage = new Stage
            {
                Name = vm.StageForm.Name,
                Position = vm.StageForm.Position,
                ProjectBoardId = project.ProjectBoard.Id,
                CreatorUserId = int.Parse(currentUserId),
                AssignedGroupId = vm.StageForm.SelectedGroupId
            };
            context.Stages.Add(newStage);
            await context.SaveChangesAsync();

            return RedirectToAction(nameof(ProjectBoard), new { id });
        }


        /// &lt;summary&gt;
        /// Edits the stage. (GET)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stageId&quot;&gt;The stage identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpGet]
        public async Task&lt;IActionResult&gt; EditStage(int stageId)
        {
            var stage = await context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.Id == stageId);

            if (stage == null)
                return NotFound();

            var project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                    .ThenInclude(pg =&gt; pg.Group)
                .Include(p =&gt; p.ProjectBoard)
                    .ThenInclude(b =&gt; b.Stages)
                    .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            if (project == null)
                return NotFound();

            var currentUserId = userManager.GetUserId(User);
            var currentUser = await userManager.FindByIdAsync(currentUserId);
            bool isAdmin = await userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            bool isProjectLead = project.ProjectLeadId == int.Parse(currentUserId);
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            bool isGroupManager = await context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId) &amp;&amp; ug.UserId == int.Parse(currentUserId) &amp;&amp; ug.Role == &quot;Manager&quot;);

            if (!(isAdmin || isProjectLead || isGroupManager))
            {
                return Forbid();
            }

            var allStages = project.ProjectBoard.Stages
                .OrderBy(s =&gt; s.Position)
                .ToList();

            var vm = new StageEditViewModel
            {
                StageId = stage.Id,
                ProjectId = project.Id,
                Name = stage.Name,
                Position = stage.Position,
                SelectedGroupId = stage.AssignedGroupId,
                AvailableGroups = project.ProjectGroups.Select(pg =&gt; new SelectListItem
                {
                    Value = pg.Group.Id.ToString(),
                    Text = pg.Group.Name
                }).ToList(),

                AllStages = allStages
            };

            return View(&quot;EditStage&quot;, vm);
        }

        /// &lt;summary&gt;
        /// Edits the stage. (POST)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;vm&quot;&gt;The vm.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; EditStage(StageEditViewModel vm)
        {
            var stage = await context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.Id == vm.StageId);

            if (stage == null) return NotFound();

            var project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                    .ThenInclude(pg =&gt; pg.Group)
                .Include(p =&gt; p.ProjectBoard)
                    .ThenInclude(b =&gt; b.Stages)
                    .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            if (project == null) return NotFound();

            vm.AvailableGroups = project.ProjectGroups.Select(pg =&gt; new SelectListItem
            {
                Value = pg.Group.Id.ToString(),
                Text = pg.Group.Name
            }).ToList();

            vm.AllStages = project.ProjectBoard.Stages
                .OrderBy(s =&gt; s.Position)
                .ToList();

            vm.ProjectId = project.Id;

            var currentUserId = userManager.GetUserId(User);
            var currentUser = await userManager.FindByIdAsync(currentUserId);
            bool isAdmin = await userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            bool isProjectLead = project.ProjectLeadId == int.Parse(currentUserId);
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            bool isGroupManager = await context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId) &amp;&amp; ug.UserId == int.Parse(currentUserId) &amp;&amp; ug.Role == &quot;Manager&quot;);

            if (!(isAdmin || isProjectLead || isGroupManager))
            {
                return Forbid();
            }

            if (!ModelState.IsValid)
            {
                return View(&quot;EditStage&quot;, vm);
            }

            bool nameExists = await context.Stages
                .AnyAsync(s =&gt; s.ProjectBoardId == stage.ProjectBoardId
                               &amp;&amp; s.Id != stage.Id
                               &amp;&amp; s.Name == vm.Name);
            if (nameExists)
            {
                ModelState.AddModelError(&quot;Name&quot;, &quot;A stage with this name already exists.&quot;);
                return View(&quot;EditStage&quot;, vm);
            }

            var occupant = await context.Stages
                .FirstOrDefaultAsync(s =&gt; s.ProjectBoardId == stage.ProjectBoardId
                                          &amp;&amp; s.Position == vm.Position
                                          &amp;&amp; s.Id != stage.Id);

            if (occupant != null)
            {
                var oldPosition = stage.Position;
                occupant.Position = oldPosition;
            }

            stage.Position = vm.Position;
            stage.Name = vm.Name;
            stage.AssignedGroupId = vm.SelectedGroupId;

            context.Stages.Update(stage);
            await context.SaveChangesAsync();

            return RedirectToAction(nameof(ProjectBoard), new { id = project.Id });
        }

        /// &lt;summary&gt;
        /// Deletes the stage.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stageId&quot;&gt;The stage identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; DeleteStage(int stageId)
        {
            var stage = await context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.Id == stageId);

            if (stage == null)
                return NotFound();

            var project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                    .ThenInclude(pg =&gt; pg.Group)
                .Include(p =&gt; p.ProjectBoard)
                    .ThenInclude(b =&gt; b.Stages)
                    .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            if (project == null)
                return NotFound();

            var currentUserId = userManager.GetUserId(User);
            var currentUser = await userManager.FindByIdAsync(currentUserId);
            bool isAdmin = await userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            bool isProjectLead = project.ProjectLeadId == int.Parse(currentUserId);
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            bool isGroupManager = await context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId) &amp;&amp; ug.UserId == int.Parse(currentUserId) &amp;&amp; ug.Role == &quot;Manager&quot;);

            if (!(isAdmin || isProjectLead || isGroupManager))
            {
                return Forbid();
            }

            context.Stages.Remove(stage);
            await context.SaveChangesAsync();

            return RedirectToAction(nameof(ProjectBoard), new { id = project.Id });
        }

        /// &lt;summary&gt;
        /// Forces the project valid.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;modelState&quot;&gt;State of the model.&lt;/param&gt;
        private void ForceProjectValid(ModelStateDictionary modelState)
        {
            if (modelState.ContainsKey(&quot;Project&quot;))
            {
                var entry = modelState[&quot;Project&quot;];
                if (entry != null &amp;&amp; entry.ValidationState == ModelValidationState.Invalid)
                {
                    entry.Errors.Clear();
                    entry.ValidationState = ModelValidationState.Valid;
                }
            }
        }

        /// &lt;summary&gt;
        /// Adds the task stages to stages.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;projectBoardId&quot;&gt;The project board identifier.&lt;/param&gt;
        private async System.Threading.Tasks.Task addTaskStagesToStages(int projectBoardId)
        {
            var stages = await context.Stages
                .Where(s =&gt; s.ProjectBoardId == projectBoardId)  
                .Include(s =&gt; s.TaskStages)  
                .ToListAsync();

            foreach (var stage in stages)
            {
                var taskStages = await context.TaskStages
                    .Where(ts =&gt; ts.StageId == stage.Id)  
                    .ToListAsync();

                foreach (var taskStage in taskStages)
                {
                    Models.Task task = await context.Tasks
                        .FirstOrDefaultAsync(t =&gt; t.Id == taskStage.TaskId);
                    taskStage.Task = task;
                    stage.TaskStages.Add(taskStage);
                }
            }
        }

        /// &lt;summary&gt;
        /// Sets the available employees.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;isAdmin&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [is admin].&lt;/param&gt;
        /// &lt;param name=&quot;vm&quot;&gt;The vm.&lt;/param&gt;
        /// &lt;param name=&quot;isProjectLead&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [is project lead].&lt;/param&gt;
        /// &lt;param name=&quot;project&quot;&gt;The project.&lt;/param&gt;
        /// &lt;param name=&quot;isGroupManager&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [is group manager].&lt;/param&gt;
        /// &lt;param name=&quot;currentUser&quot;&gt;The current user.&lt;/param&gt;
        private async Task setAvailableEmployees(bool isAdmin, CreateTaskViewModel vm, bool isProjectLead, Project project,
    bool isGroupManager, User currentUser, Stage stage, bool isAssignedGroup)
        {
            if (isAssignedGroup)
            {
                var assignedUsers = context.UserGroups
                    .Where(ug =&gt; ug.GroupId == stage.AssignedGroup.Id)
                    .Select(ug =&gt; ug.User)
                    .ToList();

                if (!isAdmin &amp;&amp; !isProjectLead &amp;&amp; !isGroupManager)
                {
                    vm.AvailableEmployees = new List&lt;SelectListItem&gt;
            {
                new() { Value = currentUser.Id.ToString(), Text = currentUser.UserName }
            };
                }
                else
                {
                    vm.AvailableEmployees = assignedUsers
                        .Select(e =&gt; new SelectListItem
                        {
                            Value = e.Id.ToString(),
                            Text = e.UserName
                        })
                        .ToList();
                }
            }
            else
            {
                if (isAdmin)
                {
                    var employees = await userManager.GetUsersInRoleAsync(&quot;Employee&quot;);
                    vm.AvailableEmployees = employees.Select(e =&gt; new SelectListItem
                    {
                        Value = e.Id.ToString(),
                        Text = e.UserName
                    }).ToList();
                }
                else if (isProjectLead)
                {
                    vm.AvailableEmployees = project.ProjectGroups
                        .SelectMany(pg =&gt; pg.Group.UserGroups)
                        .Where(ug =&gt; ug.Role == &quot;Member&quot;)
                        .Select(ug =&gt; new SelectListItem
                        {
                            Value = ug.UserId.ToString(),
                            Text = ug.User.UserName
                        })
                        .ToList();
                }
                else if (isGroupManager)
                {
                    var managedGroups = project.ProjectGroups
                        .Where(pg =&gt; pg.Group.UserGroups
                            .Any(ug =&gt; ug.UserId == currentUser.Id &amp;&amp; ug.Role == &quot;Manager&quot;))
                        .ToList();

                    vm.AvailableEmployees = managedGroups
                        .SelectMany(pg =&gt; pg.Group.UserGroups)
                        .Where(ug =&gt; ug.Role == &quot;Member&quot;)
                        .GroupBy(ug =&gt; ug.UserId)
                        .Select(g =&gt; g.First())
                        .Select(ug =&gt; new SelectListItem
                        {
                            Value = ug.UserId.ToString(),
                            Text = ug.User.UserName
                        })
                        .ToList();
                }
                else
                {
                    vm.AvailableEmployees = new List&lt;SelectListItem&gt;
            {
                new() { Value = currentUser.Id.ToString(), Text = currentUser.UserName }
            };
                }
            }
        }


        private async Task setViewBagManagedUsers(bool isGroupManager, User currentUser, Project project)
        {
            if (isGroupManager)
            {
                var managedGroupIds = await context.UserGroups
                    .Where(ug =&gt; ug.UserId == currentUser.Id &amp;&amp; ug.Role == &quot;Manager&quot;)
                    .Select(ug =&gt; ug.GroupId)
                    .ToListAsync();

                var managedGroupProjects = project.ProjectGroups
                    .Where(pg =&gt; managedGroupIds.Contains(pg.GroupId))
                    .ToList();
                var managedGroups = project.ProjectGroups
                    .Where(pg =&gt; managedGroupIds.Contains(pg.GroupId))
                    .ToList();

                var managedUsers = context.UserGroups
                    .Where(ug =&gt; managedGroupIds.Contains(ug.GroupId))
                    .Select(ug =&gt; ug.User)
                    .Distinct()
                    .ToList();

                ViewBag.ManagedUsers = managedUsers;
            }
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[34,9,34,94,1],[35,9,35,10,1],[36,13,36,36,1],[37,13,37,44,1],[38,9,38,10,1],[46,9,46,10,1],[47,13,49,66,1],[51,13,53,70,1],[55,13,55,31,1],[56,17,56,35,1],[58,13,65,86,1],[67,13,67,33,1],[68,17,68,35,0],[70,13,70,113,1],[71,13,71,107,1],[72,13,72,95,1],[74,13,74,46,1],[76,13,76,84,1],[77,9,77,10,1],[86,9,86,10,1],[87,13,89,60,1],[91,13,91,31,1],[92,17,92,35,1],[94,13,101,86,1],[103,13,103,33,1],[104,17,104,35,1],[106,13,106,44,1],[108,13,108,66,1],[110,13,110,63,1],[111,13,111,92,1],[112,13,112,82,1],[113,13,113,100,1],[114,13,114,63,1],[114,63,114,73,1],[114,73,114,84,1],[115,13,118,48,1],[120,13,120,125,1],[122,13,122,43,1],[123,9,123,10,1],[133,9,133,10,1],[134,13,134,37,1],[135,17,135,33,1],[137,13,139,63,1],[141,13,141,31,1],[142,17,142,35,1],[144,13,144,58,1],[146,13,149,51,1],[151,13,151,33,1],[152,13,152,14,1],[153,17,153,107,1],[154,17,154,33,1],[157,13,163,15,1],[165,13,165,37,1],[166,13,166,46,1],[168,13,178,15,1],[180,13,180,47,1],[182,13,182,47,1],[183,13,183,14,1],[184,17,192,19,1],[194,17,194,57,1],[195,13,195,14,1],[197,13,197,46,1],[199,13,199,45,1],[201,13,208,86,1],[210,13,210,84,1],[211,9,211,10,1],[222,9,222,10,1],[223,13,223,68,1],[224,13,224,62,1],[226,13,226,30,1],[227,17,227,35,0],[229,13,230,125,1],[232,13,232,42,1],[233,13,233,14,1],[234,17,234,63,1],[235,17,235,67,1],[236,13,236,14,1],[238,13,245,15,1],[247,13,247,50,1],[248,13,248,46,1],[250,13,250,123,1],[251,13,251,68,1],[253,13,253,83,1],[254,9,254,10,1],[263,9,263,10,1],[264,13,267,59,1],[269,13,269,30,1],[270,17,270,35,1],[272,13,281,93,1],[283,13,283,67,1],[285,13,285,33,1],[286,17,286,35,1],[288,13,288,92,1],[289,13,289,82,1],[290,13,290,74,1],[291,13,291,63,1],[291,63,291,73,1],[291,73,291,84,1],[292,13,295,48,1],[297,13,300,67,1],[302,13,302,80,1],[303,17,303,33,1],[305,13,311,15,1],[313,13,313,60,1],[314,13,314,14,1],[315,17,315,167,1],[316,13,316,14,1],[317,18,317,36,0],[318,13,318,14,0],[319,17,322,11,0],[323,13,323,14,0],[325,13,325,44,1],[327,13,327,41,1],[328,9,328,10,1],[339,9,339,10,1],[340,13,340,37,1],[341,17,341,33,1],[343,13,348,40,1],[350,13,353,72,1],[354,13,354,28,1],[355,13,355,14,1],[356,17,356,91,1],[357,17,357,33,1],[360,13,362,62,1],[364,13,364,30,1],[365,17,365,35,1],[367,13,367,33,1],[368,13,368,47,1],[371,13,371,73,1],[372,13,372,100,1],[373,13,373,14,0],[374,17,374,65,0],[375,13,375,14,0],[377,13,377,135,1],[378,13,378,14,0],[379,17,379,104,0],[380,17,387,19,0],[388,17,388,58,0],[389,13,389,14,0],[391,13,391,46,1],[393,13,398,40,1],[400,13,400,83,1],[401,9,401,10,1],[410,9,410,10,1],[411,13,417,55,1],[419,13,419,33,1],[420,17,420,35,1],[422,13,422,46,1],[423,13,423,14,1],[424,17,424,65,1],[425,17,450,19,1],[451,17,451,53,1],[452,17,452,50,1],[454,17,460,59,1],[461,13,461,14,1],[463,13,465,70,1],[465,70,469,18,0],[469,18,470,15,1],[472,13,476,15,1],[478,13,478,92,1],[479,13,479,82,1],[480,13,480,100,1],[481,13,481,63,1],[481,63,481,73,0],[481,73,481,84,1],[482,13,485,48,1],[486,13,490,100,1],[492,13,492,75,1],[493,13,493,62,1],[495,13,498,27,1],[500,13,501,34,1],[501,34,506,18,1],[506,18,507,27,1],[509,13,509,67,1],[511,13,511,80,1],[513,13,513,71,1],[515,13,515,25,1],[516,13,516,14,1],[517,17,517,70,1],[520,13,520,14,1],[521,17,521,73,1],[523,9,523,10,1],[535,9,535,10,1],[536,13,542,55,1],[544,13,544,33,1],[545,17,545,35,1],[547,13,547,61,1],[548,13,548,78,1],[549,13,549,82,1],[550,13,550,86,1],[551,13,551,63,1],[551,63,551,73,1],[551,73,551,84,1],[552,13,555,48,1],[557,13,557,63,1],[558,13,558,14,1],[559,17,559,33,1],[562,13,563,31,1],[563,31,567,18,1],[567,18,568,27,1],[570,13,570,75,1],[571,13,571,34,1],[573,13,573,46,1],[574,13,574,14,0],[575,17,600,19,0],[601,17,601,53,0],[602,17,602,50,0],[603,17,603,49,0],[604,13,604,14,0],[606,13,607,38,1],[607,38,607,73,1],[607,73,607,75,1],[609,13,609,34,1],[610,13,610,14,0],[611,17,611,116,0],[612,13,612,14,0],[614,13,616,106,1],[618,13,618,89,1],[619,13,619,14,1],[620,17,620,118,1],[621,13,621,14,1],[623,13,623,48,1],[625,13,625,37,1],[626,13,626,14,1],[627,17,627,29,1],[628,17,628,18,0],[629,21,629,74,0],[632,17,632,18,1],[633,21,633,77,1],[637,13,644,15,1],[645,13,645,42,1],[646,13,646,46,1],[648,13,648,71,1],[649,9,649,10,1],[659,9,659,10,1],[660,13,662,60,1],[664,13,664,31,1],[665,17,665,35,1],[667,13,673,86,1],[675,13,675,33,1],[676,17,676,35,1],[678,13,678,61,1],[679,13,679,78,1],[680,13,680,82,1],[681,13,681,84,1],[682,13,682,63,1],[682,63,682,73,1],[682,73,682,84,1],[683,13,684,119,1],[686,13,686,63,1],[687,13,687,14,0],[688,17,688,33,0],[691,13,692,31,1],[692,31,692,41,1],[692,41,693,27,1],[695,13,702,70,1],[702,70,706,18,1],[706,18,709,15,1],[711,13,711,42,1],[712,9,712,10,1],[722,9,722,10,1],[723,13,725,63,1],[727,13,727,31,1],[727,32,727,50,1],[729,13,735,86,1],[737,13,737,33,1],[737,34,737,52,1],[739,13,739,69,1],[739,69,743,14,1],[743,14,743,25,1],[745,13,746,31,1],[746,31,746,41,1],[746,41,747,27,1],[749,13,749,39,1],[751,13,751,61,1],[752,13,752,78,1],[753,13,753,82,1],[754,13,754,84,1],[755,13,755,63,1],[755,63,755,73,1],[755,73,755,84,1],[756,13,757,119,1],[759,13,759,63,1],[760,13,760,14,1],[761,17,761,33,1],[764,13,764,37,1],[765,13,765,14,1],[766,17,766,46,1],[769,13,772,54,1],[773,13,773,28,1],[774,13,774,14,1],[775,17,775,92,1],[776,17,776,46,1],[779,13,782,64,1],[784,13,784,34,1],[785,13,785,14,1],[786,17,786,50,1],[787,17,787,49,1],[788,13,788,14,1],[790,13,790,42,1],[791,13,791,34,1],[792,13,792,56,1],[794,13,794,42,1],[795,13,795,46,1],[797,13,797,84,1],[798,9,798,10,1],[808,9,808,10,1],[809,13,811,60,1],[813,13,813,31,1],[814,17,814,35,1],[816,13,822,86,1],[824,13,824,33,1],[825,17,825,35,1],[827,13,827,61,1],[828,13,828,78,1],[829,13,829,82,1],[830,13,830,84,1],[831,13,831,63,1],[831,63,831,73,1],[831,73,831,84,1],[832,13,833,119,1],[835,13,835,63,1],[836,13,836,14,1],[837,17,837,33,1],[840,13,840,42,1],[841,13,841,46,1],[843,13,843,84,1],[844,9,844,10,1],[851,9,851,10,1],[852,13,852,51,1],[853,13,853,14,0],[854,17,854,51,0],[855,17,855,92,0],[856,17,856,18,0],[857,21,857,42,0],[858,21,858,72,0],[859,17,859,18,0],[860,13,860,14,0],[861,9,861,10,1],[868,9,868,10,1],[869,13,872,32,1],[874,13,874,20,1],[874,22,874,31,1],[874,32,874,34,1],[874,35,874,41,1],[875,13,875,14,1],[876,17,878,36,1],[880,17,880,24,1],[880,26,880,39,0],[880,40,880,42,1],[880,43,880,53,1],[881,17,881,18,0],[882,21,883,77,0],[884,21,884,43,0],[885,21,885,53,0],[886,17,886,18,0],[887,13,887,14,1],[888,9,888,10,1],[901,9,901,10,1],[902,13,902,33,1],[903,13,903,14,1],[904,17,907,31,1],[909,17,909,67,1],[910,17,910,18,0],[911,21,914,15,0],[915,17,915,18,0],[917,17,917,18,1],[918,21,919,38,1],[919,38,923,26,1],[923,26,924,35,1],[925,17,925,18,1],[926,13,926,14,1],[928,13,928,14,1],[929,17,929,29,1],[930,17,930,18,1],[931,21,931,87,1],[932,21,932,67,1],[932,67,936,22,0],[936,22,936,33,1],[937,17,937,18,0],[938,22,938,40,1],[939,17,939,18,1],[940,21,941,43,1],[941,43,941,62,1],[941,62,942,38,1],[942,38,942,57,0],[942,57,943,39,1],[943,39,947,26,0],[947,26,948,35,1],[949,17,949,18,1],[950,22,950,41,1],[951,17,951,18,1],[952,21,953,38,1],[953,38,954,40,1],[954,40,954,91,1],[954,91,954,92,1],[954,92,955,35,1],[957,21,958,43,1],[958,43,958,62,1],[958,62,959,38,1],[959,38,959,57,1],[959,57,960,40,1],[960,40,960,49,0],[960,49,961,38,1],[961,38,961,47,0],[961,47,962,39,1],[962,39,966,26,0],[966,26,967,35,1],[968,17,968,18,1],[970,17,970,18,1],[971,21,974,15,1],[975,17,975,18,1],[976,13,976,14,1],[977,9,977,10,1],[981,9,981,10,1],[982,13,982,32,1],[983,13,983,14,0],[984,17,987,36,0],[989,17,990,34,0],[990,34,990,70,0],[990,70,991,31,0],[992,17,993,34,0],[993,34,993,70,0],[993,70,994,31,0],[996,17,1000,31,0],[1002,17,1002,53,0],[1003,13,1003,14,0],[1004,9,1004,10,1]]);
    </script>
  </body>
</html>