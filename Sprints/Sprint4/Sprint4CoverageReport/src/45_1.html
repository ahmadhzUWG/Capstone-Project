<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Nick\Desktop\Capstone-Project\code\TaskManager\Controllers\ProjectController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.ModelBinding;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using TaskManagerData.Models;
using TaskManagerWebsite.ViewModels;
using TaskManagerWebsite.ViewModels.ProjectViewModels;
using Task = System.Threading.Tasks.Task;

namespace TaskManagerWebsite.Controllers
{
    /// &lt;summary&gt;
    /// The project controller for handling project board actions.
    /// &lt;/summary&gt;
    /// &lt;seealso cref=&quot;Microsoft.AspNetCore.Mvc.Controller&quot; /&gt;
    public class ProjectController : Controller
    {
        /// &lt;summary&gt;
        /// The context
        /// &lt;/summary&gt;
        private readonly ApplicationDbContext context;
        /// &lt;summary&gt;
        /// The user manager
        /// &lt;/summary&gt;
        private readonly UserManager&lt;User&gt; userManager;

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;ProjectController&quot; /&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;context&quot;&gt;The context.&lt;/param&gt;
        /// &lt;param name=&quot;userManager&quot;&gt;The user manager.&lt;/param&gt;
        public ProjectController(ApplicationDbContext context, UserManager&lt;User&gt; userManager)
        {
            this.context = context;
            this.userManager = userManager;
        }

        /// &lt;summary&gt;
        /// Deletes the task.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;taskStageId&quot;&gt;The task stage identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public async Task&lt;IActionResult&gt; DeleteTask(int taskStageId)
        {
            var taskStage = await this.context.TaskStages
                .Include(ts =&gt; ts.Task)
                .FirstOrDefaultAsync(ts =&gt; ts.Id == taskStageId);

            var stage = await this.context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.Id == taskStage.StageId);

            if (stage == null)
                return NotFound();

            var project = await this.context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group).ThenInclude(group =&gt; group.UserGroups)
                .ThenInclude(userGroup =&gt; userGroup.User)
                .Include(p =&gt; p.ProjectBoard)
                .ThenInclude(b =&gt; b.Stages)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            if (project == null)
                return NotFound();

            this.context.TaskEmployees.RemoveRange(this.context.TaskEmployees.Where(te =&gt; te.TaskId == taskStage.TaskId));
            this.context.TaskStages.RemoveRange(this.context.TaskStages.Where(ts =&gt; ts.TaskId == taskStage.TaskId));
            this.context.TaskHistories.RemoveRange(this.context.TaskHistories.Where(th =&gt; th.TaskId == taskStage.TaskId));
            this.context.Tasks.Remove(this.context.Tasks.FirstOrDefault(t =&gt; t.Id == taskStage.TaskId));

            await this.context.SaveChangesAsync();

            return RedirectToAction(nameof(ProjectBoard), new { id = project.Id });
        }

        /// &lt;summary&gt;
        /// Gets the create task view.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stageId&quot;&gt;The stage identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpGet]
        public async Task&lt;IActionResult&gt; CreateTask(int stageId)
        {
            var stage = await this.context.Stages
                .Include(s =&gt; s.ProjectBoard).Include(stage =&gt; stage.AssignedGroup)
                .FirstOrDefaultAsync(s =&gt; s.Id == stageId);

            if (stage == null)
            {
                return NotFound();
            }

            var project = await this.context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group).ThenInclude(group =&gt; group.UserGroups)
                .ThenInclude(userGroup =&gt; userGroup.User)
                .Include(p =&gt; p.ProjectBoard)
                .ThenInclude(b =&gt; b.Stages)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            if (project == null)
            {
                return NotFound();
            }

            ViewBag.ProjectId = project.Id;

            var vm = new CreateTaskViewModel {StageId = stageId};

            var isAssignedGroup = stage.AssignedGroup != null;
            var currentUser = await this.userManager.FindByIdAsync(this.userManager.GetUserId(User) ?? string.Empty);
            bool isAdmin = await this.userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            bool isGroupManager = await this.context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId)
                      &amp;&amp; ug.UserId == int.Parse(this.userManager.GetUserId(User) ?? string.Empty)
                      &amp;&amp; ug.Role == &quot;Manager&quot;);

            await this.setAvailableEmployees(isAdmin, vm, project, isGroupManager, currentUser, stage, isAssignedGroup);

            return View(&quot;CreateTask&quot;, vm);
        }

        /// &lt;summary&gt;
        /// Creates the task.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;vm&quot;&gt;The vm.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; CreateTask(CreateTaskViewModel vm)
        {
            if (!ModelState.IsValid)
            {
                return View(vm);
            }

            var stage = await this.context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.Id == vm.StageId);

            if (stage == null)
            {
                return NotFound();
            }

            var projectId = stage.ProjectBoard.ProjectId;

            var duplicateExists = await this.context.TaskStages
                .Where(ts =&gt; ts.Stage.ProjectBoard.ProjectId == projectId)
                .Select(ts =&gt; ts.Task)
                .AnyAsync(t =&gt; t.Name == vm.Name);

            if (duplicateExists)
            {
                ModelState.AddModelError(&quot;Name&quot;, &quot;A task with this name already exists in this project.&quot;);
                return View(vm);
            }

            var userId = int.Parse(this.userManager.GetUserId(User) ?? string.Empty);
            var user = await this.userManager.FindByIdAsync(userId.ToString());

            var task = new TaskManagerData.Models.Task
            {
                Name = vm.Name,
                Description = vm.Description,
                CreatorUserId = userId,
                CreatorUser = user
            };

            this.context.Tasks.Add(task);
            await this.context.SaveChangesAsync();

            this.context.TaskHistories.Add(new TaskHistory
            {
                TaskId = task.Id,
                UserId = userId,
                Timestamp = DateTime.Now,
                Action = &quot;Created task&quot;
            });

            var taskStage = new TaskStage
            {
                Task = task,
                TaskId = task.Id,
                Stage = stage,
                StageId = vm.StageId,
                EnteredDate = DateTime.Now,
                CompletedDate = null,
                UpdatedByUserId = int.Parse(this.userManager.GetUserId(User) ?? string.Empty),
                UpdatedByUser = await this.userManager.FindByIdAsync(this.userManager.GetUserId(User) ?? string.Empty)
            };

            this.context.TaskStages.Add(taskStage);

            if (vm.SelectedEmployeeId != null)
            {
                var assignedUser = await this.userManager.FindByIdAsync(vm.SelectedEmployeeId.Value.ToString());

                var taskEmployee = new TaskEmployee
                {
                    EmployeeId = vm.SelectedEmployeeId.Value,
                    Employee = assignedUser,
                    Task = task,
                    TaskId = task.Id,
                    AssignedDate = DateTime.Now,
                    CompletedDate = null
                };

                this.context.TaskEmployees.Add(taskEmployee);

                this.context.TaskHistories.Add(new TaskHistory
                {
                    TaskId = task.Id,
                    UserId = userId,
                    Timestamp = DateTime.Now,
                    Action = $&quot;Assigned task to {assignedUser.UserName}&quot;
                });
            }

            await this.context.SaveChangesAsync();

            stage.TaskStages.Add(taskStage);

            var project = await this.context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group).ThenInclude(group =&gt; group.UserGroups)
                .ThenInclude(userGroup =&gt; userGroup.User)
                .Include(p =&gt; p.ProjectBoard)
                .ThenInclude(b =&gt; b.Stages)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            return RedirectToAction(nameof(ProjectBoard), new { id = project.Id });
        }
        /// &lt;summary&gt;
        /// Moves the task.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;taskId&quot;&gt;The task identifier.&lt;/param&gt;
        /// &lt;param name=&quot;currentStageId&quot;&gt;The current stage identifier.&lt;/param&gt;
        /// &lt;param name=&quot;newStageId&quot;&gt;The new stage identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; MoveTask(int taskId, int currentStageId, int newStageId)
        {
            var userId = int.Parse(this.userManager.GetUserId(User));
            var user = await this.userManager.FindByIdAsync(userId.ToString());

            var task = await this.context.Tasks.FindAsync(taskId);
            if (task == null)
                return NotFound();

            var currentTaskStage = await this.context.TaskStages
                .FirstOrDefaultAsync(ts =&gt; ts.TaskId == taskId &amp;&amp; ts.StageId == currentStageId &amp;&amp; ts.CompletedDate == null);

            if (currentTaskStage != null)
            {
                currentTaskStage.CompletedDate = DateTime.Now;
                currentTaskStage.UpdatedByUserId = user.Id;
            }

            var newStage = await this.context.Stages.Include(s =&gt; s.ProjectBoard).FirstOrDefaultAsync(s =&gt; s.Id == newStageId);

            var newTaskStage = new TaskStage
            {
                TaskId = taskId,
                StageId = newStageId,
                EnteredDate = DateTime.Now,
                CompletedDate = null,
                UpdatedByUserId = user.Id
            };

            this.context.TaskStages.Add(newTaskStage);

            this.context.TaskHistories.Add(new TaskHistory
            {
                TaskId = taskId,
                UserId = user.Id,
                Timestamp = DateTime.Now,
                Action = $&quot;Moved task to stage \&quot;{newStage?.Name}\&quot;&quot;
            });

            var isTaskAssignedEmployee = this.context.TaskEmployees
                .Any(te =&gt; te.TaskId == taskId);

            // Remove the current assignee from task if the new stage has an assigned group and the assignee is not part of that group
            if (newStage.AssignedGroupId.HasValue &amp;&amp; isTaskAssignedEmployee)
            {
                var assignedGroupId = newStage.AssignedGroupId.Value;
                var currentAssigneeId = await this.context.TaskEmployees
                    .Where(te =&gt; te.TaskId == taskId)
                    .Select(te =&gt; te.EmployeeId)
                    .FirstOrDefaultAsync();
                var assigneeGroupIds = await this.context.UserGroups
                    .Where(ug =&gt; ug.UserId == currentAssigneeId)
                    .Select(ug =&gt; ug.GroupId)
                    .ToListAsync();

                // Check if the current assignee is part of the assigned group
                if (!assigneeGroupIds.Contains(assignedGroupId))
                {
                    var taskEmployee = await this.context.TaskEmployees
                        .FirstOrDefaultAsync(te =&gt; te.TaskId == taskId);

                    this.context.TaskEmployees.Remove(taskEmployee);
                    
                }
            }

            await this.context.SaveChangesAsync();

            var projectId = newStage?.ProjectBoard?.ProjectId ?? 0;
            return RedirectToAction(nameof(ProjectBoard), new { id = projectId });
        }


        /// &lt;summary&gt;
        /// Edits the task.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;taskId&quot;&gt;The task identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpGet]
        public async Task&lt;IActionResult&gt; EditTask(int taskId)
        {
            var task = await this.context.Tasks
                .Include(t =&gt; t.TaskEmployees)
                .ThenInclude(te =&gt; te.Employee)
                .FirstOrDefaultAsync(t =&gt; t.Id == taskId);

            if (task == null)
            {
                return NotFound();
            }

            var taskStage = await this.context.TaskStages
                .Include(ts =&gt; ts.Stage)
                    .ThenInclude(s =&gt; s.AssignedGroup)
                .Include(ts =&gt; ts.Stage.ProjectBoard)
                    .ThenInclude(pb =&gt; pb.Project)
                    .ThenInclude(p =&gt; p.ProjectGroups)
                    .ThenInclude(pg =&gt; pg.Group)
                    .ThenInclude(g =&gt; g.UserGroups)
                    .ThenInclude(ug =&gt; ug.User)
                .FirstOrDefaultAsync(ts =&gt; ts.TaskId == taskId &amp;&amp; ts.CompletedDate == null);

            var project = taskStage?.Stage?.ProjectBoard?.Project;

            if (project == null)
            {
                return NotFound();
            }

            var currentUser = await this.userManager.FindByIdAsync(this.userManager.GetUserId(User));
            var isAdmin = currentUser != null &amp;&amp; await this.userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            var isGroupManager = await this.context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId)
                      &amp;&amp; ug.UserId == currentUser.Id
                      &amp;&amp; ug.Role == &quot;Manager&quot;);

            var isGroupMember = taskStage?.Stage?.AssignedGroupId != null &amp;&amp;
                                await this.context.UserGroups.AnyAsync(ug =&gt;
                                    ug.GroupId == taskStage.Stage.AssignedGroupId &amp;&amp;
                                    ug.UserId == currentUser.Id);

            var isProjectLead = project.ProjectLeadId == currentUser.Id;

            if (!(isAdmin || isGroupManager || isGroupMember || isProjectLead))
                return Forbid();

            var history = await this.context.TaskHistories
                .Where(h =&gt; h.TaskId == taskId)
                .Include(h =&gt; h.User)
                .OrderByDescending(h =&gt; h.Timestamp)
                .ToListAsync();

            var comments = await this.context.Comments
                .Where(c =&gt; c.TaskId == taskId)
                .Include(c =&gt; c.User)
                .OrderByDescending(c =&gt; c.Timestamp)
                .ToListAsync();

            var vm = new CreateTaskViewModel
            {
                TaskId = task.Id,
                Name = task.Name,
                Description = task.Description,
                SelectedEmployeeId = task.TaskEmployees.FirstOrDefault()?.EmployeeId,
                TaskHistory = history,
                Comments = comments,
            };

            if (isAdmin || isGroupManager)
            {
                await this.setAvailableEmployees(isAdmin, vm, project, isGroupManager, currentUser, taskStage.Stage, taskStage.Stage.AssignedGroup != null);
            }
            else if (isGroupMember)
            {
                vm.AvailableEmployees = new List&lt;SelectListItem&gt;
        {
            new SelectListItem { Value = currentUser.Id.ToString(), Text = currentUser.UserName }
        };
            }

            ViewBag.ProjectId = project.Id;

            return View(&quot;EditTask&quot;, vm);
        }

        /// &lt;summary&gt;
        /// Edits the task.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;vm&quot;&gt;The vm.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; EditTask(CreateTaskViewModel vm)
        {
            if (!ModelState.IsValid)
                return View(vm);

            var userId = int.Parse(this.userManager.GetUserId(User));
            var user = await this.userManager.FindByIdAsync(userId.ToString());

            var currProjectId = await this.context.TaskStages
                .Where(ts =&gt; ts.TaskId == vm.TaskId)
                .Include(ts =&gt; ts.Stage)
                .ThenInclude(s =&gt; s.ProjectBoard)
                .Select(ts =&gt; ts.Stage.ProjectBoard.ProjectId)
                .FirstOrDefaultAsync();

            bool nameExists = await this.context.TaskStages
                .Where(ts =&gt; ts.Stage.ProjectBoard.ProjectId == currProjectId)
                .Select(ts =&gt; ts.Task)
                .AnyAsync(t =&gt; t.Name == vm.Name &amp;&amp; t.Id != vm.TaskId);
            if (nameExists)
            {
                ModelState.AddModelError(&quot;Name&quot;, &quot;A task with this name already exists.&quot;);
                return View(vm);
            }

            var task = await this.context.Tasks
                .Include(t =&gt; t.TaskEmployees)
                .FirstOrDefaultAsync(t =&gt; t.Id == vm.TaskId);

            if (task == null)
                return NotFound();

            if (task.Name != vm.Name)
            {
                this.context.TaskHistories.Add(new TaskHistory
                {
                    TaskId = task.Id,
                    UserId = userId,
                    Timestamp = DateTime.Now,
                    Action = $&quot;Changed task name from \&quot;{task.Name}\&quot; to \&quot;{vm.Name}\&quot;&quot;
                });
                task.Name = vm.Name;
            }

            if (task.Description != vm.Description)
            {
                this.context.TaskHistories.Add(new TaskHistory
                {
                    TaskId = task.Id,
                    UserId = userId,
                    Timestamp = DateTime.Now,
                    Action = &quot;Updated task description&quot;
                });
                task.Description = vm.Description;
            }

            var currentAssignment = task.TaskEmployees.FirstOrDefault();
            if (currentAssignment != null &amp;&amp; currentAssignment.EmployeeId != vm.SelectedEmployeeId)
            {
                this.context.TaskEmployees.Remove(currentAssignment);
            }

            if (vm.SelectedEmployeeId != null &amp;&amp; (currentAssignment == null || currentAssignment.EmployeeId != vm.SelectedEmployeeId))
            {
                var employee = await this.userManager.FindByIdAsync(vm.SelectedEmployeeId.Value.ToString());
                var newAssignment = new TaskEmployee
                {
                    TaskId = task.Id,
                    EmployeeId = vm.SelectedEmployeeId.Value,
                    Employee = employee,
                    AssignedDate = DateTime.Now,
                    CompletedDate = null
                };
                this.context.TaskEmployees.Add(newAssignment);

                this.context.TaskHistories.Add(new TaskHistory
                {
                    TaskId = task.Id,
                    UserId = userId,
                    Timestamp = DateTime.Now,
                    Action = $&quot;Assigned task to {employee.UserName}&quot;
                });
            }

            await this.context.SaveChangesAsync();

            var projectId = await this.context.TaskStages
                .Where(ts =&gt; ts.TaskId == task.Id)
                .Include(ts =&gt; ts.Stage)
                .ThenInclude(s =&gt; s.ProjectBoard)
                .Select(ts =&gt; ts.Stage.ProjectBoard.ProjectId)
                .FirstOrDefaultAsync();

            return RedirectToAction(nameof(ProjectBoard), new { id = projectId });
        }

        /// &lt;summary&gt;
        /// Adds the comment.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;vm&quot;&gt;The vm.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; AddComment(CreateTaskViewModel vm)
        {
            if (string.IsNullOrWhiteSpace(vm.NewComment))
            {
                ModelState.AddModelError(&quot;NewComment&quot;, &quot;Comment cannot be empty.&quot;);
                vm.Comments = await this.context.Comments
                    .Where(c =&gt; c.TaskId == vm.TaskId)
                    .Include(c =&gt; c.User)
                    .OrderByDescending(c =&gt; c.Timestamp)
                    .ToListAsync();
                return View(&quot;EditTask&quot;, vm);
            }

            var userId = int.Parse(this.userManager.GetUserId(User));

            var comment = new Comment
            {
                TaskId = vm.TaskId,
                UserId = userId,
                Content = vm.NewComment,
                Timestamp = DateTime.Now
            };

            this.context.Comments.Add(comment);
            await this.context.SaveChangesAsync();

            return RedirectToAction(&quot;EditTask&quot;, new { taskId = vm.TaskId });
        }

        /// &lt;summary&gt;
        /// Replies to comment.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parentCommentId&quot;&gt;The parent comment identifier.&lt;/param&gt;
        /// &lt;param name=&quot;taskId&quot;&gt;The task identifier.&lt;/param&gt;
        /// &lt;param name=&quot;content&quot;&gt;The content.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        public async Task&lt;IActionResult&gt; ReplyToComment(int parentCommentId, int taskId, string content)
        {
            var userId = int.Parse(this.userManager.GetUserId(User));

            var reply = new Comment
            {
                ParentCommentId = parentCommentId,
                TaskId = taskId,
                UserId = userId,
                Content = content,
                Timestamp = DateTime.Now
            };

            this.context.Comments.Add(reply);
            await this.context.SaveChangesAsync();

            return RedirectToAction(&quot;EditTask&quot;, new { taskId = taskId });
        }

        /// &lt;summary&gt;
        /// Gets the project board (and an Add Stage form if user has perm).
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpGet]
        public async Task&lt;IActionResult&gt; ProjectBoard(int id)
        {
            var project = await this.context.Projects
                .Include(p =&gt; p.ProjectBoard)
                .ThenInclude(b =&gt; b.Stages)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == id);

            if (project == null)
                return NotFound();

            if (project.ProjectBoard == null)
            {
                var currentUserId = this.userManager.GetUserId(User);
                if (currentUserId != null)
                {
                    var newBoard = new ProjectBoard
                    {
                        ProjectId = project.Id,
                        BoardCreatorId = int.Parse(currentUserId),
                        Stages = new List&lt;Stage&gt;
                        {
                            new Stage
                            {
                                Name = &quot;To Do&quot;,
                                Position = 1,
                                CreatorUserId = int.Parse(currentUserId),
                            },
                            new Stage
                            {
                                Name = &quot;In Progess&quot;,
                                Position = 2,
                                CreatorUserId = int.Parse(currentUserId),
                            },
                            new Stage
                            {
                                Name = &quot;Done&quot;,
                                Position = 3,
                                CreatorUserId = int.Parse(currentUserId),
                            }
                        }
                    };
                    this.context.ProjectBoards.Add(newBoard);
                }

                await this.context.SaveChangesAsync();

                project = await this.context.Projects
                    .Include(p =&gt; p.ProjectBoard)
                    .ThenInclude(b =&gt; b.Stages)
                    .ThenInclude(s =&gt; s.AssignedGroup)
                    .Include(p =&gt; p.ProjectGroups)
                    .ThenInclude(pg =&gt; pg.Group)
                    .FirstOrDefaultAsync(p =&gt; p.Id == id);
            }

            var stageForm = new CreateStageViewModel
            {
                AvailableGroups = project.ProjectGroups.Select(pg =&gt; new SelectListItem
                {
                    Value = pg.Group.Id.ToString(),
                    Text = pg.Group.Name
                }).ToList()
            };

            var vm = new ProjectBoardViewModel
            {
                Project = project,
                StageForm = stageForm
            };

            var currentUser = await this.userManager.FindByIdAsync(this.userManager.GetUserId(User));
            var isAdmin = await this.userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            var isGroupManager = await this.context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId)
                      &amp;&amp; ug.UserId == int.Parse(this.userManager.GetUserId(User) ?? string.Empty)
                      &amp;&amp; ug.Role == &quot;Manager&quot;);
            var isEmployeeApartOfProject = this.context.UserGroups
                .Any(ug =&gt; ug.UserId == currentUser.Id &amp;&amp;
                           ug.Role == &quot;Member&quot; &amp;&amp; this.context.GroupProjects
                               .Any(pg =&gt; pg.GroupId == ug.GroupId &amp;&amp; pg.ProjectId == project.Id));

            vm.CanAddStage = (isAdmin || isGroupManager);
            vm.CanDeleteAnyTask = isAdmin;

            var userGroupIds = this.context.UserGroups
                .Where(ug =&gt; ug.UserId == currentUser.Id)
                .Select(ug =&gt; ug.GroupId)
                .ToList();

            var stagesWithPermissions = project.ProjectBoard.Stages
                .Select(stage =&gt; new StagePermissionViewModel
                {
                    Stage = stage,
                    IsUserAssignedToGroup = stage.AssignedGroup?.Id != null &amp;&amp; userGroupIds.Contains(stage.AssignedGroup.Id),
                    IsAdmin = isAdmin 
                })
                .ToList();

            ViewBag.StagesWithPermissions = stagesWithPermissions;

            await this.setViewBagManagedUsers(isGroupManager, currentUser, project);

            await this.addTaskStagesToStages(project.ProjectBoard.Id);

            if (isAdmin)
            {
                return View(&quot;~/Views/Admin/ProjectBoard.cshtml&quot;, vm);
            }
            else
            {
                return View(&quot;~/Views/Employee/ProjectBoard.cshtml&quot;, vm);
            }
        }

        /// &lt;summary&gt;
        /// Posts the project board.
        /// If a stage position is already taken, we alert the user via validation error.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The identifier.&lt;/param&gt;
        /// &lt;param name=&quot;vm&quot;&gt;The vm.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; ProjectBoard(int id, ProjectBoardViewModel vm)
        {
            var project = await this.context.Projects
                .Include(p =&gt; p.ProjectBoard)
                .ThenInclude(b =&gt; b.Stages)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == id);

            if (project == null)
            {
                return NotFound();
            }

            var currentUserId = this.userManager.GetUserId(User);
            if (currentUserId != null)
            {
                var currentUser = await this.userManager.FindByIdAsync(currentUserId);
                var isAdmin = await this.userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
                var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
                var isGroupManager = await this.context.UserGroups.AnyAsync(
                    ug =&gt; groupIds.Contains(ug.GroupId)
                          &amp;&amp; ug.UserId == int.Parse(currentUserId)
                          &amp;&amp; ug.Role == &quot;Manager&quot;);

                if (!(isAdmin || isGroupManager))
                {
                    return Forbid();
                }

                vm.StageForm.AvailableGroups = project.ProjectGroups
                    .Select(pg =&gt; new SelectListItem
                    {
                        Value = pg.Group.Id.ToString(),
                        Text = pg.Group.Name
                    })
                    .ToList();

                vm.CanAddStage = (isAdmin || isGroupManager);
                vm.Project = project;

                if (project.ProjectBoard == null)
                {
                    var newBoard = new ProjectBoard
                    {
                        ProjectId = project.Id,
                        BoardCreatorId = int.Parse(currentUserId),
                        Stages = new List&lt;Stage&gt;
                        {
                            new Stage
                            {
                                Name = &quot;To Do&quot;,
                                Position = 1,
                                CreatorUserId = int.Parse(currentUserId),
                            },
                            new Stage
                            {
                                Name = &quot;In Progress&quot;,
                                Position = 2,
                                CreatorUserId = int.Parse(currentUserId),
                            },
                            new Stage
                            {
                                Name = &quot;Done&quot;,
                                Position = 3,
                                CreatorUserId = int.Parse(currentUserId),
                            }
                        }
                    };
                    this.context.ProjectBoards.Add(newBoard);
                    await this.context.SaveChangesAsync();
                    project.ProjectBoard = newBoard;
                }

                var occupant = project.ProjectBoard.Stages
                    .FirstOrDefault(s =&gt; s.Position == vm.StageForm.Position);

                if (occupant != null)
                {
                    ModelState.AddModelError(&quot;StageForm.Position&quot;, &quot;This position is already taken by another stage.&quot;);
                }

                var duplicateStage = await this.context.Stages
                    .Include(s =&gt; s.ProjectBoard)
                    .FirstOrDefaultAsync(s =&gt; s.ProjectBoard.ProjectId == id &amp;&amp; s.Name == vm.StageForm.Name);

                if (!string.IsNullOrWhiteSpace(vm.StageForm.Name) &amp;&amp; duplicateStage != null)
                {
                    ModelState.AddModelError(&quot;StageForm.Name&quot;, &quot;A stage with this name already exists in this project.&quot;);
                }

                this.ForceProjectValid(ModelState);

                if (!ModelState.IsValid)
                {
                    return View(isAdmin ? &quot;~/Views/Admin/ProjectBoard.cshtml&quot; : &quot;~/Views/Employee/ProjectBoard.cshtml&quot;, vm);
                }
            }

            if (project.ProjectBoard != null)
            {
                if (currentUserId != null)
                {
                    var newStage = new Stage
                    {
                        Name = vm.StageForm.Name,
                        Position = vm.StageForm.Position,
                        ProjectBoardId = project.ProjectBoard.Id,
                        CreatorUserId = int.Parse(currentUserId),
                        AssignedGroupId = vm.StageForm.SelectedGroupId
                    };
                    this.context.Stages.Add(newStage);
                }
            }

            await this.context.SaveChangesAsync();

            return RedirectToAction(nameof(ProjectBoard), new { id });
        }


        /// &lt;summary&gt;
        /// Edits the stage. (GET)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stageId&quot;&gt;The stage identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpGet]
        public async Task&lt;IActionResult&gt; EditStage(int stageId)
        {
            var stage = await this.context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.Id == stageId);

            if (stage == null)
                return NotFound();

            var project = await this.context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .Include(p =&gt; p.ProjectBoard)
                .ThenInclude(b =&gt; b.Stages)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            if (project == null)
            {
                return NotFound();
            }

            var currentUserId = this.userManager.GetUserId(User);
            var currentUser = await this.userManager.FindByIdAsync(currentUserId);
            var isAdmin = await this.userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            var isProjectLead = project.ProjectLeadId == int.Parse(currentUserId);
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            var isGroupManager = await this.context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId) &amp;&amp; ug.UserId == int.Parse(currentUserId) &amp;&amp; ug.Role == &quot;Manager&quot;);

            if (!(isAdmin || isProjectLead || isGroupManager))
            {
                return Forbid();
            }

            var allStages = project.ProjectBoard?.Stages
                .OrderBy(s =&gt; s.Position)
                .ToList();

            var vm = new StageEditViewModel
            {
                StageId = stage.Id,
                ProjectId = project.Id,
                Name = stage.Name,
                Position = stage.Position,
                SelectedGroupId = stage.AssignedGroupId,
                AvailableGroups = project.ProjectGroups.Select(pg =&gt; new SelectListItem
                {
                    Value = pg.Group.Id.ToString(),
                    Text = pg.Group.Name
                }).ToList(),

                AllStages = allStages
            };

            return View(&quot;EditStage&quot;, vm);
        }

        /// &lt;summary&gt;
        /// Edits the stage. (POST)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;vm&quot;&gt;The vm.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; EditStage(StageEditViewModel vm)
        {
            var stage = await this.context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.Id == vm.StageId);

            if (stage == null)
            {
                return NotFound();
            }

            var project = await this.context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .Include(p =&gt; p.ProjectBoard)
                .ThenInclude(b =&gt; b.Stages)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            if (project == null)
            {
                return NotFound();
            }

            vm.AvailableGroups = project.ProjectGroups.Select(pg =&gt; new SelectListItem
            {
                Value = pg.Group.Id.ToString(),
                Text = pg.Group.Name
            }).ToList();

            vm.AllStages = project.ProjectBoard.Stages
                .OrderBy(s =&gt; s.Position)
                .ToList();

            vm.ProjectId = project.Id;

            var currentUserId = this.userManager.GetUserId(User);
            if (currentUserId != null)
            {
                var currentUser = await this.userManager.FindByIdAsync(currentUserId);
                var isAdmin = await this.userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
                var isProjectLead = project.ProjectLeadId == int.Parse(currentUserId);
                var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
                var isGroupManager = await this.context.UserGroups.AnyAsync(
                    ug =&gt; groupIds.Contains(ug.GroupId) &amp;&amp; ug.UserId == int.Parse(currentUserId) &amp;&amp; ug.Role == &quot;Manager&quot;);

                if (!(isAdmin || isProjectLead || isGroupManager))
                {
                    return Forbid();
                }
            }

            if (!ModelState.IsValid)
            {
                return View(&quot;EditStage&quot;, vm);
            }

            var nameExists = await this.context.Stages
                .AnyAsync(s =&gt; s.ProjectBoardId == stage.ProjectBoardId
                               &amp;&amp; s.Id != stage.Id
                               &amp;&amp; s.Name == vm.Name);
            if (nameExists)
            {
                ModelState.AddModelError(&quot;Name&quot;, &quot;A stage with this name already exists.&quot;);
                return View(&quot;EditStage&quot;, vm);
            }

            var occupant = await this.context.Stages
                .FirstOrDefaultAsync(s =&gt; s.ProjectBoardId == stage.ProjectBoardId
                                          &amp;&amp; s.Position == vm.Position
                                          &amp;&amp; s.Id != stage.Id);

            if (occupant != null)
            {
                var oldPosition = stage.Position;
                occupant.Position = oldPosition;
            }

            stage.Position = vm.Position;
            stage.Name = vm.Name;
            stage.AssignedGroupId = vm.SelectedGroupId;

            this.context.Stages.Update(stage);
            await this.context.SaveChangesAsync();

            return RedirectToAction(nameof(ProjectBoard), new { id = project.Id });
        }

        /// &lt;summary&gt;
        /// Deletes the stage.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stageId&quot;&gt;The stage identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; DeleteStage(int stageId)
        {
            var stage = await this.context.Stages
                .Include(s =&gt; s.ProjectBoard)
                .FirstOrDefaultAsync(s =&gt; s.Id == stageId);

            if (stage == null)
                return NotFound();

            var project = await this.context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .Include(p =&gt; p.ProjectBoard)
                .ThenInclude(b =&gt; b.Stages)
                .ThenInclude(s =&gt; s.AssignedGroup)
                .FirstOrDefaultAsync(p =&gt; p.ProjectBoard.Id == stage.ProjectBoardId);

            if (project == null)
            {
                return NotFound();
            }

            var currentUserId = this.userManager.GetUserId(User);
            var currentUser = await this.userManager.FindByIdAsync(currentUserId);
            var isAdmin = await this.userManager.IsInRoleAsync(currentUser, &quot;Admin&quot;);
            var isProjectLead = project.ProjectLeadId == int.Parse(currentUserId);
            var groupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            var isGroupManager = await this.context.UserGroups.AnyAsync(
                ug =&gt; groupIds.Contains(ug.GroupId) &amp;&amp; ug.UserId == int.Parse(currentUserId) &amp;&amp; ug.Role == &quot;Manager&quot;);
            var hasTasksInStage = await this.context.TaskStages
                .AnyAsync(ts =&gt; ts.StageId == stage.Id &amp;&amp; ts.CompletedDate == null);

            if (hasTasksInStage)
            {
                TempData[&quot;ErrorMessage&quot;] = &quot;This stage has active tasks, please remove all tasks from stage to delete&quot;;
                return RedirectToAction(nameof(EditStage), new { stageId = stage.Id });
            }

            if (!(isAdmin || isProjectLead || isGroupManager))
            {
                return Forbid();
            }

            this.context.Stages.Remove(stage);
            await this.context.SaveChangesAsync();

            return RedirectToAction(nameof(ProjectBoard), new { id = project.Id });
        }

        /// &lt;summary&gt;
        /// Forces the project valid.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;modelState&quot;&gt;State of the model.&lt;/param&gt;
        private void ForceProjectValid(ModelStateDictionary modelState)
        {
            if (modelState.TryGetValue(&quot;Project&quot;, out var entry))
            {
                if (entry != null &amp;&amp; entry.ValidationState == ModelValidationState.Invalid)
                {
                    entry.Errors.Clear();
                    entry.ValidationState = ModelValidationState.Valid;
                }
            }
        }

        /// &lt;summary&gt;
        /// Adds the task stages to stages.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;projectBoardId&quot;&gt;The project board identifier.&lt;/param&gt;
        private async Task addTaskStagesToStages(int projectBoardId)
        {
            var stages = await this.context.Stages
                .Where(s =&gt; s.ProjectBoardId == projectBoardId)  
                .Include(s =&gt; s.TaskStages)  
                .ToListAsync();

            foreach (var stage in stages)
            {
                var taskStages = await this.context.TaskStages
                    .Where(ts =&gt; ts.StageId == stage.Id)  
                    .ToListAsync();

                foreach (var taskStage in taskStages)
                {
                    TaskManagerData.Models.Task task = await this.context.Tasks
                        .FirstOrDefaultAsync(t =&gt; t.Id == taskStage.TaskId);
                    taskStage.Task = task;
                    stage.TaskStages.Add(taskStage);
                }
            }
        }

        /// &lt;summary&gt;
        /// Sets the available employees.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;isAdmin&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [is admin].&lt;/param&gt;
        /// &lt;param name=&quot;vm&quot;&gt;The vm.&lt;/param&gt;
        /// &lt;param name=&quot;project&quot;&gt;The project.&lt;/param&gt;
        /// &lt;param name=&quot;isGroupManager&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [is group manager].&lt;/param&gt;
        /// &lt;param name=&quot;currentUser&quot;&gt;The current user.&lt;/param&gt;
        private async Task setAvailableEmployees(bool isAdmin, CreateTaskViewModel vm, Project project,
            bool isGroupManager, User currentUser, Stage stage, bool isAssignedGroup)
        {
            if (isAssignedGroup)
            {
                var assignedUsers = this.context.UserGroups
                    .Where(ug =&gt; ug.GroupId == stage.AssignedGroup.Id)
                    .Select(ug =&gt; ug.User)
                    .ToList();

                if (!isAdmin &amp;&amp; !isGroupManager)
                {
                    vm.AvailableEmployees = new List&lt;SelectListItem&gt;
                    {
                        new() { Value = currentUser.Id.ToString(), Text = currentUser.UserName }
                    };
                }
                else
                {
                    vm.AvailableEmployees = assignedUsers
                        .Select(e =&gt; new SelectListItem
                        {
                            Value = e.Id.ToString(),
                            Text = e.UserName
                        })
                        .ToList();
                }
            }
            else
            {
                if (isAdmin)
                {
                    var employees = this.context.Users.ToList();
                    vm.AvailableEmployees = employees.Select(e =&gt; new SelectListItem
                    {
                        Value = e.Id.ToString(),
                        Text = e.UserName
                    }).ToList();
                }
                else if (isGroupManager)
                {
                    var managedGroups = project.ProjectGroups
                        .Where(pg =&gt; pg.Group.UserGroups
                            .Any(ug =&gt; ug.UserId == currentUser.Id &amp;&amp; ug.Role == &quot;Manager&quot;))
                        .ToList();

                    vm.AvailableEmployees = managedGroups
                        .SelectMany(pg =&gt; pg.Group.UserGroups)
                        .GroupBy(ug =&gt; ug.UserId)
                        .Select(g =&gt; g.First())
                        .Select(ug =&gt; new SelectListItem
                        {
                            Value = ug.UserId.ToString(),
                            Text = ug.User.UserName
                        })
                        .ToList();
                }
                else
                {
                    vm.AvailableEmployees = new List&lt;SelectListItem&gt;
                    {
                        new() { Value = currentUser.Id.ToString(), Text = currentUser.UserName }
                    };
                }
            }
        }


        /// &lt;summary&gt;
        /// Sets the view bag managed users.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;isGroupManager&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [is group manager].&lt;/param&gt;
        /// &lt;param name=&quot;currentUser&quot;&gt;The current user.&lt;/param&gt;
        /// &lt;param name=&quot;project&quot;&gt;The project.&lt;/param&gt;
        private async Task setViewBagManagedUsers(bool isGroupManager, User currentUser, Project project)
        {
            if (isGroupManager)
            {
                var managedGroupIds = await this.context.UserGroups
                    .Where(ug =&gt; ug.UserId == currentUser.Id &amp;&amp; ug.Role == &quot;Manager&quot;)
                    .Select(ug =&gt; ug.GroupId)
                    .ToListAsync();

                var managedGroupProjects = project.ProjectGroups
                    .Where(pg =&gt; managedGroupIds.Contains(pg.GroupId))
                    .ToList();
                var managedGroups = project.ProjectGroups
                    .Where(pg =&gt; managedGroupIds.Contains(pg.GroupId))
                    .ToList();

                var managedUsers = this.context.UserGroups
                    .Where(ug =&gt; managedGroupIds.Contains(ug.GroupId))
                    .Select(ug =&gt; ug.User)
                    .Distinct()
                    .ToList();

                ViewBag.ManagedUsers = managedUsers;
            }
        }

        private async Task&lt;User&gt; GetCurrentUserAsync()
        {
            return await this.userManager.GetUserAsync(User);
        }


    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,94,1],[34,9,34,10,1],[35,13,35,36,1],[36,13,36,44,1],[37,9,37,10,1],[45,9,45,10,1],[46,13,48,66,1],[50,13,52,70,1],[54,13,54,31,1],[55,17,55,35,1],[57,13,64,86,1],[66,13,66,33,1],[67,17,67,35,0],[69,13,69,123,1],[70,13,70,117,1],[71,13,71,123,1],[72,13,72,105,1],[74,13,74,51,1],[76,13,76,84,1],[77,9,77,10,1],[86,9,86,10,1],[87,13,89,60,1],[91,13,91,31,1],[92,13,92,14,1],[93,17,93,35,1],[96,13,103,86,1],[105,13,105,33,1],[106,13,106,14,1],[107,17,107,35,1],[110,13,110,44,1],[112,13,112,66,1],[114,13,114,63,1],[115,13,115,118,1],[116,13,116,87,1],[117,13,117,63,1],[117,63,117,73,1],[117,73,117,84,1],[118,13,121,48,1],[123,13,123,121,1],[125,13,125,43,1],[126,9,126,10,1],[136,9,136,10,1],[137,13,137,37,1],[138,13,138,14,1],[139,17,139,33,1],[142,13,144,63,1],[146,13,146,31,1],[147,13,147,14,1],[148,17,148,35,1],[151,13,151,58,1],[153,13,156,51,1],[158,13,158,33,1],[159,13,159,14,1],[160,17,160,107,1],[161,17,161,33,1],[164,13,164,86,1],[165,13,165,80,1],[167,13,173,15,1],[175,13,175,42,1],[176,13,176,51,1],[178,13,184,16,1],[186,13,196,15,1],[198,13,198,52,1],[200,13,200,47,1],[201,13,201,14,1],[202,17,202,113,1],[204,17,212,19,1],[214,17,214,62,1],[216,17,222,20,1],[223,13,223,14,1],[225,13,225,51,1],[227,13,227,45,1],[229,13,236,86,1],[238,13,238,84,1],[239,9,239,10,1],[250,9,250,10,1],[251,13,251,70,1],[252,13,252,80,1],[254,13,254,67,1],[255,13,255,30,1],[256,17,256,35,0],[258,13,259,125,1],[261,13,261,42,1],[262,13,262,14,1],[263,17,263,63,1],[264,17,264,60,1],[265,13,265,14,1],[267,13,267,128,1],[269,13,276,15,1],[278,13,278,55,1],[280,13,286,16,1],[288,13,289,49,1],[292,13,292,77,1],[293,13,293,14,0],[294,17,294,70,0],[295,17,298,44,0],[299,17,302,36,0],[305,17,305,65,0],[306,17,306,18,0],[307,21,308,73,0],[310,21,310,69,0],[312,17,312,18,0],[313,13,313,14,0],[315,13,315,51,1],[317,13,317,68,1],[318,13,318,83,1],[319,9,319,10,1],[329,9,329,10,1],[330,13,333,59,1],[335,13,335,30,1],[336,13,336,14,1],[337,17,337,35,1],[340,13,349,93,1],[351,13,351,67,1],[353,13,353,33,1],[354,13,354,14,1],[355,17,355,35,1],[358,13,358,102,1],[359,13,359,109,1],[360,13,360,63,1],[360,63,360,73,1],[360,73,360,84,1],[361,13,364,48,1],[366,13,369,66,1],[371,13,371,73,1],[373,13,373,80,1],[374,17,374,33,1],[376,13,380,32,1],[382,13,386,32,1],[388,13,396,15,1],[398,13,398,43,1],[399,13,399,14,1],[400,17,400,157,1],[401,13,401,14,1],[402,18,402,36,0],[403,13,403,14,0],[404,17,407,11,0],[408,13,408,14,0],[410,13,410,44,1],[412,13,412,41,1],[413,9,413,10,1],[423,9,423,10,1],[424,13,424,37,1],[425,17,425,33,1],[427,13,427,70,1],[428,13,428,80,1],[430,13,435,40,1],[437,13,440,72,1],[441,13,441,28,1],[442,13,442,14,1],[443,17,443,91,1],[444,17,444,33,1],[447,13,449,62,1],[451,13,451,30,1],[452,17,452,35,1],[454,13,454,38,1],[455,13,455,14,1],[456,17,462,20,1],[463,17,463,37,1],[464,13,464,14,1],[466,13,466,52,1],[467,13,467,14,1],[468,17,474,20,1],[475,17,475,51,1],[476,13,476,14,1],[478,13,478,73,1],[479,13,479,100,1],[480,13,480,14,0],[481,17,481,70,0],[482,13,482,14,0],[484,13,484,135,1],[485,13,485,14,0],[486,17,486,109,0],[487,17,494,19,0],[495,17,495,63,0],[497,17,503,20,0],[504,13,504,14,0],[506,13,506,51,1],[508,13,513,40,1],[515,13,515,83,1],[516,9,516,10,1],[526,9,526,10,1],[527,13,527,58,1],[528,13,528,14,1],[529,17,529,84,1],[530,17,534,36,1],[535,17,535,45,1],[538,13,538,70,1],[540,13,546,15,1],[548,13,548,48,1],[549,13,549,51,1],[551,13,551,77,1],[552,9,552,10,1],[563,9,563,10,1],[564,13,564,70,1],[566,13,573,15,1],[575,13,575,46,1],[576,13,576,51,1],[578,13,578,74,1],[579,9,579,10,1],[588,9,588,10,1],[589,13,595,55,1],[597,13,597,33,1],[598,17,598,35,1],[600,13,600,46,1],[601,13,601,14,1],[602,17,602,70,1],[603,17,603,43,1],[604,17,604,18,1],[605,21,630,23,1],[631,21,631,62,1],[632,17,632,18,1],[634,17,634,55,1],[636,17,642,59,1],[643,13,643,14,1],[645,13,647,70,1],[647,70,651,18,0],[651,18,652,15,1],[654,13,658,15,1],[660,13,660,102,1],[661,13,661,86,1],[662,13,662,63,1],[662,63,662,73,0],[662,73,662,84,1],[663,13,666,48,1],[667,13,670,100,1],[672,13,672,58,1],[673,13,673,43,1],[675,13,678,27,1],[680,13,681,34,1],[681,34,686,18,1],[686,18,687,27,1],[689,13,689,67,1],[691,13,691,85,1],[693,13,693,71,1],[695,13,695,25,1],[696,13,696,14,1],[697,17,697,70,1],[700,13,700,14,1],[701,17,701,73,1],[703,9,703,10,1],[715,9,715,10,1],[716,13,722,55,1],[724,13,724,33,1],[725,13,725,14,1],[726,17,726,35,1],[729,13,729,66,1],[730,13,730,39,1],[731,13,731,14,1],[732,17,732,87,1],[733,17,733,90,1],[734,17,734,67,1],[734,67,734,77,1],[734,77,734,88,1],[735,17,738,52,1],[740,17,740,50,1],[741,17,741,18,1],[742,21,742,37,1],[745,17,746,35,1],[746,35,750,22,1],[750,22,751,31,1],[753,17,753,62,1],[754,17,754,38,1],[756,17,756,50,1],[757,17,757,18,0],[758,21,783,23,0],[784,21,784,62,0],[785,21,785,59,0],[786,21,786,53,0],[787,17,787,18,0],[789,17,790,42,1],[790,42,790,77,1],[790,77,790,79,1],[792,17,792,38,1],[793,17,793,18,1],[794,21,794,120,1],[795,17,795,18,1],[797,17,799,110,1],[801,17,801,93,1],[802,17,802,18,1],[803,21,803,122,1],[804,17,804,18,1],[806,17,806,52,1],[808,17,808,41,1],[809,17,809,18,1],[810,21,810,125,1],[812,13,812,14,1],[814,13,814,46,1],[815,13,815,14,1],[816,17,816,43,1],[817,17,817,18,1],[818,21,825,23,1],[826,21,826,55,1],[827,17,827,18,1],[828,13,828,14,1],[830,13,830,51,1],[832,13,832,71,1],[833,9,833,10,1],[843,9,843,10,1],[844,13,846,60,1],[848,13,848,31,1],[849,17,849,35,1],[851,13,857,86,1],[859,13,859,33,1],[860,13,860,14,1],[861,17,861,35,1],[864,13,864,66,1],[865,13,865,83,1],[866,13,866,86,1],[867,13,867,83,1],[868,13,868,63,1],[868,63,868,73,1],[868,73,868,84,1],[869,13,870,119,1],[872,13,872,63,1],[873,13,873,14,0],[874,17,874,33,0],[877,13,878,31,1],[878,31,878,41,1],[878,41,879,27,1],[881,13,888,70,1],[888,70,892,18,1],[892,18,895,15,1],[897,13,897,42,1],[898,9,898,10,1],[908,9,908,10,1],[909,13,911,63,1],[913,13,913,31,1],[914,13,914,14,1],[915,17,915,35,1],[918,13,924,86,1],[926,13,926,33,1],[927,13,927,14,1],[928,17,928,35,1],[931,13,931,69,1],[931,69,935,14,1],[935,14,935,25,1],[937,13,938,31,1],[938,31,938,41,1],[938,41,939,27,1],[941,13,941,39,1],[943,13,943,66,1],[944,13,944,39,1],[945,13,945,14,1],[946,17,946,87,1],[947,17,947,90,1],[948,17,948,87,1],[949,17,949,67,1],[949,67,949,77,1],[949,77,949,88,1],[950,17,951,123,1],[953,17,953,67,1],[954,17,954,18,1],[955,21,955,37,1],[957,13,957,14,1],[959,13,959,37,1],[960,13,960,14,1],[961,17,961,46,1],[964,13,967,54,1],[968,13,968,28,1],[969,13,969,14,1],[970,17,970,92,1],[971,17,971,46,1],[974,13,977,64,1],[979,13,979,34,1],[980,13,980,14,1],[981,17,981,50,1],[982,17,982,49,1],[983,13,983,14,1],[985,13,985,42,1],[986,13,986,34,1],[987,13,987,56,1],[989,13,989,47,1],[990,13,990,51,1],[992,13,992,84,1],[993,9,993,10,1],[1003,9,1003,10,1],[1004,13,1006,60,1],[1008,13,1008,31,1],[1009,17,1009,35,1],[1011,13,1017,86,1],[1019,13,1019,33,1],[1020,13,1020,14,1],[1021,17,1021,35,1],[1024,13,1024,66,1],[1025,13,1025,83,1],[1026,13,1026,86,1],[1027,13,1027,83,1],[1028,13,1028,63,1],[1028,63,1028,73,1],[1028,73,1028,84,1],[1029,13,1030,119,1],[1031,13,1032,85,1],[1034,13,1034,33,1],[1035,13,1035,14,0],[1036,17,1036,120,0],[1037,17,1037,88,0],[1040,13,1040,63,1],[1041,13,1041,14,1],[1042,17,1042,33,1],[1045,13,1045,47,1],[1046,13,1046,51,1],[1048,13,1048,84,1],[1049,9,1049,10,1],[1056,9,1056,10,1],[1057,13,1057,66,1],[1058,13,1058,14,0],[1059,17,1059,92,0],[1060,17,1060,18,0],[1061,21,1061,42,0],[1062,21,1062,72,0],[1063,17,1063,18,0],[1064,13,1064,14,0],[1065,9,1065,10,1],[1072,9,1072,10,1],[1073,13,1076,32,1],[1078,13,1078,20,1],[1078,22,1078,31,1],[1078,32,1078,34,1],[1078,35,1078,41,1],[1079,13,1079,14,1],[1080,17,1082,36,1],[1084,17,1084,24,1],[1084,26,1084,39,0],[1084,40,1084,42,1],[1084,43,1084,53,1],[1085,17,1085,18,0],[1086,21,1087,77,0],[1088,21,1088,43,0],[1089,21,1089,53,0],[1090,17,1090,18,0],[1091,13,1091,14,1],[1092,9,1092,10,1],[1104,9,1104,10,1],[1105,13,1105,33,1],[1106,13,1106,14,1],[1107,17,1110,31,1],[1112,17,1112,49,1],[1113,17,1113,18,0],[1114,21,1117,23,0],[1118,17,1118,18,0],[1120,17,1120,18,1],[1121,21,1122,38,1],[1122,38,1126,26,1],[1126,26,1127,35,1],[1128,17,1128,18,1],[1129,13,1129,14,1],[1131,13,1131,14,1],[1132,17,1132,29,1],[1133,17,1133,18,1],[1134,21,1134,65,1],[1135,21,1135,67,1],[1135,67,1139,22,1],[1139,22,1139,33,1],[1140,17,1140,18,1],[1141,22,1141,41,1],[1142,17,1142,18,1],[1143,21,1144,38,1],[1144,38,1145,40,1],[1145,40,1145,91,1],[1145,91,1145,92,1],[1145,92,1146,35,1],[1148,21,1149,43,1],[1149,43,1149,62,1],[1149,62,1150,40,1],[1150,40,1150,49,1],[1150,49,1151,38,1],[1151,38,1151,47,1],[1151,47,1152,39,1],[1152,39,1156,26,1],[1156,26,1157,35,1],[1158,17,1158,18,1],[1160,17,1160,18,1],[1161,21,1164,23,1],[1165,17,1165,18,1],[1166,13,1166,14,1],[1167,9,1167,10,1],[1177,9,1177,10,1],[1178,13,1178,32,1],[1179,13,1179,14,0],[1180,17,1183,36,0],[1185,17,1186,34,0],[1186,34,1186,70,0],[1186,70,1187,31,0],[1188,17,1189,34,0],[1189,34,1189,70,0],[1189,70,1190,31,0],[1192,17,1196,31,0],[1198,17,1198,53,0],[1199,13,1199,14,0],[1200,9,1200,10,1],[1203,9,1203,10,0],[1204,13,1204,62,0],[1205,9,1205,10,0]]);
    </script>
  </body>
</html>