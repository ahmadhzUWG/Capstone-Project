<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Nick\Desktop\Capstone-Project\code\TaskManager.Tests\Tests\TestControllers\ProjectControllerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Security.Claims;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using Moq;
using TaskManagerWebsite.Controllers;
using TaskManagerWebsite.Data;
using TaskManagerWebsite.Models;
using TaskManagerWebsite.ViewModels.ProjectViewModels;
using Task = System.Threading.Tasks.Task;
using Microsoft.AspNetCore.Mvc.ModelBinding;

namespace TaskManager.Tests.Tests
{
    public class ProjectControllerTests
    {
        private ApplicationDbContext CreateContext(string dbName)
        {
            var options = new DbContextOptionsBuilder&lt;ApplicationDbContext&gt;()
                .UseInMemoryDatabase(dbName)
                .Options;
            return new ApplicationDbContext(options);
        }

        private UserManager&lt;User&gt; CreateUserManager(User user, bool isAdmin)
        {
            var store = new Mock&lt;IUserStore&lt;User&gt;&gt;();
            var mockUM = new Mock&lt;UserManager&lt;User&gt;&gt;(store.Object, null, null, null, null, null, null, null, null);
            mockUM.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(user.Id.ToString());
            mockUM.Setup(um =&gt; um.FindByIdAsync(It.IsAny&lt;string&gt;())).ReturnsAsync(user);
            mockUM.Setup(um =&gt; um.IsInRoleAsync(It.IsAny&lt;User&gt;(), &quot;Admin&quot;)).ReturnsAsync(isAdmin);
            mockUM.Setup(um =&gt; um.GetUserAsync(It.IsAny&lt;ClaimsPrincipal&gt;())).ReturnsAsync(user); // &lt;--- Add this line
            return mockUM.Object;
        }


        private ControllerContext CreateControllerContext(User user)
        {
            var identity = new ClaimsIdentity(new Claim[]
            {
                new Claim(ClaimTypes.NameIdentifier, user.Id.ToString())
            }, &quot;TestAuth&quot;);
            return new ControllerContext
                { HttpContext = new DefaultHttpContext { User = new ClaimsPrincipal(identity) } };
        }

        // GET: ProjectBoard

        [Fact]
        public async Task ProjectBoard_Get_ReturnsNotFound_IfProjectMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };

            var result = await controller.ProjectBoard(999);
            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task ProjectBoard_Get_CreatesBoard_IfMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var proj = new Project
            {
                Id = 1,
                Name = &quot;P1&quot;,
                Description = &quot;D1&quot;,
                ProjectLeadId = 1,
                ProjectGroups = new List&lt;GroupProject&gt;()
            };
            context.Projects.Add(proj);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };

            await controller.ProjectBoard(1);
            var updated = await context.Projects.Include(p =&gt; p.ProjectBoard).FirstOrDefaultAsync(p =&gt; p.Id == 1);
            Assert.NotNull(updated.ProjectBoard);
        }

        [Fact]
        public async Task ProjectBoard_Get_ReturnsAdminView_IfAdmin()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var proj = new Project
            {
                Id = 2,
                Name = &quot;P2&quot;,
                Description = &quot;D2&quot;,
                ProjectLeadId = 2,
                ProjectGroups = new List&lt;GroupProject&gt;()
            };
            proj.ProjectBoard = new ProjectBoard
                { Id = 10, ProjectId = 2, BoardCreatorId = 2, Stages = new List&lt;Stage&gt;() };
            context.Projects.Add(proj);
            await context.SaveChangesAsync();

            var user = new User { Id = 2, UserName = &quot;admin&quot; };
            var um = CreateUserManager(user, true);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };

            var result = await controller.ProjectBoard(2) as ViewResult;
            Assert.Equal(&quot;~/Views/Admin/ProjectBoard.cshtml&quot;, result?.ViewName);
        }

        // POST: ProjectBoard

        [Fact]
        public async Task ProjectBoard_Post_ReturnsNotFound_IfProjectMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };

            var vm = new ProjectBoardViewModel();
            var result = await controller.ProjectBoard(999, vm);
            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task ProjectBoard_Post_ReturnsForbid_IfUnauthorized()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var proj = new Project
            {
                Id = 4,
                Name = &quot;P4&quot;,
                Description = &quot;D4&quot;,
                ProjectLeadId = 2,
                ProjectGroups = new List&lt;GroupProject&gt;()
            };
            proj.ProjectBoard = new ProjectBoard
                { Id = 20, ProjectId = 4, BoardCreatorId = 2, Stages = new List&lt;Stage&gt;() };
            context.Projects.Add(proj);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };

            var vm = new ProjectBoardViewModel
                { StageForm = new CreateStageViewModel { Name = &quot;S1&quot;, Position = 1, SelectedGroupId = 0 } };
            var result = await controller.ProjectBoard(4, vm);
            Assert.IsType&lt;ForbidResult&gt;(result);
        }

        [Fact]
        public async Task ProjectBoard_Post_ReturnsView_IfModelStateInvalid()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var proj = new Project
            {
                Id = 5,
                Name = &quot;P5&quot;,
                Description = &quot;D5&quot;,
                ProjectLeadId = 1,
                ProjectGroups = new List&lt;GroupProject&gt;()
            };
            proj.ProjectBoard = new ProjectBoard
                { Id = 30, ProjectId = 5, BoardCreatorId = 1, Stages = new List&lt;Stage&gt;() };
            context.Projects.Add(proj);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;lead&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            controller.ModelState.AddModelError(&quot;Error&quot;, &quot;Invalid&quot;);

            var vm = new ProjectBoardViewModel
                { StageForm = new CreateStageViewModel { Name = &quot;S1&quot;, Position = 1, SelectedGroupId = 0 } };
            var result = await controller.ProjectBoard(5, vm) as ViewResult;
            var model = result.Model as ProjectBoardViewModel;
            Assert.NotNull(model);
            Assert.Equal(5, model.Project.Id);
        }

        [Fact]
        public async Task ProjectBoard_Post_ReturnsView_IfDuplicateStageExists()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var grp = new Group { Id = 1, Name = &quot;G1&quot;, Description = &quot;Test&quot; };
            var proj = new Project
            {
                Id = 6,
                Name = &quot;P6&quot;,
                Description = &quot;D6&quot;,
                ProjectLeadId = 1,
                ProjectGroups = new List&lt;GroupProject&gt; { new GroupProject { Group = grp, GroupId = grp.Id } }
            };
            proj.ProjectBoard = new ProjectBoard
                { Id = 40, ProjectId = 6, BoardCreatorId = 1, Stages = new List&lt;Stage&gt;() };
            context.Projects.Add(proj);
            context.Stages.Add(new Stage
            {
                Id = 100,
                Name = &quot;Duplicate&quot;,
                Position = 1,
                ProjectBoardId = 40,
                AssignedGroup = grp
            });
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;lead&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };

            var vm = new ProjectBoardViewModel
                { StageForm = new CreateStageViewModel { Name = &quot;Duplicate&quot;, Position = 2, SelectedGroupId = grp.Id } };
            var result = await controller.ProjectBoard(6, vm) as ViewResult;
            Assert.NotNull(result);
            Assert.True(controller.ModelState.ErrorCount &gt; 0);
        }

        [Fact]
        public async Task ProjectBoard_Post_AddsStage_IfValid()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var grp = new Group { Id = 2, Name = &quot;G2&quot;, Description = &quot;Test&quot; };
            var proj = new Project
            {
                Id = 7,
                Name = &quot;P7&quot;,
                Description = &quot;D7&quot;,
                ProjectLeadId = 1,
                ProjectGroups = new List&lt;GroupProject&gt; { new GroupProject { Group = grp, GroupId = grp.Id } }
            };
            proj.ProjectBoard = new ProjectBoard
                { Id = 50, ProjectId = 7, BoardCreatorId = 1, Stages = new List&lt;Stage&gt;() };
            context.Projects.Add(proj);
            await context.SaveChangesAsync();
            context.UserGroups.Add(new UserGroup { UserId = 1, GroupId = grp.Id, Role = &quot;Manager&quot; });
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };

            var vm = new ProjectBoardViewModel
                { StageForm = new CreateStageViewModel { Name = &quot;NewStage&quot;, Position = 1, SelectedGroupId = grp.Id } };
            var result = await controller.ProjectBoard(7, vm) as RedirectToActionResult;
            Assert.Equal(nameof(ProjectController.ProjectBoard), result.ActionName);
            var stage = await context.Stages.FirstOrDefaultAsync(s =&gt; s.Name == &quot;NewStage&quot;);
            Assert.NotNull(stage);
        }

        // GET: EditStage

        [Fact]
        public async Task EditStage_Get_ReturnsNotFound_IfStageMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            var result = await controller.EditStage(999);
            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task EditStage_Get_ReturnsNotFound_IfProjectMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var board = new ProjectBoard { Id = 60, ProjectId = 100, Stages = new List&lt;Stage&gt;() };
            var stage = new Stage
            {
                Id = 200, ProjectBoard = board, Position = 1, Name = &quot;S&quot;,
                AssignedGroup = new Group { Id = 1, Name = &quot;Dummy&quot;, Description = &quot;Dummy&quot; }
            };
            context.Stages.Add(stage);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            var result = await controller.EditStage(200);
            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task EditStage_Get_ReturnsView_IfValid()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var grp = new Group { Id = 3, Name = &quot;G3&quot;, Description = &quot;Test&quot; };
            var proj = new Project
            {
                Id = 8,
                Name = &quot;P8&quot;,
                Description = &quot;D8&quot;,
                ProjectLeadId = 1,
                ProjectGroups = new List&lt;GroupProject&gt; { new GroupProject { Group = grp, GroupId = grp.Id } }
            };
            var board = new ProjectBoard { Id = 70, ProjectId = 8, BoardCreatorId = 1, Stages = new List&lt;Stage&gt;() };
            proj.ProjectBoard = board;
            var stage = new Stage
            {
                Id = 300, ProjectBoard = board, Position = 1, Name = &quot;EditStage&quot;, AssignedGroup = grp,
                AssignedGroupId = grp.Id
            };
            board.Stages = new List&lt;Stage&gt; { stage };
            context.Projects.Add(proj);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };

            var result = await controller.EditStage(300) as ViewResult;
            var vm = result.Model as StageEditViewModel;
            Assert.NotNull(vm);
            Assert.Equal(300, vm.StageId);
        }

        // POST: EditStage

        [Fact]
        public async Task EditStage_Post_ReturnsNotFound_IfStageMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            var vm = new StageEditViewModel { StageId = 999 };
            var result = await controller.EditStage(vm);
            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task EditStage_Post_ReturnsNotFound_IfProjectMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var board = new ProjectBoard { Id = 80, ProjectId = 500, Stages = new List&lt;Stage&gt;() };
            var stage = new Stage
            {
                Id = 400, ProjectBoard = board, Position = 1, Name = &quot;S&quot;,
                AssignedGroup = new Group { Id = 1, Name = &quot;Dummy&quot;, Description = &quot;Dummy&quot; }
            };
            context.Stages.Add(stage);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            var vm = new StageEditViewModel { StageId = 400, Name = &quot;Updated&quot; };
            var result = await controller.EditStage(vm);
            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task EditStage_Post_ReturnsForbid_IfUnauthorized()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var proj = new Project
            {
                Id = 9, Name = &quot;P9&quot;, Description = &quot;D9&quot;, ProjectLeadId = 2, ProjectGroups = new List&lt;GroupProject&gt;()
            };
            var board = new ProjectBoard { Id = 90, ProjectId = 9, BoardCreatorId = 2, Stages = new List&lt;Stage&gt;() };
            proj.ProjectBoard = board;
            context.Projects.Add(proj);
            var stage = new Stage
            {
                Id = 500, ProjectBoard = board, Position = 1, Name = &quot;S&quot;,
                AssignedGroup = new Group { Id = 1, Name = &quot;Dummy&quot;, Description = &quot;Dummy&quot; }
            };
            context.Stages.Add(stage);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            var vm = new StageEditViewModel { StageId = 500, Name = &quot;Updated&quot;, Position = 2, SelectedGroupId = 0 };
            var result = await controller.EditStage(vm);
            Assert.IsType&lt;ForbidResult&gt;(result);
        }

        [Fact]
        public async Task EditStage_Post_ReturnsView_IfModelStateInvalid()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var grp = new Group { Id = 10, Name = &quot;G10&quot;, Description = &quot;Test&quot; };
            var proj = new Project
            {
                Id = 10, Name = &quot;P10&quot;, Description = &quot;D10&quot;, ProjectLeadId = 1,
                ProjectGroups = new List&lt;GroupProject&gt; { new GroupProject { Group = grp, GroupId = grp.Id } }
            };
            var board = new ProjectBoard { Id = 100, ProjectId = 10, BoardCreatorId = 1, Stages = new List&lt;Stage&gt;() };
            proj.ProjectBoard = board;
            var stage = new Stage { Id = 600, ProjectBoard = board, Position = 1, Name = &quot;S&quot;, AssignedGroup = grp };
            board.Stages = new List&lt;Stage&gt; { stage };
            context.Projects.Add(proj);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            controller.ModelState.AddModelError(&quot;Error&quot;, &quot;Invalid&quot;);
            var vm = new StageEditViewModel { StageId = 600, Name = &quot;Updated&quot;, Position = 2, SelectedGroupId = grp.Id };
            var result = await controller.EditStage(vm) as ViewResult;
            Assert.NotNull(result);
        }

        [Fact]
        public async Task EditStage_Post_ReturnsView_IfDuplicateStageNameExists()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var grp = new Group { Id = 11, Name = &quot;G11&quot;, Description = &quot;Test&quot; };
            var proj = new Project
            {
                Id = 11, Name = &quot;P11&quot;, Description = &quot;D11&quot;, ProjectLeadId = 1,
                ProjectGroups = new List&lt;GroupProject&gt; { new GroupProject { Group = grp, GroupId = grp.Id } }
            };
            var board = new ProjectBoard { Id = 110, ProjectId = 11, BoardCreatorId = 1, Stages = new List&lt;Stage&gt;() };
            proj.ProjectBoard = board;

            context.Stages.Add(new Stage
                { Id = 700, Name = &quot;Duplicate&quot;, Position = 1, ProjectBoardId = 110, AssignedGroup = grp });
            var stage = new Stage
                { Id = 800, ProjectBoard = board, Position = 2, Name = &quot;Original&quot;, AssignedGroup = grp };
            board.Stages = new List&lt;Stage&gt; { stage };
            context.Stages.Add(stage);
            context.Projects.Add(proj);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            var vm = new StageEditViewModel
                { StageId = 800, Name = &quot;Duplicate&quot;, Position = 3, SelectedGroupId = grp.Id };
            var result = await controller.EditStage(vm) as ViewResult;
            Assert.NotNull(result);
            Assert.True(controller.ModelState.ErrorCount &gt; 0);
        }

        [Fact]
        public async Task EditStage_Post_UpdatesStage_IfValid()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var grp = new Group { Id = 12, Name = &quot;G12&quot;, Description = &quot;Test&quot; };
            var proj = new Project
            {
                Id = 12, Name = &quot;P12&quot;, Description = &quot;D12&quot;, ProjectLeadId = 1,
                ProjectGroups = new List&lt;GroupProject&gt; { new GroupProject { Group = grp, GroupId = grp.Id } }
            };
            var board = new ProjectBoard { Id = 120, ProjectId = 12, BoardCreatorId = 1, Stages = new List&lt;Stage&gt;() };
            proj.ProjectBoard = board;
            var s1 = new Stage { Id = 900, ProjectBoard = board, Position = 1, Name = &quot;S1&quot;, AssignedGroup = grp };
            var s2 = new Stage { Id = 901, ProjectBoard = board, Position = 2, Name = &quot;S2&quot;, AssignedGroup = grp };
            board.Stages = new List&lt;Stage&gt; { s1, s2 };
            context.Projects.Add(proj);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            var vm = new StageEditViewModel
                { StageId = 901, Name = &quot;S2 Updated&quot;, Position = 1, SelectedGroupId = grp.Id };
            var result = await controller.EditStage(vm) as RedirectToActionResult;
            Assert.Equal(nameof(ProjectController.ProjectBoard), result.ActionName);
            var updated = await context.Stages.FindAsync(901);
            Assert.Equal(&quot;S2 Updated&quot;, updated.Name);
            Assert.Equal(1, updated.Position);
            var swapped = await context.Stages.FindAsync(900);
            Assert.Equal(2, swapped.Position);
        }


        [Fact]
        public async Task EditTask_Get_TaskNotFound_ReturnsNotFound()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1, UserName = &quot;user&quot; };

            var controller = new ProjectController(context, this.CreateUserManager(user, false));

            var result = await controller.EditTask(taskId: 999);

            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task EditTask_Get_ProjectNotFound_ReturnsNotFound()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            context.Tasks.Add(new TaskManagerWebsite.Models.Task { Id = 1, Name = &quot;Test&quot;, Description = &quot;Test Task&quot; });
            await context.SaveChangesAsync();
            var user = new User { Id = 1, UserName = &quot;user&quot; };

            var controller = new ProjectController(context, this.CreateUserManager(user, false));

            var result = await controller.EditTask(1);

            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task EditTask_Get_UserNotAuthorized_ReturnsForbid()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var task = new TaskManagerWebsite.Models.Task { Id = 1, Name = &quot;Task&quot;, Description = &quot;Test Description&quot; };
            var project = new Project { Id = 1, ProjectLeadId = 999, Name = &quot;Task&quot;, Description = &quot;Test Description&quot; };
            var board = new ProjectBoard { Id = 1, Project = project };
            var stage = new Stage { Id = 1, ProjectBoard = board, Name = &quot;Test Stage&quot; };
            var taskStage = new TaskStage { Id = 1, TaskId = 1, Stage = stage, Task = task };

            context.Tasks.Add(task);
            context.Projects.Add(project);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            context.TaskStages.Add(taskStage);
            await context.SaveChangesAsync();

            var userManager = this.CreateUserManager(new User { Id = 1, UserName = &quot;test&quot; }, false);
            var controller = new ProjectController(context, userManager);

            var result = await controller.EditTask(1);

            Assert.IsType&lt;ForbidResult&gt;(result);
        }

        [Fact]
        public async Task EditTask_Get_Valid_ReturnsViewWithModel()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());

            // Arrange
            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var group = new Group { Id = 1, Name = &quot;G1&quot;, Description = &quot;test&quot; };
            var userGroup = new UserGroup { UserId = 1, GroupId = 1, Role = &quot;Member&quot;, User = user, Group = group };

            var project = new Project { Id = 1, ProjectLeadId = 1, Name = &quot;Test Project&quot;, Description = &quot;Desc&quot; };
            var projectGroup = new GroupProject { GroupId = 1, ProjectId = 1, Group = group, Project = project };

            var board = new ProjectBoard { Id = 1, ProjectId = 1, Project = project };
            var stage = new Stage { Id = 1, Name = &quot;Stage&quot;, ProjectBoard = board, AssignedGroupId = 1, AssignedGroup = group };

            var task = new TaskManagerWebsite.Models.Task
            {
                Id = 2,
                Name = &quot;My Task&quot;,
                Description = &quot;Desc&quot;,
                CreatorUserId = 1,
                CreatorUser = user
            };

            var taskStage = new TaskStage
            {
                Id = 1,
                TaskId = task.Id,
                Task = task,
                StageId = 1,
                Stage = stage
            };

            var assignment = new TaskEmployee { TaskId = 2, EmployeeId = 1, Employee = user };

            context.Users.Add(user);
            context.Groups.Add(group);
            context.UserGroups.Add(userGroup);
            context.Projects.Add(project);
            context.GroupProjects.Add(projectGroup);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            context.Tasks.Add(task);
            context.TaskStages.Add(taskStage);
            context.TaskEmployees.Add(assignment);
            await context.SaveChangesAsync();

            var userManager = CreateUserManager(user, isAdmin: true);
            var controller = new ProjectController(context, userManager);

            // Act
            var result = await controller.EditTask(task.Id);

            // Assert
            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
            var model = Assert.IsType&lt;CreateTaskViewModel&gt;(viewResult.Model);
            Assert.Equal(&quot;My Task&quot;, model.Name);
        }



        [Fact]
        public async Task EditTask_Post_InvalidModel_ReturnsView()
        {
            using var context = CreateContext(nameof(EditTask_Post_InvalidModel_ReturnsView));
            var user = new User { Id = 1, UserName = &quot;user&quot; };

            var controller = new ProjectController(context, CreateUserManager(user, false));
            controller.ModelState.AddModelError(&quot;Name&quot;, &quot;Required&quot;);

            var vm = new CreateTaskViewModel { TaskId = 1 };

            var result = await controller.EditTask(vm);

            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
            var model = Assert.IsAssignableFrom&lt;CreateTaskViewModel&gt;(viewResult.Model);
        }

        [Fact]
        public async Task EditTask_Post_DuplicateName_ReturnsModelError()
        {
            using var context = CreateContext(nameof(EditTask_Post_DuplicateName_ReturnsModelError));

            var user = new User { Id = 1 };
            var project = new Project
                { Id = 1, ProjectLeadId = user.Id, Name = &quot;Test Project&quot;, Description = &quot;Test Description&quot; };
            var board = new ProjectBoard { Id = 1, Project = project };
            var stage = new Stage { Id = 1, ProjectBoard = board, Name = &quot;Test Stage&quot; };
            var task1 = new TaskManagerWebsite.Models.Task
                { Id = 1, Name = &quot;Original Task&quot;, CreatorUserId = user.Id, Description = &quot;Task&quot; };
            var task2 = new TaskManagerWebsite.Models.Task
                { Id = 2, Name = &quot;Duplicate Name&quot;, CreatorUserId = user.Id, Description = &quot;Task&quot; };

            context.Users.Add(user);
            context.Projects.Add(project);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            context.Tasks.AddRange(task1, task2);
            context.TaskStages.AddRange(
                new TaskStage { Task = task1, Stage = stage },
                new TaskStage { Task = task2, Stage = stage }
            );
            await context.SaveChangesAsync();

            var controller = new ProjectController(context, CreateUserManager(user, false));

            var vm = new CreateTaskViewModel
            {
                TaskId = 1,
                Name = &quot;Duplicate Name&quot; // Duplicate
            };

            var result = await controller.EditTask(vm);

            var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
            Assert.False(controller.ModelState.IsValid);
            Assert.True(controller.ModelState.ContainsKey(&quot;Name&quot;));
        }

        [Fact]
        public async Task EditTask_Post_TaskNotFound_ReturnsNotFound()
        {
            using var context = CreateContext(nameof(EditTask_Post_TaskNotFound_ReturnsNotFound));
            var user = new User { Id = 1 };

            var controller = new ProjectController(context, CreateUserManager(user, false));

            var vm = new CreateTaskViewModel
            {
                TaskId = 999, // Non-existent
                Name = &quot;New Name&quot;
            };

            var result = await controller.EditTask(vm);

            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task EditTask_Post_ValidUpdate_UpdatesTaskAndRedirects()
        {
            using var context = CreateContext(nameof(EditTask_Post_ValidUpdate_UpdatesTaskAndRedirects));

            var user = new User { Id = 1, UserName = &quot;admin&quot; };
            var project = new Project
                { Id = 1, ProjectLeadId = user.Id, Name = &quot;Test Project&quot;, Description = &quot;Test Description&quot; };
            var board = new ProjectBoard { Id = 1, Project = project };
            var stage = new Stage { Id = 1, ProjectBoard = board, Name = &quot;Test&quot; };
            var task = new TaskManagerWebsite.Models.Task
                { Id = 1, Name = &quot;Old Task&quot;, Description = &quot;Old Desc&quot;, CreatorUserId = user.Id };
            var taskStage = new TaskStage { Task = task, Stage = stage };

            context.Users.Add(user);
            context.Projects.Add(project);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            context.Tasks.Add(task);
            context.TaskStages.Add(taskStage);
            await context.SaveChangesAsync();

            var userManager = CreateUserManager(user, false);
            var controller = new ProjectController(context, userManager);

            var vm = new CreateTaskViewModel
            {
                TaskId = 1,
                Name = &quot;Updated Task&quot;,
                Description = &quot;Updated Desc&quot;
            };

            var result = await controller.EditTask(vm);

            var redirect = Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.Equal(&quot;ProjectBoard&quot;, redirect.ActionName);

            var updatedTask = await context.Tasks.FindAsync(1);
            Assert.Equal(&quot;Updated Task&quot;, updatedTask.Name);
            Assert.Equal(&quot;Updated Desc&quot;, updatedTask.Description);
        }


        // DELETE: DeleteStage

        [Fact]
        public async Task DeleteStage_Post_ReturnsNotFound_IfStageMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            var result = await controller.DeleteStage(999);
            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task DeleteStage_Post_ReturnsNotFound_IfProjectMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var board = new ProjectBoard { Id = 130, ProjectId = 600, Stages = new List&lt;Stage&gt;() };
            var stage = new Stage
            {
                Id = 1000, ProjectBoard = board, Position = 1, Name = &quot;S&quot;,
                AssignedGroup = new Group { Id = 1, Name = &quot;Dummy&quot;, Description = &quot;Dummy&quot; }
            };
            context.Stages.Add(stage);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            var result = await controller.DeleteStage(1000);
            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task DeleteStage_Post_ReturnsForbid_IfUnauthorized()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var proj = new Project
            {
                Id = 13, Name = &quot;P13&quot;, Description = &quot;D13&quot;, ProjectLeadId = 2, ProjectGroups = new List&lt;GroupProject&gt;()
            };
            var board = new ProjectBoard { Id = 140, ProjectId = 13, BoardCreatorId = 2, Stages = new List&lt;Stage&gt;() };
            proj.ProjectBoard = board;
            context.Projects.Add(proj);
            var stage = new Stage
            {
                Id = 1100, ProjectBoard = board, Position = 1, Name = &quot;S&quot;,
                AssignedGroup = new Group { Id = 1, Name = &quot;Dummy&quot;, Description = &quot;Dummy&quot; }
            };
            context.Stages.Add(stage);
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };
            var result = await controller.DeleteStage(1100);
            Assert.IsType&lt;ForbidResult&gt;(result);
        }

        [Fact]
        public async Task DeleteStage_Post_DeletesStage_IfAuthorized()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var grp = new Group { Id = 1, Name = &quot;G1&quot;, Description = &quot;Test&quot; };
            var proj = new Project
            {
                Id = 14,
                Name = &quot;P14&quot;,
                Description = &quot;D14&quot;,
                ProjectLeadId = 1,
                ProjectGroups = new List&lt;GroupProject&gt; { new GroupProject { Group = grp, GroupId = grp.Id } }
            };
            var board = new ProjectBoard { Id = 150, ProjectId = 14, BoardCreatorId = 1, Stages = new List&lt;Stage&gt;() };
            proj.ProjectBoard = board;
            var stage = new Stage { Id = 1200, ProjectBoard = board, Position = 1, Name = &quot;SDel&quot;, AssignedGroup = grp };
            context.Projects.Add(proj);
            context.Stages.Add(stage);
            await context.SaveChangesAsync();

            context.UserGroups.Add(new UserGroup { UserId = 1, GroupId = grp.Id, Role = &quot;Manager&quot; });
            await context.SaveChangesAsync();

            var user = new User { Id = 1, UserName = &quot;user&quot; };
            var um = CreateUserManager(user, false);
            var controller = new ProjectController(context, um) { ControllerContext = CreateControllerContext(user) };

            var result = await controller.DeleteStage(1200) as RedirectToActionResult;
            Assert.Equal(nameof(ProjectController.ProjectBoard), result.ActionName);
            Assert.Null(await context.Stages.FindAsync(1200));
        }

        [Fact]
        public async Task DeleteTask_ValidId_DeletesTaskAndRedirects()
        {
            // Arrange
            using var context = CreateContext(Guid.NewGuid().ToString());

            var user = new User { Id = 1, UserName = &quot;test&quot; };
            var project = new Project { Id = 1, Name = &quot;Test&quot;, Description = &quot;Test Description&quot; };
            var board = new ProjectBoard { Id = 1, ProjectId = 1, Project = project };
            var stage = new Stage { Name = &quot;Stage1&quot;, Id = 1, ProjectBoardId = 1, ProjectBoard = board };
            var task = new TaskManagerWebsite.Models.Task
                { Description = &quot;TestDescription&quot;, Id = 1, Name = &quot;Task1&quot;, CreatorUserId = user.Id };
            var taskStage = new TaskStage { Id = 1, TaskId = 1, Task = task, StageId = 1, Stage = stage };
            var taskEmployee = new TaskEmployee { TaskId = 1, EmployeeId = 2 };

            context.Projects.Add(project);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            context.Tasks.Add(task);
            context.TaskStages.Add(taskStage);
            context.TaskEmployees.Add(taskEmployee);
            await context.SaveChangesAsync();

            var controller = new ProjectController(context, this.CreateUserManager(user, true));

            // Act
            var result = await controller.DeleteTask(taskStage.Id);

            // Assert
            Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.False(context.Tasks.Any());
            Assert.False(context.TaskStages.Any());
            Assert.False(context.TaskEmployees.Any());
        }

        [Fact]
        public async Task DeleteTask_StageNotFound_ReturnsNotFound()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());

            var user = new User { Id = 1, UserName = &quot;test&quot; };
            var task = new TaskManagerWebsite.Models.Task
                { Description = &quot;TestDescription&quot;, Id = 1, Name = &quot;Task1&quot;, CreatorUserId = 1 };
            var taskStage = new TaskStage { Id = 1, TaskId = 1, Task = task, StageId = 42 }; // stageId 42 doesn&#39;t exist

            context.Tasks.Add(task);
            context.TaskStages.Add(taskStage);
            await context.SaveChangesAsync();

            var controller = new ProjectController(context, this.CreateUserManager(user, false));

            var result = await controller.DeleteTask(taskStage.Id);

            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task CreateTask_Post_InvalidModelState_ReturnsView()
        {
            var controller = new ProjectController(CreateContext(Guid.NewGuid().ToString()),
                CreateUserManager(new User { Id = 1 }, false));
            controller.ModelState.AddModelError(&quot;Name&quot;, &quot;Required&quot;);

            var vm = new CreateTaskViewModel { StageId = 1 };
            var result = await controller.CreateTask(vm);
            var view = Assert.IsType&lt;ViewResult&gt;(result);
            Assert.Equal(vm, view.Model);
        }

        [Fact]
        public async Task CreateTask_Post_ReturnsNotFound_IfStageMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var controller = new ProjectController(context, CreateUserManager(new User { Id = 1 }, false));
            var result = await controller.CreateTask(new CreateTaskViewModel { StageId = 999 });
            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task CreateTask_Post_ReturnsViewIfDuplicateNameExists()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());

            var user = new User { Id = 1 };
            var project = new Project { Id = 1, Name = &quot;Test Project&quot;, Description = &quot;Some description&quot;, ProjectLeadId = user.Id };
            var board = new ProjectBoard { Id = 1, Project = project };
            var stage = new Stage { Id = 1, Name = &quot;Stage&quot;, ProjectBoard = board };
            var existingTask = new TaskManagerWebsite.Models.Task
                { Id = 1, Name = &quot;Task1&quot;, Description = &quot;desc&quot;, CreatorUserId = user.Id };
            var taskStage = new TaskStage { Task = existingTask, Stage = stage };

            context.Users.Add(user);
            context.Projects.Add(project);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            context.Tasks.Add(existingTask);
            context.TaskStages.Add(taskStage);
            await context.SaveChangesAsync();

            var controller = new ProjectController(context, CreateUserManager(user, false))
            {
                ControllerContext = CreateControllerContext(user)
            };

            var vm = new CreateTaskViewModel { Name = &quot;Task1&quot;, Description = &quot;Duplicate&quot;, StageId = stage.Id };
            var result = await controller.CreateTask(vm);
            var view = Assert.IsType&lt;ViewResult&gt;(result);
            Assert.True(controller.ModelState.ContainsKey(&quot;Name&quot;));
        }

        [Fact]
        public async Task CreateTask_Post_CreatesTaskAndRedirects_WhenValid()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1 };
            var project = new Project { Id = 1, Name = &quot;Test Project&quot;, Description = &quot;Some description&quot;, ProjectLeadId = user.Id };
            var board = new ProjectBoard { Id = 1, Project = project };
            var stage = new Stage { Id = 1, Name = &quot;Stage&quot;, ProjectBoard = board };

            context.Users.Add(user);
            context.Projects.Add(project);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            await context.SaveChangesAsync();

            var controller = new ProjectController(context, CreateUserManager(user, false))
            {
                ControllerContext = CreateControllerContext(user)
            };

            var vm = new CreateTaskViewModel
            {
                Name = &quot;New Task&quot;,
                Description = &quot;desc&quot;,
                StageId = stage.Id
            };

            var result = await controller.CreateTask(vm);
            var redirect = Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.Equal(&quot;ProjectBoard&quot;, redirect.ActionName);
            Assert.True(context.Tasks.Any(t =&gt; t.Name == &quot;New Task&quot;));
        }

        [Fact]
        public async Task CreateTask_Post_CreatesTaskWithEmployeeAssignment()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1 };
            var assigned = new User { Id = 2 };
            var project = new Project {Id = 1, Name = &quot;Test Project&quot;, Description = &quot;Some description&quot;, ProjectLeadId = user.Id };
            var board = new ProjectBoard { Id = 1, Project = project };
            var stage = new Stage { Id = 1, Name = &quot;Stage&quot;, ProjectBoard = board };

            context.Users.AddRange(user, assigned);
            context.Projects.Add(project);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            await context.SaveChangesAsync();

            var userManager = CreateUserManager(user, false);
            Mock.Get(userManager).Setup(um =&gt; um.FindByIdAsync(&quot;2&quot;)).ReturnsAsync(assigned);

            var controller = new ProjectController(context, userManager)
            {
                ControllerContext = CreateControllerContext(user)
            };

            var vm = new CreateTaskViewModel
            {
                Name = &quot;With Assignment&quot;,
                Description = &quot;desc&quot;,
                StageId = stage.Id,
                SelectedEmployeeId = 2
            };

            var result = await controller.CreateTask(vm);
            var redirect = Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.Equal(&quot;ProjectBoard&quot;, redirect.ActionName);

            var created = await context.Tasks.FirstOrDefaultAsync(t =&gt; t.Name == &quot;With Assignment&quot;);
            var assignment = await context.TaskEmployees.FirstOrDefaultAsync(te =&gt; te.TaskId == created.Id);
            Assert.NotNull(assignment);
            Assert.Equal(2, assignment.EmployeeId);
        }

        [Fact]
        public async Task CreateTask_Get_ReturnsNotFound_IfStageMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var controller = new ProjectController(context, CreateUserManager(new User { Id = 1 }, false));
            var result = await controller.CreateTask(999);
            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task CreateTask_Get_ReturnsNotFound_IfProjectMissing()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());

            var board = new ProjectBoard { Id = 1, ProjectId = 42 };
            var stage = new Stage { Id = 1, Name = &quot;Stage 1&quot;, ProjectBoard = board };

            context.Stages.Add(stage);
            context.ProjectBoards.Add(board);
            await context.SaveChangesAsync();

            var controller = new ProjectController(context, CreateUserManager(new User { Id = 1 }, false));
            var result = await controller.CreateTask(stage.Id);
            Assert.IsType&lt;NotFoundResult&gt;(result);
        }

        [Fact]
        public async Task CreateTask_Get_ReturnsView_ForAdmin()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1, UserName = &quot;admin&quot; };

            var group = new Group { Id = 1, Name = &quot;G&quot;, Description = &quot;Desc&quot;};
            var project = new Project
            {
                Id = 1,
                Name = &quot;Project A&quot;,
                Description = &quot;Test&quot;,
                ProjectLeadId = user.Id,
                ProjectGroups = new List&lt;GroupProject&gt; { new GroupProject { Group = group, GroupId = group.Id } }
            };

            var board = new ProjectBoard { Id = 1, Project = project };
            var stage = new Stage { Id = 1, Name = &quot;Stage&quot;, ProjectBoard = board };
            project.ProjectBoard = board;

            context.Users.Add(user);
            context.Projects.Add(project);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            context.Groups.Add(group);
            await context.SaveChangesAsync();

            var controller = new ProjectController(context, CreateUserManager(user, true))
            {
                ControllerContext = CreateControllerContext(user)
            };

            var result = await controller.CreateTask(stage.Id);
            var view = Assert.IsType&lt;ViewResult&gt;(result);
            Assert.IsType&lt;CreateTaskViewModel&gt;(view.Model);
        }

        [Fact]
        public async Task CreateTask_Get_ReturnsView_ForProjectLead()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1, UserName = &quot;lead&quot; };

            var group = new Group { Id = 1, Name = &quot;G&quot;, Description = &quot;Desc&quot; };
            var project = new Project
            {
                Id = 1,
                Name = &quot;Project B&quot;,
                Description = &quot;Test B&quot;,
                ProjectLeadId = user.Id,
                ProjectGroups = new List&lt;GroupProject&gt; { new GroupProject { Group = group, GroupId = group.Id } }
            };

            var board = new ProjectBoard { Id = 1, Project = project };
            var stage = new Stage { Id = 1, Name = &quot;Stage&quot;, ProjectBoard = board };
            project.ProjectBoard = board;

            context.Users.Add(user);
            context.Projects.Add(project);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            context.Groups.Add(group);
            await context.SaveChangesAsync();

            var controller = new ProjectController(context, CreateUserManager(user, false))
            {
                ControllerContext = CreateControllerContext(user)
            };

            var result = await controller.CreateTask(stage.Id);
            var view = Assert.IsType&lt;ViewResult&gt;(result);
            Assert.IsType&lt;CreateTaskViewModel&gt;(view.Model);
        }

        [Fact]
        public async Task CreateTask_Get_ReturnsView_ForGroupManager()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1 };
            var group = new Group { Id = 1, Name = &quot;Group&quot;, Description = &quot;Desc&quot; };

            context.UserGroups.Add(new UserGroup { UserId = 1, GroupId = 1, Role = &quot;Manager&quot; });

            var project = new Project
            {
                Id = 1,
                Name = &quot;Project C&quot;,
                Description = &quot;Test C&quot;,
                ProjectLeadId = 999,
                ProjectGroups = new List&lt;GroupProject&gt; { new GroupProject { GroupId = group.Id, Group = group } }
            };

            var board = new ProjectBoard { Id = 1, Project = project };
            var stage = new Stage { Id = 1, Name = &quot;Stage&quot;, ProjectBoard = board };
            project.ProjectBoard = board;

            context.Users.Add(user);
            context.Projects.Add(project);
            context.Groups.Add(group);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            await context.SaveChangesAsync();

            var controller = new ProjectController(context, CreateUserManager(user, false))
            {
                ControllerContext = CreateControllerContext(user)
            };

            var result = await controller.CreateTask(stage.Id);
            var view = Assert.IsType&lt;ViewResult&gt;(result);
            Assert.IsType&lt;CreateTaskViewModel&gt;(view.Model);
        }

        [Fact]
        public async Task CreateTask_Get_ReturnsView_ForMember()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());
            var user = new User { Id = 1 };
            var group = new Group { Id = 1, Name = &quot;Group&quot;, Description = &quot;Desc&quot; };

            context.UserGroups.Add(new UserGroup { UserId = 1, GroupId = 1, Role = &quot;Employee&quot; });

            var project = new Project
            {
                Id = 1,
                Name = &quot;Project D&quot;,
                Description = &quot;Test D&quot;,
                ProjectLeadId = 999,
                ProjectGroups = new List&lt;GroupProject&gt; { new GroupProject { GroupId = group.Id, Group = group } }
            };

            var board = new ProjectBoard { Id = 1, Project = project };
            var stage = new Stage { Id = 1, Name = &quot;Stage&quot;, ProjectBoard = board };
            project.ProjectBoard = board;

            context.Users.Add(user);
            context.Projects.Add(project);
            context.Groups.Add(group);
            context.ProjectBoards.Add(board);
            context.Stages.Add(stage);
            await context.SaveChangesAsync();

            var controller = new ProjectController(context, CreateUserManager(user, false))
            {
                ControllerContext = CreateControllerContext(user)
            };

            var result = await controller.CreateTask(stage.Id);
            var view = Assert.IsType&lt;ViewResult&gt;(result);
            Assert.IsType&lt;CreateTaskViewModel&gt;(view.Model);
        }



        [Fact]
        public async Task MoveTask_Valid_MoveUpdatesStages()
        {
            using var context = CreateContext(Guid.NewGuid().ToString());

            var user = new User { Id = 1 };
            var task = new TaskManagerWebsite.Models.Task
            {
                Id = 1,
                CreatorUserId = user.Id,
                Name = &quot;Move Task&quot;,
                Description = &quot;Test description&quot;
            };

            var board = new ProjectBoard { Id = 1, ProjectId = 1 };
            var stage1 = new Stage { Id = 1, Name = &quot;To Do&quot;, ProjectBoard = board };
            var stage2 = new Stage { Id = 2, Name = &quot;In Progress&quot;, ProjectBoard = board };

            var taskStage = new TaskStage
            {
                Id = 1,
                TaskId = task.Id,
                StageId = stage1.Id,
                CompletedDate = null
            };

            context.Users.Add(user);
            context.Tasks.Add(task);
            context.ProjectBoards.Add(board);
            context.Stages.AddRange(stage1, stage2);
            context.TaskStages.Add(taskStage);
            await context.SaveChangesAsync();

            var controller = new ProjectController(context, CreateUserManager(user, false));
            controller.ControllerContext = CreateControllerContext(user);

            var result = await controller.MoveTask(task.Id, stage1.Id, stage2.Id);

            var redirect = Assert.IsType&lt;RedirectToActionResult&gt;(result);
            Assert.Equal(&quot;ProjectBoard&quot;, redirect.ActionName);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,10,1],[20,13,22,26,1],[23,13,23,54,1],[24,9,24,10,1],[27,9,27,10,1],[28,13,28,54,1],[29,13,29,116,1],[30,13,30,103,1],[31,13,31,89,1],[32,13,32,99,1],[33,13,33,97,1],[34,13,34,34,1],[35,9,35,10,1],[39,9,39,10,1],[40,13,43,28,1],[44,13,45,99,1],[46,9,46,10,1],[52,9,52,10,1],[53,13,53,74,1],[54,13,54,63,1],[55,13,55,53,1],[56,13,56,119,1],[58,13,58,61,1],[59,13,59,51,1],[60,9,60,10,1],[64,9,64,10,1],[65,13,65,74,1],[66,13,73,15,1],[74,13,74,40,1],[75,13,75,46,1],[77,13,77,63,1],[78,13,78,53,1],[79,13,79,119,1],[81,13,81,46,1],[82,13,82,115,1],[83,13,83,50,1],[84,9,84,10,1],[88,9,88,10,1],[89,13,89,74,1],[90,13,97,15,1],[98,13,99,92,1],[100,13,100,40,1],[101,13,101,46,1],[103,13,103,64,1],[104,13,104,52,1],[105,13,105,119,1],[107,13,107,73,1],[108,13,108,81,1],[109,9,109,10,1],[115,9,115,10,1],[116,13,116,74,1],[117,13,117,63,1],[118,13,118,53,1],[119,13,119,119,1],[121,13,121,50,1],[122,13,122,65,1],[123,13,123,51,1],[124,9,124,10,1],[128,9,128,10,1],[129,13,129,74,1],[130,13,137,15,1],[138,13,139,92,1],[140,13,140,40,1],[141,13,141,46,1],[143,13,143,63,1],[144,13,144,53,1],[145,13,145,119,1],[147,13,148,109,1],[149,13,149,63,1],[150,13,150,49,1],[151,9,151,10,1],[155,9,155,10,1],[156,13,156,74,1],[157,13,164,15,1],[165,13,166,92,1],[167,13,167,40,1],[168,13,168,46,1],[170,13,170,63,1],[171,13,171,53,1],[172,13,172,119,1],[173,13,173,69,1],[175,13,176,109,1],[177,13,177,77,1],[178,13,178,63,1],[179,13,179,35,1],[180,13,180,47,1],[181,9,181,10,1],[185,9,185,10,1],[186,13,186,74,1],[187,13,187,79,1],[188,13,195,15,1],[196,13,197,92,1],[198,13,198,40,1],[199,13,206,16,1],[207,13,207,46,1],[209,13,209,63,1],[210,13,210,53,1],[211,13,211,119,1],[213,13,214,121,1],[215,13,215,77,1],[216,13,216,36,1],[217,13,217,63,1],[218,9,218,10,1],[222,9,222,10,1],[223,13,223,74,1],[224,13,224,79,1],[225,13,232,15,1],[233,13,234,92,1],[235,13,235,40,1],[236,13,236,46,1],[237,13,237,102,1],[238,13,238,46,1],[240,13,240,63,1],[241,13,241,53,1],[242,13,242,119,1],[244,13,245,120,1],[246,13,246,89,1],[247,13,247,85,1],[248,13,248,93,1],[249,13,249,35,1],[250,9,250,10,1],[256,9,256,10,1],[257,13,257,74,1],[258,13,258,63,1],[259,13,259,53,1],[260,13,260,119,1],[261,13,261,58,1],[262,13,262,51,1],[263,9,263,10,1],[267,9,267,10,1],[268,13,268,74,1],[269,13,269,99,1],[270,13,274,15,1],[275,13,275,39,1],[276,13,276,46,1],[278,13,278,63,1],[279,13,279,53,1],[280,13,280,119,1],[281,13,281,58,1],[282,13,282,51,1],[283,9,283,10,1],[287,9,287,10,1],[288,13,288,74,1],[289,13,289,79,1],[290,13,297,15,1],[298,13,298,117,1],[299,13,299,39,1],[300,13,304,15,1],[305,13,305,54,1],[306,13,306,40,1],[307,13,307,46,1],[309,13,309,63,1],[310,13,310,53,1],[311,13,311,119,1],[313,13,313,72,1],[314,13,314,57,1],[315,13,315,32,1],[316,13,316,43,1],[317,9,317,10,1],[323,9,323,10,1],[324,13,324,74,1],[325,13,325,63,1],[326,13,326,53,1],[327,13,327,119,1],[328,13,328,63,1],[329,13,329,57,1],[330,13,330,51,1],[331,9,331,10,1],[335,9,335,10,1],[336,13,336,74,1],[337,13,337,99,1],[338,13,342,15,1],[343,13,343,39,1],[344,13,344,46,1],[346,13,346,63,1],[347,13,347,53,1],[348,13,348,119,1],[349,13,349,81,1],[350,13,350,57,1],[351,13,351,51,1],[352,9,352,10,1],[356,9,356,10,1],[357,13,357,74,1],[358,13,361,15,1],[362,13,362,117,1],[363,13,363,39,1],[364,13,364,40,1],[365,13,369,15,1],[370,13,370,39,1],[371,13,371,46,1],[373,13,373,63,1],[374,13,374,53,1],[375,13,375,119,1],[376,13,376,116,1],[377,13,377,57,1],[378,13,378,49,1],[379,9,379,10,1],[383,9,383,10,1],[384,13,384,74,1],[385,13,385,81,1],[386,13,390,15,1],[391,13,391,119,1],[392,13,392,39,1],[393,13,393,117,1],[394,13,394,54,1],[395,13,395,40,1],[396,13,396,46,1],[398,13,398,63,1],[399,13,399,53,1],[400,13,400,119,1],[401,13,401,69,1],[402,13,402,121,1],[403,13,403,71,1],[404,13,404,36,1],[405,9,405,10,1],[409,9,409,10,1],[410,13,410,74,1],[411,13,411,81,1],[412,13,416,15,1],[417,13,417,119,1],[418,13,418,39,1],[420,13,421,108,1],[422,13,423,106,1],[424,13,424,54,1],[425,13,425,39,1],[426,13,426,40,1],[427,13,427,46,1],[429,13,429,63,1],[430,13,430,53,1],[431,13,431,119,1],[432,13,433,95,1],[434,13,434,71,1],[435,13,435,36,1],[436,13,436,63,1],[437,9,437,10,1],[441,9,441,10,1],[442,13,442,74,1],[443,13,443,81,1],[444,13,448,15,1],[449,13,449,119,1],[450,13,450,39,1],[451,13,451,115,1],[452,13,452,115,1],[453,13,453,55,1],[454,13,454,40,1],[455,13,455,46,1],[457,13,457,63,1],[458,13,458,53,1],[459,13,459,119,1],[460,13,461,96,1],[462,13,462,83,1],[463,13,463,85,1],[464,13,464,63,1],[465,13,465,54,1],[466,13,466,47,1],[467,13,467,63,1],[468,13,468,47,1],[469,9,469,10,1],[474,9,474,10,1],[475,13,475,74,1],[476,13,476,63,1],[478,13,478,98,1],[480,13,480,65,1],[482,13,482,51,1],[483,9,483,10,1],[487,9,487,10,1],[488,13,488,74,1],[489,13,489,120,1],[490,13,490,46,1],[491,13,491,63,1],[493,13,493,98,1],[495,13,495,55,1],[497,13,497,51,1],[498,9,498,10,1],[502,9,502,10,1],[503,13,503,74,1],[504,13,504,119,1],[505,13,505,120,1],[506,13,506,72,1],[507,13,507,89,1],[508,13,508,94,1],[510,13,510,37,1],[511,13,511,43,1],[512,13,512,46,1],[513,13,513,39,1],[514,13,514,47,1],[515,13,515,46,1],[517,13,517,101,1],[518,13,518,74,1],[520,13,520,55,1],[522,13,522,49,1],[523,9,523,10,1],[527,9,527,10,1],[528,13,528,74,1],[531,13,531,63,1],[532,13,532,81,1],[533,13,533,116,1],[535,13,535,114,1],[536,13,536,114,1],[538,13,538,87,1],[539,13,539,128,1],[541,13,548,15,1],[550,13,557,15,1],[559,13,559,95,1],[561,13,561,37,1],[562,13,562,39,1],[563,13,563,47,1],[564,13,564,43,1],[565,13,565,53,1],[566,13,566,46,1],[567,13,567,39,1],[568,13,568,37,1],[569,13,569,47,1],[570,13,570,51,1],[571,13,571,46,1],[573,13,573,70,1],[574,13,574,74,1],[577,13,577,61,1],[580,13,580,64,1],[581,13,581,78,1],[582,13,582,49,1],[583,9,583,10,1],[589,9,589,10,1],[590,13,590,95,1],[591,13,591,63,1],[593,13,593,93,1],[594,13,594,69,1],[596,13,596,61,1],[598,13,598,56,1],[600,13,600,64,1],[601,13,601,88,1],[602,9,602,10,1],[606,9,606,10,1],[607,13,607,102,1],[609,13,609,44,1],[610,13,611,110,1],[612,13,612,72,1],[613,13,613,89,1],[614,13,615,99,1],[616,13,617,100,1],[619,13,619,37,1],[620,13,620,43,1],[621,13,621,46,1],[622,13,622,39,1],[623,13,623,50,1],[624,13,627,15,1],[628,13,628,46,1],[630,13,630,93,1],[632,13,636,15,1],[638,13,638,56,1],[640,13,640,64,1],[641,13,641,57,1],[642,13,642,68,1],[643,9,643,10,1],[647,9,647,10,1],[648,13,648,99,1],[649,13,649,44,1],[651,13,651,93,1],[653,13,657,15,1],[659,13,659,56,1],[661,13,661,51,1],[662,9,662,10,1],[666,9,666,10,1],[667,13,667,106,1],[669,13,669,64,1],[670,13,671,110,1],[672,13,672,72,1],[673,13,673,83,1],[674,13,675,98,1],[676,13,676,74,1],[678,13,678,37,1],[679,13,679,43,1],[680,13,680,46,1],[681,13,681,39,1],[682,13,682,37,1],[683,13,683,47,1],[684,13,684,46,1],[686,13,686,62,1],[687,13,687,74,1],[689,13,694,15,1],[696,13,696,56,1],[698,13,698,74,1],[699,13,699,63,1],[701,13,701,64,1],[702,13,702,60,1],[703,13,703,67,1],[704,9,704,10,1],[711,9,711,10,1],[712,13,712,74,1],[713,13,713,63,1],[714,13,714,53,1],[715,13,715,119,1],[716,13,716,60,1],[717,13,717,51,1],[718,9,718,10,1],[722,9,722,10,1],[723,13,723,74,1],[724,13,724,100,1],[725,13,729,15,1],[730,13,730,39,1],[731,13,731,46,1],[733,13,733,63,1],[734,13,734,53,1],[735,13,735,119,1],[736,13,736,61,1],[737,13,737,51,1],[738,9,738,10,1],[742,9,742,10,1],[743,13,743,74,1],[744,13,747,15,1],[748,13,748,119,1],[749,13,749,39,1],[750,13,750,40,1],[751,13,755,15,1],[756,13,756,39,1],[757,13,757,46,1],[759,13,759,63,1],[760,13,760,53,1],[761,13,761,119,1],[762,13,762,61,1],[763,13,763,49,1],[764,9,764,10,1],[768,9,768,10,1],[769,13,769,74,1],[770,13,770,79,1],[771,13,778,15,1],[779,13,779,119,1],[780,13,780,39,1],[781,13,781,121,1],[782,13,782,40,1],[783,13,783,39,1],[784,13,784,46,1],[786,13,786,102,1],[787,13,787,46,1],[789,13,789,63,1],[790,13,790,53,1],[791,13,791,119,1],[793,13,793,87,1],[794,13,794,85,1],[795,13,795,63,1],[796,9,796,10,1],[800,9,800,10,1],[802,13,802,74,1],[804,13,804,63,1],[805,13,805,99,1],[806,13,806,87,1],[807,13,807,105,1],[808,13,809,102,1],[810,13,810,107,1],[811,13,811,80,1],[813,13,813,43,1],[814,13,814,46,1],[815,13,815,39,1],[816,13,816,37,1],[817,13,817,47,1],[818,13,818,53,1],[819,13,819,46,1],[821,13,821,97,1],[824,13,824,68,1],[827,13,827,59,1],[828,13,828,47,1],[829,13,829,52,1],[830,13,830,55,1],[831,9,831,10,1],[835,9,835,10,1],[836,13,836,74,1],[838,13,838,63,1],[839,13,840,96,1],[841,13,841,93,1],[843,13,843,37,1],[844,13,844,47,1],[845,13,845,46,1],[847,13,847,98,1],[849,13,849,68,1],[851,13,851,51,1],[852,9,852,10,1],[856,9,856,10,1],[857,13,858,64,1],[859,13,859,69,1],[861,13,861,62,1],[862,13,862,58,1],[863,13,863,58,1],[864,13,864,42,1],[865,9,865,10,1],[869,9,869,10,1],[870,13,870,74,1],[871,13,871,108,1],[872,13,872,97,1],[873,13,873,51,1],[874,9,874,10,1],[878,9,878,10,1],[879,13,879,74,1],[881,13,881,44,1],[882,13,882,132,1],[883,13,883,72,1],[884,13,884,84,1],[885,13,886,91,1],[887,13,887,82,1],[889,13,889,37,1],[890,13,890,43,1],[891,13,891,46,1],[892,13,892,39,1],[893,13,893,45,1],[894,13,894,47,1],[895,13,895,46,1],[897,13,900,15,1],[902,13,902,112,1],[903,13,903,58,1],[904,13,904,58,1],[905,13,905,68,1],[906,9,906,10,1],[910,9,910,10,1],[911,13,911,74,1],[912,13,912,44,1],[913,13,913,132,1],[914,13,914,72,1],[915,13,915,84,1],[917,13,917,37,1],[918,13,918,43,1],[919,13,919,46,1],[920,13,920,39,1],[921,13,921,46,1],[923,13,926,15,1],[928,13,933,15,1],[935,13,935,58,1],[936,13,936,74,1],[937,13,937,63,1],[938,13,938,71,1],[939,9,939,10,1],[943,9,943,10,1],[944,13,944,74,1],[945,13,945,44,1],[946,13,946,48,1],[947,13,947,131,1],[948,13,948,72,1],[949,13,949,84,1],[951,13,951,52,1],[952,13,952,43,1],[953,13,953,46,1],[954,13,954,39,1],[955,13,955,46,1],[957,13,957,62,1],[958,13,958,93,1],[960,13,963,15,1],[965,13,971,15,1],[973,13,973,58,1],[974,13,974,74,1],[975,13,975,63,1],[977,13,977,101,1],[978,13,978,109,1],[979,13,979,40,1],[980,13,980,52,1],[981,9,981,10,1],[985,9,985,10,1],[986,13,986,74,1],[987,13,987,108,1],[988,13,988,59,1],[989,13,989,51,1],[990,9,990,10,1],[994,9,994,10,1],[995,13,995,74,1],[997,13,997,69,1],[998,13,998,86,1],[1000,13,1000,39,1],[1001,13,1001,46,1],[1002,13,1002,46,1],[1004,13,1004,108,1],[1005,13,1005,64,1],[1006,13,1006,51,1],[1007,9,1007,10,1],[1011,9,1011,10,1],[1012,13,1012,74,1],[1013,13,1013,64,1],[1015,13,1015,79,1],[1016,13,1023,15,1],[1025,13,1025,72,1],[1026,13,1026,84,1],[1027,13,1027,42,1],[1029,13,1029,37,1],[1030,13,1030,43,1],[1031,13,1031,46,1],[1032,13,1032,39,1],[1033,13,1033,39,1],[1034,13,1034,46,1],[1036,13,1039,15,1],[1041,13,1041,64,1],[1042,13,1042,58,1],[1043,13,1043,60,1],[1044,9,1044,10,1],[1048,9,1048,10,1],[1049,13,1049,74,1],[1050,13,1050,63,1],[1052,13,1052,80,1],[1053,13,1060,15,1],[1062,13,1062,72,1],[1063,13,1063,84,1],[1064,13,1064,42,1],[1066,13,1066,37,1],[1067,13,1067,43,1],[1068,13,1068,46,1],[1069,13,1069,39,1],[1070,13,1070,39,1],[1071,13,1071,46,1],[1073,13,1076,15,1],[1078,13,1078,64,1],[1079,13,1079,58,1],[1080,13,1080,60,1],[1081,9,1081,10,1],[1085,9,1085,10,1],[1086,13,1086,74,1],[1087,13,1087,44,1],[1088,13,1088,84,1],[1090,13,1090,97,1],[1092,13,1099,15,1],[1101,13,1101,72,1],[1102,13,1102,84,1],[1103,13,1103,42,1],[1105,13,1105,37,1],[1106,13,1106,43,1],[1107,13,1107,39,1],[1108,13,1108,46,1],[1109,13,1109,39,1],[1110,13,1110,46,1],[1112,13,1115,15,1],[1117,13,1117,64,1],[1118,13,1118,58,1],[1119,13,1119,60,1],[1120,9,1120,10,1],[1124,9,1124,10,1],[1125,13,1125,74,1],[1126,13,1126,44,1],[1127,13,1127,84,1],[1129,13,1129,98,1],[1131,13,1138,15,1],[1140,13,1140,72,1],[1141,13,1141,84,1],[1142,13,1142,42,1],[1144,13,1144,37,1],[1145,13,1145,43,1],[1146,13,1146,39,1],[1147,13,1147,46,1],[1148,13,1148,39,1],[1149,13,1149,46,1],[1151,13,1154,15,1],[1156,13,1156,64,1],[1157,13,1157,58,1],[1158,13,1158,60,1],[1159,9,1159,10,1],[1165,9,1165,10,1],[1166,13,1166,74,1],[1168,13,1168,44,1],[1169,13,1175,15,1],[1177,13,1177,68,1],[1178,13,1178,85,1],[1179,13,1179,91,1],[1181,13,1187,15,1],[1189,13,1189,37,1],[1190,13,1190,37,1],[1191,13,1191,46,1],[1192,13,1192,53,1],[1193,13,1193,47,1],[1194,13,1194,46,1],[1196,13,1196,93,1],[1197,13,1197,74,1],[1199,13,1199,83,1],[1201,13,1201,74,1],[1202,13,1202,63,1],[1203,9,1203,10,1]]);
    </script>
  </body>
</html>