<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Nick\Desktop\Capstone-Project\code\TaskManager\Controllers\AdminController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using TaskManagerWebsite.Data;
using TaskManagerWebsite.Models;
using TaskManagerWebsite.ViewModels;
using TaskManagerWebsite.ViewModels.ProjectViewModels;

namespace TaskManagerWebsite.Controllers
{
    /// &lt;summary&gt;
    /// Controller for administrative tasks, accessible only to users with the &quot;Admin&quot; role.
    /// Provides functionalities for managing users and groups.
    /// &lt;/summary&gt;
    public class AdminController(ApplicationDbContext context, UserManager&lt;User&gt; userManager, RoleManager&lt;IdentityRole&lt;int&gt;&gt; roleManager) : Controller
    {
        /// &lt;summary&gt;
        /// Retrieves and displays a list of all users.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;A view displaying all users.&lt;/returns&gt;
        public async Task&lt;IActionResult&gt; Users()
        {
            var users = await context.Users.ToListAsync();
            return View(users);
        }

        /// &lt;summary&gt;
        /// Retrieves details for a specific user by their ID.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the user.&lt;/param&gt;
        /// &lt;returns&gt;A view displaying user details or NotFound if the user does not exist.&lt;/returns&gt;
        public IActionResult UserAdd()
        {
            return View();
        }

        /// &lt;summary&gt;
        /// Users the add.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;model&quot;&gt;The model.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; UserAdd(UserViewModel model)
        {
            if (!ModelState.IsValid)
                return View(model);

            var user = new User { UserName = model.UserName.Trim(), Email = model.Email };

            var createUserResult = await userManager.CreateAsync(user, model.Password);

            if (createUserResult.Succeeded)
            {
                var createUserRoleResult = await userManager.AddToRoleAsync(user, &quot;Employee&quot;);
                if (createUserRoleResult.Succeeded)
                {
                    return RedirectToAction(&quot;Users&quot;, &quot;Admin&quot;);
                }

                foreach (var error in createUserRoleResult.Errors)
                {
                    Console.WriteLine($&quot;Code: {error.Code}, Description: {error.Description}&quot;);
                    ModelState.AddModelError(string.Empty, error.Description);
                }
            }
            
            foreach (var error in createUserResult.Errors)
            {
                Console.WriteLine($&quot;Code: {error.Code}, Description: {error.Description}&quot;);
                ModelState.AddModelError(string.Empty, error.Description);
            }

            return View(model);
        }

        /// &lt;summary&gt;
        /// Retrieves the details of a user based on the provided user ID.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The unique identifier of the user.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Returns a view displaying the user details if found;
        /// otherwise, returns a &lt;see cref=&quot;NotFoundResult&quot;/&gt; if the user does not exist.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; UserDetails(int id)
        {
            var user = await context.Users.FindAsync(id);

            if (user == null)
            {
                return NotFound();
            }

            return View(user);
        }

        /// &lt;summary&gt;
        /// Retrieves and displays a list of all groups.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;A view displaying all groups.&lt;/returns&gt;
        public async Task&lt;IActionResult&gt; Groups()
        {
            var groups = await context.Groups.ToListAsync();
            return View(groups);
        }

        /// &lt;summary&gt;
        /// Displays the form for creating a new group.
        /// Populates managers and employees available for selection.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;A view for creating a new group.&lt;/returns&gt;
        public IActionResult CreateGroup()
        {
            var users = context.Users.ToList();

            ViewBag.Employees = users;

            return View();
        }


        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; CreateGroup(GroupViewModel model)
        {
            if (!ModelState.IsValid)
            {
                ViewBag.Employees = await context.Users.ToListAsync();
                return View(model);
            }

            var manager = await context.Users.FindAsync(model.SelectedManagerId);
            if (manager == null)
            {
                ModelState.AddModelError(&quot;SelectedManagerId&quot;, &quot;The selected manager does not exist.&quot;);
                ViewBag.Employees = await context.Users.ToListAsync();
                return View(model);
            }

            var group = new Group
            {
                Name = model.Name,
                Description = model.Description,
                Manager = manager
            };

            context.Groups.Add(group);
            await context.SaveChangesAsync();

            if (model.SelectedManagerId != null)
            {
                var managerEntry = new UserGroup
                {
                    UserId = (int)model.SelectedManagerId,
                    GroupId = group.Id,
                    Role = &quot;Manager&quot;
                };
                context.UserGroups.Add(managerEntry);
            }

            var employees = await context.Users
                .Where(u =&gt; model.SelectedUserIds.Contains(u.Id) &amp;&amp; u.Id != model.SelectedManagerId)
                .ToListAsync();

            foreach (var employee in employees)
            {
                context.UserGroups.Add(new UserGroup
                {
                    UserId = employee.Id,
                    GroupId = group.Id,
                    Role = &quot;Member&quot;
                });
            }

            await context.SaveChangesAsync();
            return RedirectToAction(&quot;Groups&quot;);
        }

        /// &lt;summary&gt;
        /// Deletes the group.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The identifier.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; DeleteGroup(int id)
        {
            var group = await context.Groups.FindAsync(id);
            if (group == null)
            {
                return RedirectToAction(nameof(Groups));
            }

            try
            {
                context.Groups.Remove(group);
                await context.SaveChangesAsync();
            }
            catch (DbUpdateException)
            {
                TempData[&quot;ErrorMessage&quot;] = &quot;Unable to delete this group because it is referenced elsewhere. Check project assignments&quot;;
            }

            return RedirectToAction(nameof(Groups));
        }


        /// &lt;summary&gt;
        /// Retrieves and displays detailed information for a specific group, including its users and managers,
        /// and also loads all users (excluding managers) and all managers from the database to allow adding new members.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the group.&lt;/param&gt;
        /// &lt;returns&gt;A view displaying group details or NotFound if the group does not exist.&lt;/returns&gt;
        public async Task&lt;IActionResult&gt; GroupDetails(int id)
        {
            var group = await context.Groups
                .Include(g =&gt; g.Manager)
                .FirstOrDefaultAsync(g =&gt; g.Id == id);

            if (group == null)
                return NotFound();

            var groupUsers = await context.UserGroups
                .Where(ug =&gt; ug.GroupId == id)
                .Include(ug =&gt; ug.User)
                .ToListAsync();

            var allUsers = await context.Users.ToListAsync();

            var availableEmployees = allUsers
                .Where(u =&gt; groupUsers.All(gu =&gt; gu.UserId != u.Id) &amp;&amp; (group.Manager == null || u.Id != group.Manager.Id))
                .ToList();

            var availableManagers = allUsers
                .Where(u =&gt; group.Manager == null || u.Id != group.Manager.Id)
                .ToList();

            ViewBag.Users = availableEmployees;
            ViewBag.AvailableManagers = availableManagers;
            ViewBag.GroupUsers = groupUsers;

            return View(group);
        }

        /// &lt;summary&gt;
        /// Adds a user to a specified group.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;groupId&quot;&gt;The ID of the group.&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;The ID of the user to be added.&lt;/param&gt;
        /// &lt;returns&gt;A redirect to the group&#39;s details page.&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; AddUserToGroup(int groupId, int userId)
        {
            var group = await context.Groups.FindAsync(groupId);
            var user = await context.Users.FindAsync(userId);

            if (group == null || user == null)
            {
                return NotFound();
            }

            bool alreadyInGroup = await context.UserGroups.AnyAsync(ug =&gt; ug.GroupId == groupId &amp;&amp; ug.UserId == userId);
            if (!alreadyInGroup)
            {
                context.UserGroups.Add(new UserGroup
                {
                    UserId = userId,
                    GroupId = groupId,
                    Role = &quot;Member&quot;
                });

                await context.SaveChangesAsync();
            }

            group = await context.Groups.FirstOrDefaultAsync(g =&gt; g.Id == groupId);
            var groupUsers = await context.UserGroups
                .Where(ug =&gt; ug.GroupId == groupId)
                .Include(ug =&gt; ug.User)
                .ToListAsync();
            var allUsers = await context.Users.ToListAsync();

            var availableEmployees = allUsers
                .Where(u =&gt; groupUsers.All(gu =&gt; gu.UserId != u.Id) &amp;&amp; (group.Manager == null || u.Id != group.Manager.Id))
                .ToList();

            ViewBag.Users = availableEmployees;
            ViewBag.GroupUsers = groupUsers;

            return PartialView(&quot;_GroupUserAssignmentPartial&quot;, group);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; RemoveUserFromGroup(int groupId, int userId)
        {
            var userGroupEntry = await context.UserGroups.FirstOrDefaultAsync(ug =&gt; ug.GroupId == groupId &amp;&amp; ug.UserId == userId);
            if (userGroupEntry != null)
            {
                context.UserGroups.Remove(userGroupEntry);
                await context.SaveChangesAsync();
            }

            var group = await context.Groups.FirstOrDefaultAsync(g =&gt; g.Id == groupId);
            var groupUsers = await context.UserGroups
                .Where(ug =&gt; ug.GroupId == groupId)
                .Include(ug =&gt; ug.User)
                .ToListAsync();
            var allUsers = await context.Users.ToListAsync();

            var availableEmployees = allUsers
                .Where(u =&gt; groupUsers.All(gu =&gt; gu.UserId != u.Id) &amp;&amp; (group.Manager == null || u.Id != group.Manager.Id))
                .ToList();

            ViewBag.Users = availableEmployees;
            ViewBag.GroupUsers = groupUsers;

            return PartialView(&quot;_GroupUserAssignmentPartial&quot;, group);
        }

        /// &lt;summary&gt;
        /// Adds a manager to a specified group, with an option to set them as the primary manager.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;groupId&quot;&gt;The ID of the group.&lt;/param&gt;
        /// &lt;param name=&quot;managerId&quot;&gt;The ID of the manager to be added.&lt;/param&gt;
        /// &lt;param name=&quot;isPrimary&quot;&gt;Indicates if the manager should be the primary manager.&lt;/param&gt;
        /// &lt;returns&gt;A redirect to the group&#39;s details page.&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; AddManagerToGroup(int groupId, int managerId, bool isPrimary)
        {
            var group = await context.Groups.FirstOrDefaultAsync(g =&gt; g.Id == groupId);
            var user = await context.Users.FindAsync(managerId);

            if (group == null || user == null)
            {
                return NotFound();
            }

            var userGroupEntry = await context.UserGroups
                .FirstOrDefaultAsync(ug =&gt; ug.GroupId == groupId &amp;&amp; ug.UserId == managerId);

            if (userGroupEntry == null)
            {
                userGroupEntry = new UserGroup
                {
                    UserId = managerId,
                    GroupId = groupId,
                    Role = &quot;Manager&quot;
                };
                context.UserGroups.Add(userGroupEntry);
            }
            else
            {
                userGroupEntry.Role = &quot;Manager&quot;;
                context.UserGroups.Update(userGroupEntry);
            }

            if (isPrimary)
            {
                group.ManagerId = managerId;
            }

            await context.SaveChangesAsync();
            return RedirectToAction(&quot;GroupDetails&quot;, new { id = groupId });
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; ChangeManager(int groupId, int newManagerId)
        {
            var group = await context.Groups
                .Include(g =&gt; g.Manager)
                .FirstOrDefaultAsync(g =&gt; g.Id == groupId);

            if (group == null)
            {
                return NotFound();
            }

            var newManager = await context.Users.FindAsync(newManagerId);
            if (newManager == null)
            {
                return NotFound();
            }

            var newManagerEntry = await context.UserGroups
                .FirstOrDefaultAsync(ug =&gt; ug.GroupId == groupId &amp;&amp; ug.UserId == newManagerId);

            if (newManagerEntry == null)
            {
                newManagerEntry = new UserGroup
                {
                    GroupId = groupId,
                    UserId = newManagerId,
                    Role = &quot;Manager&quot;
                };
                context.UserGroups.Add(newManagerEntry);
            }
            else
            {
                newManagerEntry.Role = &quot;Manager&quot;;
                context.UserGroups.Update(newManagerEntry);
            }

            if (group.ManagerId.HasValue)
            {
                var previousManagerEntry = await context.UserGroups
                    .FirstOrDefaultAsync(ug =&gt; ug.GroupId == groupId &amp;&amp; ug.UserId == group.ManagerId);

                if (previousManagerEntry != null)
                {
                    previousManagerEntry.Role = &quot;Member&quot;;
                    context.UserGroups.Update(previousManagerEntry);
                }
            }

            group.ManagerId = newManagerId;
            await context.SaveChangesAsync();

            return RedirectToAction(&quot;GroupDetails&quot;, new { id = groupId });
        }

        /// &lt;summary&gt;
        /// Handles the creation of a new group, assigning selected managers and users.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;group&quot;&gt;The group to be created.&lt;/param&gt;
        /// &lt;param name=&quot;selectedManagers&quot;&gt;List of selected manager IDs.&lt;/param&gt;
        /// &lt;param name=&quot;selectedUsers&quot;&gt;List of selected user IDs.&lt;/param&gt;
        /// &lt;param name=&quot;
        /// Id&quot;&gt;The primary manager&#39;s ID.&lt;/param&gt;
        /// &lt;returns&gt;A redirect to the Groups list if successful, or returns the form with validation errors.&lt;/returns&gt;
        // Display list of projects
        public async Task&lt;IActionResult&gt; Projects()
        {
            var projects = await context.Projects.ToListAsync();
            return View(projects);
        }

        /// &lt;summary&gt;
        /// Displays the form for creating a new project.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;A view with a list of available users to select as project leads.&lt;/returns&gt;
        public async Task&lt;IActionResult&gt; CreateProject()
        {
            var users = await context.Users.ToListAsync();

            // Build the view model
            var model = new CreateProjectViewModel
            {
                ProjectLeads = users.Select(u =&gt; new SelectListItem
                {
                    Value = u.Id.ToString(),
                    Text = u.UserName
                }).ToList()
            };

            return View(model);
        }

        /// &lt;summary&gt;
        /// Handles the submission of a new project creation form.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;model&quot;&gt;The CreateProjectViewModel containing user input.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Redirects to the projects list upon successful creation.
        /// If the model state is invalid or user is not logged in, returns the form with validation errors.
        /// &lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; CreateProject(CreateProjectViewModel model)
        {
            if (!ModelState.IsValid)
            {
                var users = await context.Users.ToListAsync();
                model.ProjectLeads = users.Select(u =&gt; new SelectListItem
                {
                    Value = u.Id.ToString(),
                    Text = u.UserName
                }).ToList();

                return View(model);
            }

            var currentUserId = userManager.GetUserId(User);

            if (string.IsNullOrEmpty(currentUserId))
            {
                ModelState.AddModelError(&quot;&quot;, &quot;Unable to determine the logged-in user.&quot;);

                var users = await context.Users.ToListAsync();
                model.ProjectLeads = users.Select(u =&gt; new SelectListItem
                {
                    Value = u.Id.ToString(),
                    Text = u.UserName
                }).ToList();

                return View(model);
            }

            var project = new Project
            {
                Name = model.Name,
                Description = model.Description,
                ProjectLeadId = model.ProjectLeadId,
                ProjectCreatorId = int.Parse(currentUserId)
            };

            context.Projects.Add(project);
            await context.SaveChangesAsync();

            return RedirectToAction(nameof(Projects));
        }

        /// &lt;summary&gt;
        /// Retrieves the details of a specific project, including its lead and associated groups.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The unique identifier of the project.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Returns a view displaying the project details if found;
        /// otherwise, returns a &lt;see cref=&quot;NotFoundResult&quot;/&gt; if the project does not exist.
        /// &lt;/returns&gt;
        public async Task&lt;IActionResult&gt; ProjectDetails(int id)
        {
            var project = await context.Projects
                .Include(p =&gt; p.ProjectLead)
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == id);

            if (project == null)
            {
                return NotFound();
            }
            ViewBag.Groups = await context.Groups.ToListAsync();
            return View(project);
        }

        /// &lt;summary&gt;
        /// Assigns a group to a specified project if it is not already assigned.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;projectId&quot;&gt;The ID of the project.&lt;/param&gt;
        /// &lt;param name=&quot;groupId&quot;&gt;The ID of the group to be assigned.&lt;/param&gt;
        /// &lt;returns&gt;Redirects to the project details page if successful; otherwise, returns
        /// a &lt;see cref=&quot;NotFoundResult&quot;/&gt; if the project or group is not found.&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; AssignGroupToProject(int projectId, int groupId)
        {
            var project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == projectId);

            if (project == null)
                return NotFound();

            var group = await context.Groups.FindAsync(groupId);
            if (group == null)
                return NotFound();

            if (project.ProjectGroups.All(pg =&gt; pg.GroupId != groupId))
            {
                context.GroupProjects.Add(new GroupProject { ProjectId = projectId, GroupId = groupId });
                await context.SaveChangesAsync();
            }

            project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == projectId);

            var allGroups = await context.Groups.ToListAsync();
            var assignedGroupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            ViewBag.Groups = allGroups.Where(g =&gt; !assignedGroupIds.Contains(g.Id)).ToList();

            return PartialView(&quot;_ProjectGroupAssignmentPartial&quot;, project);
        }


        /// &lt;summary&gt;
        /// Removes a group from a specified project if it is currently assigned.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;projectId&quot;&gt;The ID of the project.&lt;/param&gt;
        /// &lt;param name=&quot;groupId&quot;&gt;The ID of the group to be removed.&lt;/param&gt;
        /// &lt;returns&gt;Redirects to the project details page if successful; otherwise, returns
        /// a &lt;see cref=&quot;NotFoundResult&quot;/&gt; if the project does not exist.&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; RemoveGroupFromProject(int projectId, int groupId)
        {
            var project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == projectId);

            if (project == null)
                return NotFound();

            var projectGroup = project.ProjectGroups.FirstOrDefault(pg =&gt; pg.GroupId == groupId);
            if (projectGroup != null)
            {
                context.GroupProjects.Remove(projectGroup);
                await context.SaveChangesAsync();
            }

            project = await context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == projectId);

            var allGroups = await context.Groups.ToListAsync();
            var assignedGroupIds = project.ProjectGroups.Select(pg =&gt; pg.GroupId).ToList();
            ViewBag.Groups = allGroups.Where(g =&gt; !assignedGroupIds.Contains(g.Id)).ToList();

            return PartialView(&quot;_ProjectGroupAssignmentPartial&quot;, project);
        }

        /// &lt;summary&gt;
        /// Retrieves the project details for editing.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the project to edit.&lt;/param&gt;
        /// &lt;returns&gt;Returns the edit view with the project details if found; otherwise, returns
        /// a &lt;see cref=&quot;NotFoundResult&quot;/&gt;.&lt;/returns&gt;
        public async Task&lt;IActionResult&gt; EditProject(int id)
        {
            var project = await context.Projects.FindAsync(id);
            if (project == null)
            {
                return NotFound();
            }

            ViewBag.ProjectLeads = await context.Users.ToListAsync();
            return View(project);
        }

        /// &lt;summary&gt;
        /// Updates the details of an existing project.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the project being edited.&lt;/param&gt;
        /// &lt;param name=&quot;project&quot;&gt;The updated project details.&lt;/param&gt;
        /// &lt;returns&gt;
        /// Redirects to the project details page if successful.
        /// If the ID does not match or the project does not exist, returns
        /// a &lt;see cref=&quot;BadRequestResult&quot;/&gt; or &lt;see cref=&quot;NotFoundResult&quot;/&gt;.
        /// If an error occurs, the edit view is returned with validation messages.
        /// &lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; EditProject(int id, Project project)
        {
            if (id != project.Id)
            {
                return BadRequest();
            }

            if (ModelState.IsValid)
            {
                try
                {
                    var currentUserId = userManager.GetUserId(User);

                    if (string.IsNullOrEmpty(currentUserId))
                    {
                        ModelState.AddModelError(&quot;&quot;, &quot;Unable to determine the logged-in user.&quot;);
                        return View(project);
                    }

                    project.ProjectCreatorId = int.Parse(currentUserId);

                    context.Update(project);
                    await context.SaveChangesAsync();

                    return RedirectToAction(&quot;ProjectDetails&quot;, new { id = project.Id });
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!context.Projects.Any(p =&gt; p.Id == project.Id))
                    {
                        return NotFound();
                    }
                    throw;
                }
            }

            ViewBag.ProjectLeads = await context.Users.ToListAsync();
            return View(project);
        }

        /// &lt;summary&gt;
        /// Deletes a specified project from the system.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the project to delete.&lt;/param&gt;
        /// &lt;returns&gt;Redirects to the project list after deletion.&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; DeleteProject(int id)
        {
            var project = await context.Projects.FindAsync(id);
            if (project != null)
            {
                context.Projects.Remove(project);
                await context.SaveChangesAsync();
            }
            return RedirectToAction(nameof(Projects));
        }

        /// &lt;summary&gt;
        /// Displays the edit page for a specific user.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the user.&lt;/param&gt;
        /// &lt;returns&gt;A view displaying user edit options or NotFound if the user does not exist.&lt;/returns&gt;
        public async Task&lt;IActionResult&gt; UserEdit(string id)
        {
            var user = await userManager.FindByIdAsync(id);
            if (user == null)
            {
                return NotFound();
            }

            var roles = roleManager.Roles.Select(r =&gt; r.Name).ToList();

            var userRoles = await userManager.GetRolesAsync(user);
            string currentRole = userRoles.FirstOrDefault();

            ViewBag.Roles = roles;
            ViewBag.CurrentRole = currentRole;

            return View(user);
        }

        /// &lt;summary&gt;
        /// Updates the details of a specific user, including their username, email, and role.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the user.&lt;/param&gt;
        /// &lt;param name=&quot;UserName&quot;&gt;The new username.&lt;/param&gt;
        /// &lt;param name=&quot;Email&quot;&gt;The new email address.&lt;/param&gt;
        /// &lt;param name=&quot;Role&quot;&gt;The new role to assign.&lt;/param&gt;
        /// &lt;returns&gt;A redirect to the Users list.&lt;/returns&gt;
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; UserEdit(string id, string UserName, string Email, string Role)
        {
            var user = await userManager.FindByIdAsync(id);
            if (user == null)
            {
                return NotFound();
            }

            user.UserName = UserName;
            user.Email = Email;
            await userManager.UpdateAsync(user);

            var userRoles = await userManager.GetRolesAsync(user);

            if (userRoles.Any())
            {
                await userManager.RemoveFromRolesAsync(user, userRoles);
            }

            if (!string.IsNullOrEmpty(Role))
            {
                await userManager.AddToRoleAsync(user, Role);
            }

            return RedirectToAction(&quot;Users&quot;);
        }

        /// &lt;summary&gt;
        /// Displays the confirmation page for deleting a user, checking if they are a manager of any groups.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the user.&lt;/param&gt;
        /// &lt;returns&gt;A view displaying the user and their related groups if applicable.&lt;/returns&gt;
        public async Task&lt;IActionResult&gt; UserDelete(int id)
        {
            var user = await context.Users.FindAsync(id);
            if (user == null)
            {
                return NotFound();
            }

            var managedGroups = await context.Groups
                .Where(g =&gt; g.ManagerId == id)
                .ToListAsync();

            var managedGroupIds = managedGroups.Select(g =&gt; g.Id).ToList();

            var projects = await context.GroupProjects
                .Where(gp =&gt; managedGroupIds.Contains(gp.GroupId)) 
                .Select(gp =&gt; gp.Project)
                .Distinct()
                .ToListAsync();

            var viewModel = new UserDeleteViewModel
            {
                User = user,
                RelatedGroups = managedGroups,
                RelatedProjects = projects
            };

            return View(viewModel);
        }

        /// &lt;summary&gt;
        /// Confirms and executes the deletion of a user along with related groups if they are a manager.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The ID of the user to be deleted.&lt;/param&gt;
        /// &lt;returns&gt;A redirect to the Users list.&lt;/returns&gt;
        [HttpPost, ActionName(&quot;DeleteConfirmed&quot;)]
        [ValidateAntiForgeryToken]
        public async Task&lt;IActionResult&gt; DeleteConfirmed(int id)
        {
            var user = await context.Users.FindAsync(id);
            if (user == null)
            {
                return NotFound();
            }

            var managedGroups = await context.Groups
                .Where(g =&gt; g.ManagerId == id)
                .ToListAsync();

            if (managedGroups.Any())
            {
                TempData[&quot;ErrorMessage&quot;] = &quot;Cannot delete this user because they are a manager of a group or a group they manage is referenced in a project.&quot;;
                return RedirectToAction(nameof(UserDelete), new { id });
            }

            context.Users.Remove(user);
            await context.SaveChangesAsync();

            return RedirectToAction(nameof(Users));
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[19,18,19,138,1],[26,9,26,10,1],[27,13,27,59,1],[28,13,28,32,1],[29,9,29,10,1],[37,9,37,10,1],[38,13,38,27,1],[39,9,39,10,1],[49,9,49,10,1],[50,13,50,37,1],[51,17,51,36,0],[53,13,53,91,1],[55,13,55,88,1],[57,13,57,44,1],[58,13,58,14,1],[59,17,59,95,1],[60,17,60,52,1],[61,17,61,18,1],[62,21,62,63,1],[65,17,65,24,1],[65,26,65,35,1],[65,36,65,38,1],[65,39,65,66,1],[66,17,66,18,1],[67,21,67,96,1],[68,21,68,79,1],[69,17,69,18,1],[70,13,70,14,1],[72,13,72,20,1],[72,22,72,31,1],[72,32,72,34,1],[72,35,72,58,1],[73,13,73,14,1],[74,17,74,92,1],[75,17,75,75,1],[76,13,76,14,1],[78,13,78,32,1],[79,9,79,10,1],[90,9,90,10,1],[91,13,91,58,1],[93,13,93,30,1],[94,13,94,14,1],[95,17,95,35,1],[98,13,98,31,1],[99,9,99,10,1],[106,9,106,10,1],[107,13,107,61,1],[108,13,108,33,1],[109,9,109,10,1],[117,9,117,10,1],[118,13,118,48,1],[120,13,120,39,1],[122,13,122,27,1],[123,9,123,10,1],[129,9,129,10,1],[130,13,130,37,1],[131,13,131,14,0],[132,17,132,71,0],[133,17,133,36,0],[136,13,136,82,1],[137,13,137,33,1],[138,13,138,14,1],[139,17,139,103,1],[140,17,140,71,1],[141,17,141,36,1],[144,13,149,15,1],[151,13,151,39,1],[152,13,152,46,1],[154,13,154,49,1],[155,13,155,14,1],[156,17,161,19,1],[162,17,162,54,1],[163,13,163,14,1],[165,13,167,32,1],[169,13,169,20,1],[169,22,169,34,1],[169,35,169,37,1],[169,38,169,47,1],[170,13,170,14,1],[171,17,176,20,1],[177,13,177,14,1],[179,13,179,46,1],[180,13,180,47,1],[181,9,181,10,1],[191,9,191,10,1],[192,13,192,60,1],[193,13,193,31,1],[194,13,194,14,1],[195,17,195,57,1],[199,13,199,14,1],[200,17,200,46,1],[201,17,201,50,1],[202,13,202,14,1],[203,13,203,38,0],[204,13,204,14,0],[205,17,205,136,0],[206,13,206,14,0],[208,13,208,53,1],[209,9,209,10,1],[219,9,219,10,1],[220,13,222,55,1],[224,13,224,31,1],[225,17,225,35,1],[227,13,230,32,1],[232,13,232,62,1],[234,13,235,29,1],[235,29,235,50,1],[235,50,235,67,1],[235,67,235,123,1],[235,123,236,27,1],[238,13,239,29,1],[239,29,239,78,1],[239,78,240,27,1],[242,13,242,48,1],[243,13,243,59,1],[244,13,244,45,1],[246,13,246,32,1],[247,9,247,10,1],[258,9,258,10,1],[259,13,259,65,1],[260,13,260,62,1],[262,13,262,47,1],[263,13,263,14,1],[264,17,264,35,1],[267,13,267,121,1],[268,13,268,33,1],[269,13,269,14,1],[270,17,275,20,1],[277,17,277,50,1],[278,13,278,14,1],[280,13,280,84,1],[281,13,284,32,1],[285,13,285,62,1],[287,13,288,29,1],[288,29,288,50,1],[288,50,288,67,1],[288,67,288,123,1],[288,123,289,27,1],[291,13,291,48,1],[292,13,292,45,1],[294,13,294,70,1],[295,9,295,10,1],[300,9,300,10,0],[301,13,301,131,0],[302,13,302,40,0],[303,13,303,14,0],[304,17,304,59,0],[305,17,305,50,0],[306,13,306,14,0],[308,13,308,88,0],[309,13,312,32,0],[313,13,313,62,0],[315,13,316,29,0],[316,29,316,50,0],[316,50,316,67,0],[316,67,316,123,0],[316,123,317,27,0],[319,13,319,48,0],[320,13,320,45,0],[322,13,322,70,0],[323,9,323,10,0],[335,9,335,10,1],[336,13,336,88,1],[337,13,337,65,1],[339,13,339,47,1],[340,13,340,14,1],[341,17,341,35,1],[344,13,345,93,1],[347,13,347,40,1],[348,13,348,14,1],[349,17,354,19,1],[355,17,355,56,1],[356,13,356,14,1],[358,13,358,14,0],[359,17,359,49,0],[360,17,360,59,0],[361,13,361,14,0],[363,13,363,27,1],[364,13,364,14,1],[365,17,365,45,1],[366,13,366,14,1],[368,13,368,46,1],[369,13,369,75,1],[370,9,370,10,1],[375,9,375,10,0],[376,13,378,60,0],[380,13,380,31,0],[381,13,381,14,0],[382,17,382,35,0],[385,13,385,74,0],[386,13,386,36,0],[387,13,387,14,0],[388,17,388,35,0],[391,13,392,96,0],[394,13,394,41,0],[395,13,395,14,0],[396,17,401,19,0],[402,17,402,57,0],[403,13,403,14,0],[405,13,405,14,0],[406,17,406,50,0],[407,17,407,60,0],[408,13,408,14,0],[410,13,410,42,0],[411,13,411,14,0],[412,17,413,103,0],[415,17,415,50,0],[416,17,416,18,0],[417,21,417,58,0],[418,21,418,69,0],[419,17,419,18,0],[420,13,420,14,0],[422,13,422,44,0],[423,13,423,46,0],[425,13,425,75,0],[426,9,426,10,0],[439,9,439,10,1],[440,13,440,65,1],[441,13,441,35,1],[442,9,442,10,1],[449,9,449,10,1],[450,13,450,59,1],[453,13,455,50,1],[455,50,459,18,1],[459,18,460,15,1],[462,13,462,32,1],[463,9,463,10,1],[476,9,476,10,1],[477,13,477,37,1],[478,13,478,14,1],[479,17,479,63,1],[480,17,480,56,1],[480,56,484,18,0],[484,18,484,29,1],[486,17,486,36,1],[489,13,489,61,1],[491,13,491,53,1],[492,13,492,14,1],[493,17,493,89,1],[495,17,495,63,1],[496,17,496,56,1],[496,56,500,18,0],[500,18,500,29,1],[502,17,502,36,1],[505,13,511,15,1],[513,13,513,43,1],[514,13,514,46,1],[516,13,516,55,1],[517,9,517,10,1],[528,9,528,10,1],[529,13,533,55,1],[535,13,535,33,1],[536,13,536,14,1],[537,17,537,35,1],[539,13,539,65,0],[540,13,540,34,0],[541,9,541,10,1],[553,9,553,10,1],[554,13,557,62,1],[559,13,559,33,1],[560,17,560,35,1],[562,13,562,65,1],[563,13,563,31,1],[564,17,564,35,1],[566,13,566,49,1],[566,49,566,70,1],[566,70,566,72,1],[567,13,567,14,1],[568,17,568,106,1],[569,17,569,50,1],[570,13,570,14,1],[572,13,575,62,1],[577,13,577,64,1],[578,13,578,71,1],[578,71,578,81,1],[578,81,578,92,1],[579,13,579,51,1],[579,51,579,83,1],[579,83,579,94,1],[581,13,581,75,1],[582,9,582,10,1],[595,9,595,10,1],[596,13,599,62,1],[601,13,601,33,1],[602,17,602,35,1],[604,13,604,75,1],[604,75,604,96,1],[604,96,604,98,1],[605,13,605,38,1],[606,13,606,14,1],[607,17,607,60,1],[608,17,608,50,1],[609,13,609,14,1],[611,13,614,62,1],[616,13,616,64,1],[617,13,617,71,1],[617,71,617,81,0],[617,81,617,92,1],[618,13,618,51,1],[618,51,618,83,0],[618,83,618,94,1],[620,13,620,75,1],[621,9,621,10,1],[630,9,630,10,1],[631,13,631,64,1],[632,13,632,33,1],[633,13,633,14,1],[634,17,634,35,1],[637,13,637,70,1],[638,13,638,34,1],[639,9,639,10,1],[655,9,655,10,1],[656,13,656,34,1],[657,13,657,14,1],[658,17,658,37,1],[661,13,661,36,1],[662,13,662,14,1],[664,17,664,18,1],[665,21,665,69,1],[667,21,667,61,1],[668,21,668,22,1],[669,25,669,97,1],[670,25,670,46,1],[673,21,673,73,1],[675,21,675,45,1],[676,21,676,54,1],[678,21,678,88,1],[680,17,680,53,1],[681,17,681,18,1],[682,21,682,72,1],[683,21,683,22,1],[684,25,684,43,1],[686,21,686,27,0],[690,13,690,70,0],[691,13,691,34,0],[692,9,692,10,1],[702,9,702,10,1],[703,13,703,64,1],[704,13,704,33,1],[705,13,705,14,1],[706,17,706,50,1],[707,17,707,50,1],[708,13,708,14,1],[709,13,709,55,1],[710,9,710,10,1],[718,9,718,10,1],[719,13,719,60,1],[720,13,720,30,1],[721,13,721,14,1],[722,17,722,35,1],[725,13,725,72,1],[727,13,727,67,1],[728,13,728,61,1],[730,13,730,35,1],[731,13,731,47,1],[733,13,733,31,1],[734,9,734,10,1],[747,9,747,10,1],[748,13,748,60,1],[749,13,749,30,1],[750,13,750,14,1],[751,17,751,35,1],[754,13,754,38,1],[755,13,755,32,1],[756,13,756,49,1],[758,13,758,67,1],[760,13,760,33,1],[761,13,761,14,1],[762,17,762,73,1],[763,13,763,14,1],[765,13,765,45,1],[766,13,766,14,1],[767,17,767,62,1],[768,13,768,14,1],[770,13,770,46,1],[771,9,771,10,1],[779,9,779,10,1],[780,13,780,58,1],[781,13,781,30,1],[782,13,782,14,1],[783,17,783,35,1],[786,13,788,32,1],[790,13,790,61,1],[790,61,790,65,0],[790,65,790,76,1],[792,13,796,32,1],[798,13,803,15,1],[805,13,805,36,1],[806,9,806,10,1],[816,9,816,10,1],[817,13,817,58,1],[818,13,818,30,1],[819,13,819,14,0],[820,17,820,35,0],[823,13,825,32,1],[827,13,827,37,1],[828,13,828,14,0],[829,17,829,159,0],[830,17,830,73,0],[833,13,833,40,1],[834,13,834,46,1],[836,13,836,52,1],[837,9,837,10,1]]);
    </script>
  </body>
</html>