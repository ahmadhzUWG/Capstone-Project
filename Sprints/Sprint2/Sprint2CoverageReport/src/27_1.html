<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Nick\Desktop\Capstone-Project\code\TaskManager.Tests\Tests\TestControllers\AdminControllerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.AspNetCore.Mvc.ViewFeatures;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Moq;
using TaskManager.Tests;
using TaskManagerWebsite.Controllers;
using TaskManagerWebsite.Data;
using TaskManagerWebsite.Models;
using TaskManagerWebsite.ViewModels;
using TaskManagerWebsite.ViewModels.ProjectViewModels;
using Xunit;

public class AdminControllerTests
{
    private readonly Mock&lt;UserManager&lt;User&gt;&gt; _mockUserManager;
    private readonly Mock&lt;RoleManager&lt;IdentityRole&lt;int&gt;&gt;&gt; _mockRoleManager;
    private readonly ApplicationDbContext _dbContext;

    public AdminControllerTests()
    {
        _mockUserManager = GetMockUserManager();
        _mockRoleManager = GetMockRoleManager();
        _dbContext = TestHelper.GetDbContext();

        // Setup some default roles for the RoleManager
        var mockRoles = new List&lt;IdentityRole&lt;int&gt;&gt;
        {
            new IdentityRole&lt;int&gt; { Id = 1, Name = &quot;Admin&quot; },
            new IdentityRole&lt;int&gt; { Id = 2, Name = &quot;Manager&quot; },
            new IdentityRole&lt;int&gt; { Id = 3, Name = &quot;Employee&quot; }
        }.AsQueryable();
        _mockRoleManager.Setup(rm =&gt; rm.Roles).Returns(mockRoles);

        _mockUserManager.Setup(um =&gt; um.GetRolesAsync(It.IsAny&lt;User&gt;()))
            .ReturnsAsync(new List&lt;string&gt; { &quot;Admin&quot;, &quot;Manager&quot;, &quot;Employee&quot; });
    }

    private Mock&lt;UserManager&lt;User&gt;&gt; GetMockUserManager()
    {
        var userStoreMock = new Mock&lt;IUserStore&lt;User&gt;&gt;();
        return new Mock&lt;UserManager&lt;User&gt;&gt;(userStoreMock.Object,
            null, null, null, null, null, null, null, null);
    }

    private Mock&lt;RoleManager&lt;IdentityRole&lt;int&gt;&gt;&gt; GetMockRoleManager()
    {
        var roleStoreMock = new Mock&lt;IRoleStore&lt;IdentityRole&lt;int&gt;&gt;&gt;();
        return new Mock&lt;RoleManager&lt;IdentityRole&lt;int&gt;&gt;&gt;(roleStoreMock.Object,
            null, null, null, null);
    }

    // ––– Tests for User-related endpoints –––

    [Fact]
    public async Task Users_ReturnsViewWithUserList()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        dbContext.Users.Add(new User { Id = 1, UserName = &quot;User1&quot;, Email = &quot;user1@example.com&quot; });
        dbContext.Users.Add(new User { Id = 2, UserName = &quot;User2&quot;, Email = &quot;user2@example.com&quot; });
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.Users();

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        var users = Assert.IsAssignableFrom&lt;IEnumerable&lt;User&gt;&gt;(viewResult.Model);
        Assert.Equal(2, users.Count());
    }

    [Fact]
    public async Task UserEdit_ReturnsNotFound_WithNoFoundUser()
    {
        var controller = new AdminController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        var result = await controller.UserEdit(&quot;999&quot;);

        Assert.IsType&lt;NotFoundResult&gt;(result);
    }

    [Fact]
    public async Task UserEdit_ReturnsViewResult_WithValidUser()
    {
        var controller = new AdminController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);
        var user = new User { Id = 1, UserName = &quot;User1&quot;, Email = &quot;user1@example.com&quot; };
        await _dbContext.Users.AddAsync(user);
        await _dbContext.SaveChangesAsync();

        _mockUserManager.Setup(um =&gt; um.FindByIdAsync(user.Id.ToString())).ReturnsAsync(user);
        _mockUserManager.Setup(um =&gt; um.GetRolesAsync(user)).ReturnsAsync(new List&lt;string&gt; { &quot;Admin&quot; });

        _mockRoleManager.Setup(rm =&gt; rm.Roles).Returns(new List&lt;IdentityRole&lt;int&gt;&gt;
        {
            new IdentityRole&lt;int&gt; { Name = &quot;Admin&quot; },
            new IdentityRole&lt;int&gt; { Name = &quot;User&quot; }
        }.AsQueryable());

        var result = await controller.UserEdit(user.Id.ToString());

        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        var model = Assert.IsType&lt;User&gt;(viewResult.Model);
        Assert.Equal(user.Id, model.Id);
        Assert.Equal(user.UserName, model.UserName);

        Assert.NotNull(controller.ViewBag.Roles);
        Assert.Contains(&quot;Admin&quot;, controller.ViewBag.Roles);
        Assert.Equal(&quot;Admin&quot;, controller.ViewBag.CurrentRole);
    }

    [Fact]
    public async Task UserAdd_ReturnsViewResult()
    {
        var controller = new AdminController(_dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        var result = controller.UserAdd();

        Assert.IsType&lt;ViewResult&gt;(result);
    }

    [Fact]
    public async Task UserDetails_ReturnsViewWithUser_IfExists()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var user = new User { Id = 10, UserName = &quot;DetailUser&quot;, Email = &quot;detail@example.com&quot; };
        dbContext.Users.Add(user);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.UserDetails(10);

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        var modelUser = Assert.IsType&lt;User&gt;(viewResult.Model);
        Assert.Equal(&quot;DetailUser&quot;, modelUser.UserName);
    }

    [Fact]
    public async Task UserDetails_ReturnsNotFound_IfUserDoesNotExist()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.UserDetails(999);

        // Assert
        Assert.IsType&lt;NotFoundResult&gt;(result);
    }

    [Fact]
    public async Task UserDelete_ReturnsViewIfUserExists()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var user = new User { Id = 100, UserName = &quot;DeleteUser&quot;, Email = &quot;delete@example.com&quot; };
        dbContext.Users.Add(user);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.UserDelete(100);

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        var modelUser = Assert.IsType&lt;UserDeleteViewModel&gt;(viewResult.Model);
        Assert.Equal(&quot;DeleteUser&quot;, modelUser.User.UserName);
    }

    [Fact]
    public async Task UserDelete_ReturnsNotFoundIfUserDoesNotExist()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.UserDelete(999);

        // Assert
        Assert.IsType&lt;NotFoundResult&gt;(result);
    }

    [Fact]
    public async Task DeleteConfirmed_DeletesUserAndRedirects()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var user = new User { Id = 200, UserName = &quot;ConfirmedUser&quot;, Email = &quot;confirmed@example.com&quot; };
        dbContext.Users.Add(user);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.DeleteConfirmed(200);

        // Assert
        var redirectResult = Assert.IsType&lt;RedirectToActionResult&gt;(result);
        Assert.False(dbContext.Users.Any(u =&gt; u.Id == 200));
    }

    // ––– Tests for Group-related endpoints –––

    [Fact]
    public async Task Groups_ReturnsViewWithGroupList()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        dbContext.Groups.Add(new Group { Id = 1, Name = &quot;Group1&quot;, Description = &quot;Test Description&quot; });
        dbContext.Groups.Add(new Group { Id = 2, Name = &quot;Group2&quot;, Description = &quot;Test Description&quot; });
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.Groups();

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        var groups = Assert.IsAssignableFrom&lt;IEnumerable&lt;Group&gt;&gt;(viewResult.Model);
        Assert.Equal(2, groups.Count());
    }

    [Fact]
    public void CreateGroup_Get_ReturnsViewWithManagersAndEmployees()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        // Add users for testing
        var employeeUser = new User { Id = 2, UserName = &quot;EmployeeUser&quot;, Email = &quot;employee@example.com&quot; };
        dbContext.Users.Add(employeeUser);
        dbContext.SaveChanges();

        // Setup IsInRoleAsync so that user 1 is Manager and user 2 is Employee
        _mockUserManager.Setup(um =&gt; um.IsInRoleAsync(It.Is&lt;User&gt;(u =&gt; u.Id == 1), &quot;Manager&quot;))
            .ReturnsAsync(true);
        _mockUserManager.Setup(um =&gt; um.IsInRoleAsync(It.Is&lt;User&gt;(u =&gt; u.Id == 2), &quot;Manager&quot;))
            .ReturnsAsync(false);
        _mockUserManager.Setup(um =&gt; um.IsInRoleAsync(It.Is&lt;User&gt;(u =&gt; u.Id == 1), &quot;Employee&quot;))
            .ReturnsAsync(false);
        _mockUserManager.Setup(um =&gt; um.IsInRoleAsync(It.Is&lt;User&gt;(u =&gt; u.Id == 2), &quot;Employee&quot;))
            .ReturnsAsync(true);

        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Setup HttpContext with required TempData services.
        var httpContext = new DefaultHttpContext();
        // Create a minimal service provider with a dummy ITempDataProvider.
        var services = new ServiceCollection()
            .AddSingleton&lt;ITempDataProvider&gt;(new Mock&lt;ITempDataProvider&gt;().Object)
            .AddSingleton(_mockUserManager.Object)  // Register your mock UserManager
            .BuildServiceProvider();
        httpContext.RequestServices = services;

        controller.ControllerContext.HttpContext = httpContext;
        controller.TempData = new TempDataDictionary(httpContext, services.GetRequiredService&lt;ITempDataProvider&gt;());

        // Act
        var result = controller.CreateGroup();

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        Assert.NotNull(viewResult.ViewData[&quot;Employees&quot;]);
        var employees = viewResult.ViewData[&quot;Employees&quot;] as List&lt;User&gt;;
        Assert.Single(employees);
        Assert.Equal(&quot;EmployeeUser&quot;, employees.First().UserName);
    }

    [Fact]
    public async Task GroupDetails_ReturnsNotFoundIfGroupDoesNotExist()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.GroupDetails(999);

        // Assert
        Assert.IsType&lt;NotFoundResult&gt;(result);
    }

    [Fact]
    public async Task GroupDetails_ReturnsViewWithUsersAndManagers()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var group = new Group
        {
            Id = 40,
            Name = &quot;GroupDetails&quot;,
            Description = &quot;Test Description&quot;
        };
        dbContext.Groups.Add(group);

        var managerUser = new User { Id = 1, UserName = &quot;ManagerUser&quot;, Email = &quot;manager@example.com&quot; };
        var employeeUser = new User { Id = 2, UserName = &quot;EmployeeUser&quot;, Email = &quot;employee@example.com&quot; };
        dbContext.Users.AddRange(managerUser, employeeUser);

        // ✅ Add users to `UserGroups` instead of `Group.Users`
        dbContext.UserGroups.Add(new UserGroup { GroupId = 40, UserId = 1, Role = &quot;Manager&quot; });
        dbContext.UserGroups.Add(new UserGroup { GroupId = 40, UserId = 2, Role = &quot;Member&quot; });

        await dbContext.SaveChangesAsync();

        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.GroupDetails(40);

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        var modelGroup = Assert.IsType&lt;Group&gt;(viewResult.Model);
        Assert.Equal(&quot;GroupDetails&quot;, modelGroup.Name);

        Assert.NotNull(viewResult.ViewData[&quot;GroupUsers&quot;]);
        var groupUsers = viewResult.ViewData[&quot;GroupUsers&quot;] as List&lt;UserGroup&gt;;
        Assert.NotNull(groupUsers);
        Assert.Equal(2, groupUsers.Count);

        Assert.Contains(groupUsers, gu =&gt; gu.UserId == 1 &amp;&amp; gu.Role == &quot;Manager&quot;);
        Assert.Contains(groupUsers, gu =&gt; gu.UserId == 2 &amp;&amp; gu.Role == &quot;Member&quot;);
    }

    [Fact]
    public async Task CreateGroup_Post_InvalidPrimaryManager_ReturnsViewWithError()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();

        var groupViewModel = new GroupViewModel
        { 
            Name = &quot;NewGroup&quot;,
            Description = &quot;Test Description&quot;,
            SelectedManagerId = 9,
            SelectedUserIds = [3]
        };
        // Use an invalid primaryManagerId (0)
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Create a service collection with necessary registrations.
        var services = new ServiceCollection()
            .AddSingleton&lt;ITempDataProvider&gt;(new Mock&lt;ITempDataProvider&gt;().Object)
            .AddSingleton&lt;UserManager&lt;User&gt;&gt;(_mockUserManager.Object)  // Register your mocked UserManager
            .BuildServiceProvider();

        // Create and configure a DefaultHttpContext with the service provider.
        var httpContext = new DefaultHttpContext();
        httpContext.RequestServices = services;
        controller.ControllerContext.HttpContext = httpContext;

        // Manually create and set the TempData to avoid DI lookup for ITempDataDictionaryFactory.
        var tempDataProvider = services.GetRequiredService&lt;ITempDataProvider&gt;();
        controller.TempData = new TempDataDictionary(httpContext, tempDataProvider);

        // Act
        var result = await controller.CreateGroup(groupViewModel);

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        Assert.False(controller.ModelState.IsValid);
    }

    [Fact]
    public async Task CreateGroup_Post_Valid_ReturnsRedirect()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        // Add a primary manager and other users
        var primaryManager = new User { Id = 1, UserName = &quot;Manager&quot;, Email = &quot;pm@example.com&quot; };
        var otherManager = new User { Id = 2, UserName = &quot;OtherManager&quot;, Email = &quot;om@example.com&quot; };
        var employee = new User { Id = 3, UserName = &quot;Employee&quot;, Email = &quot;emp@example.com&quot; };
        dbContext.Users.AddRange(primaryManager, otherManager, employee);
        await dbContext.SaveChangesAsync();

        var groupViewModel = new GroupViewModel
        {
            Name = &quot;NewGroup&quot;,
            Description = &quot;Test Description&quot;,
            SelectedManagerId = 1,
            SelectedUserIds = [3]
        };

        // Create the controller with required mocked dependencies.
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Build a service provider with necessary services.
        var services = new ServiceCollection()
            .AddSingleton&lt;ITempDataProvider&gt;(new Mock&lt;ITempDataProvider&gt;().Object)
            .AddSingleton&lt;UserManager&lt;User&gt;&gt;(_mockUserManager.Object)
            .BuildServiceProvider();

        // Set up the HttpContext with the service provider.
        var httpContext = new DefaultHttpContext { RequestServices = services };
        controller.ControllerContext.HttpContext = httpContext;

        // Manually create and assign TempData to avoid DI lookup for ITempDataDictionaryFactory.
        var tempDataProvider = services.GetRequiredService&lt;ITempDataProvider&gt;();
        controller.TempData = new TempDataDictionary(httpContext, tempDataProvider);

        // Assign a mocked IUrlHelper to bypass IUrlHelperFactory resolution when RedirectToAction is called.
        var mockUrlHelper = new Mock&lt;IUrlHelper&gt;();
        controller.Url = mockUrlHelper.Object;

        // Act
        var result = await controller.CreateGroup(groupViewModel);

        // Assert
        var redirectResult = Assert.IsType&lt;RedirectToActionResult&gt;(result);
        Assert.Equal(&quot;Groups&quot;, redirectResult.ActionName);
        Assert.Equal(1, groupViewModel.SelectedManagerId);
        Assert.Contains(3, groupViewModel.SelectedUserIds);
    }

    [Fact]
    public async Task DeleteGroup_RemovesGroupIfExists()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var group = new Group { Id = 20, Name = &quot;GroupToDelete&quot;, Description = &quot;Test Description&quot;};
        dbContext.Groups.Add(group);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.DeleteGroup(20);

        // Assert
        var redirectResult = Assert.IsType&lt;RedirectToActionResult&gt;(result);
        Assert.False(dbContext.Groups.Any(g =&gt; g.Id == 20));
    }

    [Fact]
    public async Task DeleteGroup_RedirectsIfGroupNotFound()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.DeleteGroup(999);

        // Assert
        Assert.IsType&lt;RedirectToActionResult&gt;(result);
    }

    [Fact]
    public async Task AddUserToGroup_ReturnsNotFound_IfGroupOrUserNotFound()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act – group not found
        var result1 = await controller.AddUserToGroup(1, 1);
        Assert.IsType&lt;NotFoundResult&gt;(result1);

        dbContext.Groups.Add(new Group { Id = 50, Name = &quot;AddUserGroup&quot;, Description = &quot;Test Description&quot; });
        await dbContext.SaveChangesAsync();

        var result2 = await controller.AddUserToGroup(50, 99);
        Assert.IsType&lt;NotFoundResult&gt;(result2);
    }

    [Fact]
    public async Task AddUserToGroup_AddsUserIfNotAlreadyAdded()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var group = new Group { Id = 60, Name = &quot;UserGroup&quot;, Description = &quot;Test Description&quot; };
        var user = new User { Id = 10, UserName = &quot;GroupUser&quot;, Email = &quot;groupuser@example.com&quot; };
        dbContext.Groups.Add(group);
        dbContext.Users.Add(user);
        await dbContext.SaveChangesAsync();

        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.AddUserToGroup(60, 10);

        // Assert
        var redirectResult = Assert.IsType&lt;PartialViewResult&gt;(result);
        Assert.Equal(&quot;_GroupUserAssignmentPartial&quot;, redirectResult.ViewName);

        // ✅ Check in `UserGroups`
        Assert.Contains(dbContext.UserGroups, ug =&gt; ug.GroupId == 60 &amp;&amp; ug.UserId == 10 &amp;&amp; ug.Role == &quot;Member&quot;);
    }

    [Fact]
    public async Task AddManagerToGroup_ReturnsNotFound_IfGroupOrUserNotFound()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act – group not found
        var result1 = await controller.AddManagerToGroup(1, 1, false);
        Assert.IsType&lt;NotFoundResult&gt;(result1);

        // Add group but not user
        dbContext.Groups.Add(new Group
        {
            Id = 70,
            Name = &quot;ManagerGroup&quot;,
            Description = &quot;Test description&quot;,
            Managers = new List&lt;GroupManager&gt;()
        });
        await dbContext.SaveChangesAsync();
        var result2 = await controller.AddManagerToGroup(70, 99, false);
        Assert.IsType&lt;NotFoundResult&gt;(result2);
    }

    [Fact]
    public async Task AddManagerToGroup_AddsManagerAndSetsPrimaryIfTrue()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var group = new Group
        {
            Id = 80,
            Name = &quot;ManagerGroup&quot;,
            Description = &quot;Test Description&quot;,
            Managers = new List&lt;GroupManager&gt;()
        };
        var user = new User
        {
            Id = 20,
            UserName = &quot;ManagerUser&quot;,
            Email = &quot;manager@example.com&quot;
        };
        var groupManager = new GroupManager
        {
            GroupId = 80,
            UserId = 20
        };
        dbContext.Groups.Add(group);
        dbContext.Users.Add(user);
        dbContext.GroupManagers.Add(groupManager);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.AddManagerToGroup(80, 20, true);

        // Assert
        var redirectResult = Assert.IsType&lt;RedirectToActionResult&gt;(result);
        Assert.Equal(&quot;GroupDetails&quot;, redirectResult.ActionName);
        Assert.Contains(dbContext.GroupManagers, gm =&gt; gm.GroupId == 80 &amp;&amp; gm.UserId == 20);
        Assert.Equal(20, group.ManagerId);
    }


    // ––– Tests for Project-related endpoints –––

    [Fact]
    public async Task Projects_ReturnsViewWithProjectsList()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        dbContext.Projects.Add(new Project { Id = 1, Name = &quot;Project1&quot;, Description = &quot;Test Description&quot; });
        dbContext.Projects.Add(new Project { Id = 2, Name = &quot;Project2&quot;, Description = &quot;Test Description&quot; });
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.Projects();

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        var projects = Assert.IsAssignableFrom&lt;IEnumerable&lt;Project&gt;&gt;(viewResult.Model);
        Assert.Equal(2, projects.Count());
    }

    [Fact]
    public async Task CreateProject_Get_ReturnsViewWithProjectLeads()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        dbContext.Users.Add(new User { Id = 1, UserName = &quot;Lead1&quot;, Email = &quot;lead1@example.com&quot; });
        dbContext.Users.Add(new User { Id = 2, UserName = &quot;Lead2&quot;, Email = &quot;lead2@example.com&quot; });
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        CreateProjectViewModel model = new CreateProjectViewModel
        {
            ProjectLeads = new List&lt;SelectListItem&gt;
            {
                new SelectListItem { Value = &quot;1&quot;, Text = &quot;Lead1&quot; },
                new SelectListItem { Value = &quot;2&quot;, Text = &quot;Lead2&quot; }
            }
        };

        // Act
        var result = await controller.CreateProject();

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        Assert.NotNull(model.ProjectLeads);
        Assert.Equal(2, model.ProjectLeads.Count);
    }

    [Fact]
    public async Task CreateProject_Post_InvalidModel_ReturnsView()
    {
        CreateProjectViewModel model = new CreateProjectViewModel();
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);
        controller.ModelState.AddModelError(&quot;Error&quot;, &quot;Invalid&quot;);
        var project = new Project { Id = 1, Name = &quot;InvalidProject&quot; };
        var users = await dbContext.Users.ToListAsync();

        model.ProjectLeads = users.Select(u =&gt; new SelectListItem
        {
            Value = u.Id.ToString(),
            Text = u.UserName
        }).ToList();

        CreateProjectViewModel viewModel = new CreateProjectViewModel
        {
            ProjectLeads = new List&lt;SelectListItem&gt;
            {
                new SelectListItem { Value = &quot;1&quot;, Text = &quot;Lead1&quot; },
                new SelectListItem { Value = &quot;2&quot;, Text = &quot;Lead2&quot; }
            }
        };
        // Act
        var result = await controller.CreateProject(viewModel);

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        Assert.Equal(viewModel, viewResult.Model);
    }

    [Fact]
    public async Task CreateProject_Post_WithoutUserId_ReturnsViewWithError()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);
        _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(string.Empty);
        var project = new Project { Id = 1, Name = &quot;ProjectNoUser&quot; };
        var users = await dbContext.Users.ToListAsync();

        CreateProjectViewModel model = new CreateProjectViewModel
        {
            ProjectLeads = users.Select(u =&gt; new SelectListItem
            {
                Value = u.Id.ToString(),
                Text = u.UserName
            }).ToList()
        };

        // Act
        var result = await controller.CreateProject(model);

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        Assert.False(controller.ModelState.IsValid);
        Assert.Contains(&quot;&quot;, controller.ModelState.Keys);
    }

    [Fact]
    public async Task CreateProject_Post_Valid_ReturnsRedirect()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Setup the UserManager mock to return a user id.
        _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(&quot;1&quot;);

        // Create a test user with the required claim.
        var claims = new List&lt;Claim&gt; { new Claim(ClaimTypes.NameIdentifier, &quot;1&quot;) };
        controller.ControllerContext.HttpContext = new DefaultHttpContext
        {
            User = new ClaimsPrincipal(new ClaimsIdentity(claims, &quot;TestAuth&quot;))
        };

        // Build a service provider with necessary services (TempData, etc.)
        var services = new ServiceCollection()
            .AddSingleton&lt;ITempDataProvider&gt;(new Mock&lt;ITempDataProvider&gt;().Object)
            .BuildServiceProvider();

        // Configure HttpContext and TempData.
        controller.ControllerContext.HttpContext.RequestServices = services;
        controller.TempData = new TempDataDictionary(controller.ControllerContext.HttpContext,
            services.GetRequiredService&lt;ITempDataProvider&gt;());

        var mockUrlHelper = new Mock&lt;IUrlHelper&gt;();
        controller.Url = mockUrlHelper.Object;

        var users = await dbContext.Users.ToListAsync();

        CreateProjectViewModel model = new CreateProjectViewModel
        {
            Name = &quot;ValidProject&quot;,
            Description = &quot;Test Description&quot;,
            ProjectLeads = users.Select(u =&gt; new SelectListItem
            {
                Value = u.Id.ToString(),
                Text = u.UserName
            }).ToList()
        };

        // Act
        var result = await controller.CreateProject(model);

        // Assert
        var redirectResult = Assert.IsType&lt;RedirectToActionResult&gt;(result);
        Assert.Equal(&quot;Projects&quot;, redirectResult.ActionName);
        Assert.True(dbContext.Projects.Any(p =&gt; p.Name == &quot;ValidProject&quot;));
    }


    [Fact]
    public async Task ProjectDetails_ReturnsNotFoundIfProjectDoesNotExist()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.ProjectDetails(9999);

        // Assert
        Assert.IsType&lt;NotFoundResult&gt;(result);
    }

    [Fact]
    public async Task AssignGroupToProject_ReturnsNotFound_IfProjectOrGroupNotFound()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act: project not found
        var result1 = await controller.AssignGroupToProject(1, 1);
        Assert.IsType&lt;NotFoundResult&gt;(result1);

        // Add a project but not group
        dbContext.Projects.Add(new Project { Id = 1, Name = &quot;AssignProject&quot;, Description = &quot;Test Description&quot;});
        await dbContext.SaveChangesAsync();
        var result2 = await controller.AssignGroupToProject(1, 99);
        Assert.IsType&lt;NotFoundResult&gt;(result2);
    }

    [Fact]
    public async Task AssignGroupToProject_AddsGroupWhenNotAssigned()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var project = new Project { Id = 1, Name = &quot;AssignProject&quot;, ProjectGroups = new List&lt;GroupProject&gt;(), Description = &quot;Test Description&quot;};
        var group = new Group { Id = 10, Name = &quot;TestGroup&quot;, Description = &quot;Test Description&quot; };
        dbContext.Projects.Add(project);
        dbContext.Groups.Add(group);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.AssignGroupToProject(1, 10);

        // Assert
        var redirectResult = Assert.IsType&lt;PartialViewResult&gt;(result);
        Assert.Equal(&quot;_ProjectGroupAssignmentPartial&quot;, redirectResult.ViewName);
        Assert.Contains(project.ProjectGroups, pg =&gt; pg.GroupId == 10);
    }

    [Fact]
    public async Task AssignGroupToProject_DoesNotAddDuplicateGroup()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var groupProject = new GroupProject { ProjectId = 1, GroupId = 10 };
        var project = new Project { Id = 1, Name = &quot;AssignProject&quot;, ProjectGroups = new List&lt;GroupProject&gt; { groupProject } , Description = &quot;Test Description&quot; };
        var group = new Group { Id = 10, Name = &quot;TestGroup&quot; , Description = &quot;Test Description&quot; };
        dbContext.Projects.Add(project);
        dbContext.Groups.Add(group);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act – calling assign again should not duplicate the group assignment
        var result = await controller.AssignGroupToProject(1, 10);

        // Assert
        var redirectResult = Assert.IsType&lt;PartialViewResult&gt;(result);
        Assert.Equal(1, project.ProjectGroups.Count(pg =&gt; pg.GroupId == 10));
    }

    [Fact]
    public async Task RemoveGroupFromProject_ReturnsNotFound_IfProjectNotFound()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.RemoveGroupFromProject(1, 10);

        // Assert
        Assert.IsType&lt;NotFoundResult&gt;(result);
    }

    [Fact]
    public async Task RemoveGroupFromProject_RemovesGroupIfExists()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var groupProject = new GroupProject { ProjectId = 1, GroupId = 10 };
        var project = new Project { Id = 1, Name = &quot;RemoveProject&quot;, ProjectGroups = new List&lt;GroupProject&gt; { groupProject }, Description = &quot;Test Description&quot;};
        dbContext.Projects.Add(project);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.RemoveGroupFromProject(1, 10);

        // Assert
        var redirectResult = Assert.IsType&lt;PartialViewResult&gt;(result);
        Assert.Equal(&quot;_ProjectGroupAssignmentPartial&quot;, redirectResult.ViewName);
        Assert.DoesNotContain(project.ProjectGroups, pg =&gt; pg.GroupId == 10);
    }

    [Fact]
    public async Task EditProject_Get_ReturnsViewIfProjectExists()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var project = new Project { Id = 50, Name = &quot;EditProject&quot;, Description = &quot;Test Description&quot;};
        dbContext.Projects.Add(project);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.EditProject(50);

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        var modelProject = Assert.IsType&lt;Project&gt;(viewResult.Model);
        Assert.Equal(&quot;EditProject&quot;, modelProject.Name);
        Assert.NotNull(viewResult.ViewData[&quot;ProjectLeads&quot;]);
    }

    [Fact]
    public async Task EditProject_Get_ReturnsNotFoundIfProjectDoesNotExist()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.EditProject(9999);

        // Assert
        Assert.IsType&lt;NotFoundResult&gt;(result);
    }

    [Fact]
    public async Task EditProject_Post_BadRequestIfIdMismatch()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var project = new Project { Id = 10, Name = &quot;Mismatch&quot; };
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.EditProject(5, project);

        // Assert
        Assert.IsType&lt;BadRequestResult&gt;(result);
    }

    [Fact]
    public async Task EditProject_Post_MissingUserId_ReturnsViewWithError()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var project = new Project { Id = 20, Name = &quot;MissingUser&quot;, Description = &quot;Test Description&quot; };
        dbContext.Projects.Add(project);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);
        _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(string.Empty);

        // Act
        var result = await controller.EditProject(20, project);

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        Assert.False(controller.ModelState.IsValid);
    }

    [Fact]
    public async Task EditProject_Post_Valid_ReturnsRedirect()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var project = new Project { Id = 30, Name = &quot;ValidEdit&quot;, Description = &quot;Test Description&quot;};
        dbContext.Projects.Add(project);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);
        _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(&quot;1&quot;);
        var claims = new List&lt;Claim&gt; { new Claim(ClaimTypes.NameIdentifier, &quot;1&quot;) };
        controller.ControllerContext.HttpContext = new DefaultHttpContext { User = new ClaimsPrincipal(new ClaimsIdentity(claims, &quot;TestAuth&quot;)) };

        // Act
        var result = await controller.EditProject(30, project);

        // Assert
        var redirectResult = Assert.IsType&lt;RedirectToActionResult&gt;(result);
        Assert.Equal(&quot;ProjectDetails&quot;, redirectResult.ActionName);
    }

    public class ConcurrencyDbContext : ApplicationDbContext
    {
        public ConcurrencyDbContext(DbContextOptions&lt;ApplicationDbContext&gt; options)
            : base(options) { }

        public override Task&lt;int&gt; SaveChangesAsync(CancellationToken cancellationToken = default)
        {
            throw new DbUpdateConcurrencyException();
        }
    }

    [Fact]
    public async Task EditProject_Post_ConcurrencyException_ReturnsNotFound()
    {
        // Arrange
        var options = new DbContextOptionsBuilder&lt;ApplicationDbContext&gt;()
            .UseInMemoryDatabase(&quot;ConcurrencyTest&quot;)
            .Options;
        var dbContext = new ConcurrencyDbContext(options);
        var project = new Project { Id = 40, Name = &quot;Concurrency&quot; };
        // Do not add the project so that the check for existence fails.
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);
        _mockUserManager.Setup(um =&gt; um.GetUserId(It.IsAny&lt;ClaimsPrincipal&gt;())).Returns(&quot;1&quot;);
        var claims = new List&lt;Claim&gt; { new Claim(ClaimTypes.NameIdentifier, &quot;1&quot;) };
        controller.ControllerContext.HttpContext = new DefaultHttpContext { User = new ClaimsPrincipal(new ClaimsIdentity(claims, &quot;TestAuth&quot;)) };

        // Act
        var result = await controller.EditProject(40, project);

        // Assert
        Assert.IsType&lt;NotFoundResult&gt;(result);
    }

    [Fact]
    public async Task DeleteProject_RemovesProjectIfExists()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var project = new Project { Id = 55, Name = &quot;ToDelete&quot;, Description = &quot;Test Description&quot; };
        dbContext.Projects.Add(project);
        await dbContext.SaveChangesAsync();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.DeleteProject(55);

        // Assert
        var redirectResult = Assert.IsType&lt;RedirectToActionResult&gt;(result);
        Assert.False(dbContext.Projects.Any(p =&gt; p.Id == 55));
    }

    [Fact]
    public async Task DeleteProject_RedirectsIfProjectNotFound()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.DeleteProject(999);

        // Assert
        Assert.IsType&lt;RedirectToActionResult&gt;(result);
    }

    [Fact]
    public async Task Users_ReturnsEmptyViewIfNoUsers()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        // Act
        var result = await controller.Users();

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        var model = Assert.IsAssignableFrom&lt;IEnumerable&lt;User&gt;&gt;(viewResult.Model);
        Assert.Empty(model);
    }

    [Fact]
    public async Task CreateProject_ReturnsViewWithErrors_IfModelStateInvalid()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        controller.ModelState.AddModelError(&quot;Name&quot;, &quot;Required&quot;);

        var users = await dbContext.Users.ToListAsync();

        CreateProjectViewModel model = new CreateProjectViewModel
        {
            ProjectLeads = users.Select(u =&gt; new SelectListItem
            {
                Value = u.Id.ToString(),
                Text = u.UserName
            }).ToList()
        };

        // Act
        var result = await controller.CreateProject(model);

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        Assert.False(controller.ModelState.IsValid);
    }

    [Fact]
    public async Task UserAdd_CreatesUserAndRedirects_WhenSuccessful()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);
        var model = new UserViewModel { UserName = &quot;NewUser&quot;, Email = &quot;new@example.com&quot;, Password = &quot;Test@123&quot; , ConfirmPassword = &quot;Test@123&quot; };

        _mockUserManager.Setup(um =&gt; um.CreateAsync(It.IsAny&lt;User&gt;(), model.Password))
            .ReturnsAsync(IdentityResult.Success);
        _mockUserManager.Setup(um =&gt; um.AddToRoleAsync(It.IsAny&lt;User&gt;(), &quot;Employee&quot;))
            .ReturnsAsync(IdentityResult.Success);

        // Act
        var result = await controller.UserAdd(model);

        // Assert
        var redirectResult = Assert.IsType&lt;RedirectToActionResult&gt;(result);
        Assert.Equal(&quot;Users&quot;, redirectResult.ActionName);
    }

    [Fact]
    public async Task UserAdd_ReturnsViewWithErrors_WhenUserCreationFails()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);
        var model = new UserViewModel { UserName = &quot;NewUser&quot;, Email = &quot;new@example.com&quot;, Password = &quot;Test@123&quot;, ConfirmPassword = &quot;Test@123&quot; };

        var identityErrors = new IdentityError[] { new IdentityError { Code = &quot;Error1&quot;, Description = &quot;User creation failed&quot; } };
        _mockUserManager.Setup(um =&gt; um.CreateAsync(It.IsAny&lt;User&gt;(), model.Password))
            .ReturnsAsync(IdentityResult.Failed(identityErrors));

        // Act
        var result = await controller.UserAdd(model);

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        Assert.False(controller.ModelState.IsValid);
        Assert.Contains(&quot;User creation failed&quot;, controller.ModelState[string.Empty].Errors.First().ErrorMessage);
    }

    [Fact]
    public async Task UserAdd_ReturnsViewWithErrors_WhenRoleAssignmentFails()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);
        var model = new UserViewModel { UserName = &quot;NewUser&quot;, Email = &quot;new@example.com&quot;, Password = &quot;Test@123&quot;, ConfirmPassword = &quot;Test@123&quot; };

        _mockUserManager.Setup(um =&gt; um.CreateAsync(It.IsAny&lt;User&gt;(), model.Password))
            .ReturnsAsync(IdentityResult.Success);

        var identityErrors = new IdentityError[] { new IdentityError { Code = &quot;Error2&quot;, Description = &quot;Role assignment failed&quot; } };
        _mockUserManager.Setup(um =&gt; um.AddToRoleAsync(It.IsAny&lt;User&gt;(), &quot;Employee&quot;))
            .ReturnsAsync(IdentityResult.Failed(identityErrors));

        // Act
        var result = await controller.UserAdd(model);

        // Assert
        var viewResult = Assert.IsType&lt;ViewResult&gt;(result);
        Assert.False(controller.ModelState.IsValid);
        Assert.Contains(&quot;Role assignment failed&quot;, controller.ModelState[string.Empty].Errors.First().ErrorMessage);
    }

    [Fact]
    public async Task UserEdit_UpdatesUserAndRedirects_WhenSuccessful()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);
        var user = new User { Id = 1, UserName = &quot;OldUser&quot;, Email = &quot;old@example.com&quot; };

        _mockUserManager.Setup(um =&gt; um.FindByIdAsync(user.Id.ToString()))
            .ReturnsAsync(user);
        _mockUserManager.Setup(um =&gt; um.UpdateAsync(It.IsAny&lt;User&gt;()))
            .ReturnsAsync(IdentityResult.Success);
        _mockUserManager.Setup(um =&gt; um.GetRolesAsync(user))
            .ReturnsAsync(new List&lt;string&gt; { &quot;Employee&quot; });
        _mockUserManager.Setup(um =&gt; um.RemoveFromRolesAsync(user, It.IsAny&lt;IEnumerable&lt;string&gt;&gt;()))
            .ReturnsAsync(IdentityResult.Success);
        _mockUserManager.Setup(um =&gt; um.AddToRoleAsync(user, &quot;Admin&quot;))
            .ReturnsAsync(IdentityResult.Success);

        // Act
        var result = await controller.UserEdit(user.Id.ToString(), &quot;UpdatedUser&quot;, &quot;updated@example.com&quot;, &quot;Admin&quot;);

        // Assert
        var redirectResult = Assert.IsType&lt;RedirectToActionResult&gt;(result);
        Assert.Equal(&quot;Users&quot;, redirectResult.ActionName);
        Assert.Equal(&quot;UpdatedUser&quot;, user.UserName);
        Assert.Equal(&quot;updated@example.com&quot;, user.Email);
    }

    [Fact]
    public async Task UserEdit_ReturnsNotFound_WhenUserDoesNotExist()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);

        _mockUserManager.Setup(um =&gt; um.FindByIdAsync(&quot;999&quot;))
            .ReturnsAsync((User)null);

        // Act
        var result = await controller.UserEdit(&quot;999&quot;, &quot;UpdatedUser&quot;, &quot;updated@example.com&quot;, &quot;Admin&quot;);

        // Assert
        Assert.IsType&lt;NotFoundResult&gt;(result);
    }

    [Fact]
    public async Task UserEdit_RemovesExistingRolesBeforeAddingNewRole()
    {
        // Arrange
        var dbContext = TestHelper.GetDbContext();
        var controller = new AdminController(dbContext, _mockUserManager.Object, _mockRoleManager.Object);
        var user = new User { Id = 1, UserName = &quot;TestUser&quot;, Email = &quot;test@example.com&quot; };

        _mockUserManager.Setup(um =&gt; um.FindByIdAsync(user.Id.ToString()))
            .ReturnsAsync(user);
        _mockUserManager.Setup(um =&gt; um.UpdateAsync(user))
            .ReturnsAsync(IdentityResult.Success);
        _mockUserManager.Setup(um =&gt; um.GetRolesAsync(user))
            .ReturnsAsync(new List&lt;string&gt; { &quot;Manager&quot;, &quot;Employee&quot; });
        _mockUserManager.Setup(um =&gt; um.RemoveFromRolesAsync(user, It.IsAny&lt;IEnumerable&lt;string&gt;&gt;()))
            .ReturnsAsync(IdentityResult.Success);
        _mockUserManager.Setup(um =&gt; um.AddToRoleAsync(user, &quot;Admin&quot;))
            .ReturnsAsync(IdentityResult.Success);

        // Act
        var result = await controller.UserEdit(user.Id.ToString(), &quot;UpdatedUser&quot;, &quot;updated@example.com&quot;, &quot;Admin&quot;);

        // Assert
        var redirectResult = Assert.IsType&lt;RedirectToActionResult&gt;(result);
        Assert.Equal(&quot;Users&quot;, redirectResult.ActionName);

        _mockUserManager.Verify(um =&gt; um.RemoveFromRolesAsync(user, It.IsAny&lt;IEnumerable&lt;string&gt;&gt;()), Times.Once);
        _mockUserManager.Verify(um =&gt; um.AddToRoleAsync(user, &quot;Admin&quot;), Times.Once);
    }

}

    </pre>
    <script type="text/javascript">
      highlightRanges([[29,5,29,34,1],[30,5,30,6,1],[31,9,31,49,1],[32,9,32,49,1],[33,9,33,48,1],[36,9,41,25,1],[42,9,42,67,1],[44,9,45,80,1],[46,5,46,6,1],[49,5,49,6,1],[50,9,50,58,1],[51,9,52,61,1],[53,5,53,6,1],[56,5,56,6,1],[57,9,57,71,1],[58,9,59,37,1],[60,5,60,6,1],[66,5,66,6,1],[68,9,68,51,1],[69,9,69,99,1],[70,9,70,99,1],[71,9,71,44,1],[72,9,72,107,1],[75,9,75,47,1],[78,9,78,60,1],[79,9,79,82,1],[80,9,80,40,1],[81,5,81,6,1],[85,5,85,6,1],[86,9,86,108,1],[88,9,88,55,1],[90,9,90,47,1],[91,5,91,6,1],[95,5,95,6,1],[96,9,96,108,1],[97,9,97,89,1],[98,9,98,47,1],[99,9,99,45,1],[101,9,101,95,1],[102,9,102,105,1],[104,9,108,26,1],[110,9,110,68,1],[112,9,112,60,1],[113,9,113,59,1],[114,9,114,41,1],[115,9,115,53,1],[117,9,117,50,1],[118,9,118,60,1],[119,9,119,63,1],[120,5,120,6,1],[124,5,124,6,1],[125,9,125,108,1],[127,9,127,43,1],[129,9,129,43,1],[130,5,130,6,1],[134,5,134,6,1],[136,9,136,51,1],[137,9,137,96,1],[138,9,138,35,1],[139,9,139,44,1],[140,9,140,107,1],[143,9,143,55,1],[146,9,146,60,1],[147,9,147,63,1],[148,9,148,56,1],[149,5,149,6,1],[153,5,153,6,1],[155,9,155,51,1],[156,9,156,107,1],[159,9,159,56,1],[162,9,162,47,1],[163,5,163,6,1],[167,5,167,6,1],[169,9,169,51,1],[170,9,170,97,1],[171,9,171,35,1],[172,9,172,44,1],[173,9,173,107,1],[176,9,176,55,1],[179,9,179,60,1],[180,9,180,78,1],[181,9,181,61,1],[182,5,182,6,1],[186,5,186,6,1],[188,9,188,51,1],[189,9,189,107,1],[192,9,192,55,1],[195,9,195,47,1],[196,5,196,6,1],[200,5,200,6,1],[202,9,202,51,1],[203,9,203,103,1],[204,9,204,35,1],[205,9,205,44,1],[206,9,206,107,1],[209,9,209,60,1],[212,9,212,76,1],[213,9,213,61,1],[214,5,214,6,1],[220,5,220,6,1],[222,9,222,51,1],[223,9,223,103,1],[224,9,224,103,1],[225,9,225,44,1],[226,9,226,107,1],[229,9,229,48,1],[232,9,232,60,1],[233,9,233,84,1],[234,9,234,41,1],[235,5,235,6,1],[239,5,239,6,1],[241,9,241,51,1],[243,9,243,107,1],[244,9,244,43,1],[245,9,245,33,1],[248,9,249,33,1],[250,9,251,34,1],[252,9,253,34,1],[254,9,255,33,1],[257,9,257,107,1],[260,9,260,52,1],[262,9,265,37,1],[266,9,266,48,1],[268,9,268,64,1],[269,9,269,117,1],[272,9,272,47,1],[275,9,275,60,1],[276,9,276,58,1],[277,9,277,72,1],[278,9,278,34,1],[279,9,279,66,1],[280,5,280,6,1],[284,5,284,6,1],[286,9,286,51,1],[287,9,287,107,1],[290,9,290,57,1],[293,9,293,47,1],[294,5,294,6,1],[298,5,298,6,1],[300,9,300,51,1],[301,9,306,11,1],[307,9,307,37,1],[309,9,309,104,1],[310,9,310,107,1],[311,9,311,61,1],[314,9,314,96,1],[315,9,315,95,1],[317,9,317,44,1],[319,9,319,107,1],[322,9,322,56,1],[325,9,325,60,1],[326,9,326,65,1],[327,9,327,55,1],[329,9,329,59,1],[330,9,330,79,1],[331,9,331,36,1],[332,9,332,43,1],[334,9,334,43,1],[334,43,334,81,1],[334,81,334,83,1],[335,9,335,43,1],[335,43,335,80,1],[335,80,335,82,1],[336,5,336,6,1],[340,5,340,6,1],[342,9,342,51,1],[344,9,350,11,1],[352,9,352,107,1],[355,9,358,37,1],[361,9,361,52,1],[362,9,362,48,1],[363,9,363,64,1],[366,9,366,81,1],[367,9,367,85,1],[370,9,370,67,1],[373,9,373,60,1],[374,9,374,53,1],[375,5,375,6,1],[379,5,379,6,1],[381,9,381,51,1],[383,9,383,98,1],[384,9,384,101,1],[385,9,385,94,1],[386,9,386,74,1],[387,9,387,44,1],[389,9,395,11,1],[398,9,398,107,1],[401,9,404,37,1],[407,9,407,81,1],[408,9,408,64,1],[411,9,411,81,1],[412,9,412,85,1],[415,9,415,52,1],[416,9,416,47,1],[419,9,419,67,1],[422,9,422,76,1],[423,9,423,59,1],[424,9,424,59,1],[425,9,425,60,1],[426,5,426,6,1],[430,5,430,6,1],[432,9,432,51,1],[433,9,433,100,1],[434,9,434,37,1],[435,9,435,44,1],[436,9,436,107,1],[439,9,439,55,1],[442,9,442,76,1],[443,9,443,61,1],[444,5,444,6,1],[448,5,448,6,1],[450,9,450,51,1],[451,9,451,107,1],[454,9,454,56,1],[457,9,457,55,1],[458,5,458,6,1],[462,5,462,6,1],[464,9,464,51,1],[465,9,465,107,1],[468,9,468,61,1],[469,9,469,48,1],[471,9,471,110,1],[472,9,472,44,1],[474,9,474,63,1],[475,9,475,48,1],[476,5,476,6,1],[480,5,480,6,1],[482,9,482,51,1],[483,9,483,97,1],[484,9,484,98,1],[485,9,485,37,1],[486,9,486,35,1],[487,9,487,44,1],[489,9,489,107,1],[492,9,492,62,1],[495,9,495,71,1],[496,9,496,78,1],[499,9,499,53,1],[499,53,499,111,1],[499,111,499,113,1],[500,5,500,6,1],[504,5,504,6,1],[506,9,506,51,1],[507,9,507,107,1],[510,9,510,71,1],[511,9,511,48,1],[514,9,520,12,1],[521,9,521,44,1],[522,9,522,73,1],[523,9,523,48,1],[524,5,524,6,1],[528,5,528,6,1],[530,9,530,51,1],[531,9,537,11,1],[538,9,543,11,1],[544,9,548,11,1],[549,9,549,37,1],[550,9,550,35,1],[551,9,551,51,1],[552,9,552,44,1],[553,9,553,107,1],[556,9,556,71,1],[559,9,559,76,1],[560,9,560,65,1],[561,9,561,56,1],[561,56,561,91,1],[561,91,561,93,1],[562,9,562,43,1],[563,5,563,6,1],[570,5,570,6,1],[572,9,572,51,1],[573,9,573,109,1],[574,9,574,109,1],[575,9,575,44,1],[576,9,576,107,1],[579,9,579,50,1],[582,9,582,60,1],[583,9,583,88,1],[584,9,584,43,1],[585,5,585,6,1],[589,5,589,6,1],[591,9,591,51,1],[592,9,592,99,1],[593,9,593,99,1],[594,9,594,44,1],[595,9,595,107,1],[597,9,604,11,1],[607,9,607,55,1],[610,9,610,60,1],[611,9,611,44,1],[612,9,612,51,1],[613,5,613,6,1],[617,5,617,6,1],[618,9,618,69,1],[620,9,620,51,1],[621,9,621,107,1],[622,9,622,65,1],[623,9,623,71,1],[624,9,624,57,1],[626,9,626,48,1],[626,48,630,10,0],[630,10,630,21,1],[632,9,639,11,1],[641,9,641,64,1],[644,9,644,60,1],[645,9,645,51,1],[646,5,646,6,1],[650,5,650,6,1],[652,9,652,51,1],[653,9,653,107,1],[654,9,654,103,1],[655,9,655,70,1],[656,9,656,57,1],[658,9,660,46,1],[660,46,664,14,0],[664,14,665,11,1],[668,9,668,60,1],[671,9,671,60,1],[672,9,672,53,1],[673,9,673,57,1],[674,5,674,6,1],[678,5,678,6,1],[680,9,680,51,1],[681,9,681,107,1],[684,9,684,94,1],[687,9,687,84,1],[688,9,691,11,1],[694,9,696,37,1],[699,9,699,77,1],[700,9,701,63,1],[703,9,703,52,1],[704,9,704,47,1],[706,9,706,57,1],[708,9,712,46,1],[712,46,716,14,0],[716,14,717,11,1],[720,9,720,60,1],[723,9,723,76,1],[724,9,724,61,1],[725,9,725,76,1],[726,5,726,6,1],[731,5,731,6,1],[733,9,733,51,1],[734,9,734,107,1],[737,9,737,60,1],[740,9,740,47,1],[741,5,741,6,1],[745,5,745,6,1],[747,9,747,51,1],[748,9,748,107,1],[751,9,751,67,1],[752,9,752,48,1],[755,9,755,113,1],[756,9,756,44,1],[757,9,757,68,1],[758,9,758,48,1],[759,5,759,6,1],[763,5,763,6,1],[765,9,765,51,1],[766,9,766,145,1],[767,9,767,97,1],[768,9,768,41,1],[769,9,769,37,1],[770,9,770,44,1],[771,9,771,107,1],[774,9,774,67,1],[777,9,777,71,1],[778,9,778,81,1],[779,9,779,54,1],[779,54,779,70,1],[779,70,779,72,1],[780,5,780,6,1],[784,5,784,6,1],[786,9,786,51,1],[787,9,787,77,1],[788,9,788,162,1],[789,9,789,98,1],[790,9,790,41,1],[791,9,791,37,1],[792,9,792,44,1],[793,9,793,107,1],[796,9,796,67,1],[799,9,799,71,1],[800,9,800,59,1],[800,59,800,75,1],[800,75,800,78,1],[801,5,801,6,1],[805,5,805,6,1],[807,9,807,51,1],[808,9,808,107,1],[811,9,811,69,1],[814,9,814,47,1],[815,5,815,6,1],[819,5,819,6,1],[821,9,821,51,1],[822,9,822,77,1],[823,9,823,160,1],[824,9,824,41,1],[825,9,825,44,1],[826,9,826,107,1],[829,9,829,69,1],[832,9,832,71,1],[833,9,833,81,1],[834,9,834,60,1],[834,60,834,76,0],[834,76,834,78,1],[835,5,835,6,1],[839,5,839,6,1],[841,9,841,51,1],[842,9,842,102,1],[843,9,843,41,1],[844,9,844,44,1],[845,9,845,107,1],[848,9,848,55,1],[851,9,851,60,1],[852,9,852,69,1],[853,9,853,56,1],[854,9,854,61,1],[855,5,855,6,1],[859,5,859,6,1],[861,9,861,51,1],[862,9,862,107,1],[865,9,865,57,1],[868,9,868,47,1],[869,5,869,6,1],[873,5,873,6,1],[875,9,875,51,1],[876,9,876,66,1],[877,9,877,107,1],[880,9,880,63,1],[883,9,883,49,1],[884,5,884,6,1],[888,5,888,6,1],[890,9,890,51,1],[891,9,891,103,1],[892,9,892,41,1],[893,9,893,44,1],[894,9,894,107,1],[895,9,895,103,1],[898,9,898,64,1],[901,9,901,60,1],[902,9,902,53,1],[903,5,903,6,1],[907,5,907,6,1],[909,9,909,51,1],[910,9,910,100,1],[911,9,911,41,1],[912,9,912,44,1],[913,9,913,107,1],[914,9,914,94,1],[915,9,915,84,1],[916,9,916,146,1],[919,9,919,64,1],[922,9,922,76,1],[923,9,923,67,1],[924,5,924,6,1],[929,15,929,28,1],[929,29,929,30,1],[929,31,929,32,1],[932,9,932,10,1],[933,13,933,54,1],[939,5,939,6,1],[941,9,943,22,1],[944,9,944,59,1],[945,9,945,69,1],[947,9,947,107,1],[948,9,948,94,1],[949,9,949,84,1],[950,9,950,146,1],[953,9,953,64,1],[956,9,956,47,1],[957,5,957,6,1],[961,5,961,6,1],[963,9,963,51,1],[964,9,964,100,1],[965,9,965,41,1],[966,9,966,44,1],[967,9,967,107,1],[970,9,970,57,1],[973,9,973,76,1],[974,9,974,63,1],[975,5,975,6,1],[979,5,979,6,1],[981,9,981,51,1],[982,9,982,107,1],[985,9,985,58,1],[988,9,988,55,1],[989,5,989,6,1],[993,5,993,6,1],[995,9,995,51,1],[996,9,996,107,1],[999,9,999,47,1],[1002,9,1002,60,1],[1003,9,1003,82,1],[1004,9,1004,29,1],[1005,5,1005,6,1],[1009,5,1009,6,1],[1011,9,1011,51,1],[1012,9,1012,107,1],[1014,9,1014,65,1],[1016,9,1016,57,1],[1018,9,1020,46,1],[1020,46,1024,14,0],[1024,14,1025,11,1],[1028,9,1028,60,1],[1031,9,1031,60,1],[1032,9,1032,53,1],[1033,5,1033,6,1],[1037,5,1037,6,1],[1039,9,1039,51,1],[1040,9,1040,107,1],[1041,9,1041,145,1],[1043,9,1044,51,1],[1045,9,1046,51,1],[1049,9,1049,54,1],[1052,9,1052,76,1],[1053,9,1053,58,1],[1054,5,1054,6,1],[1058,5,1058,6,1],[1060,9,1060,51,1],[1061,9,1061,107,1],[1062,9,1062,144,1],[1064,9,1064,130,1],[1065,9,1066,66,1],[1069,9,1069,54,1],[1072,9,1072,60,1],[1073,9,1073,53,1],[1074,9,1074,114,1],[1075,5,1075,6,1],[1079,5,1079,6,1],[1081,9,1081,51,1],[1082,9,1082,107,1],[1083,9,1083,144,1],[1085,9,1086,51,1],[1088,9,1088,132,1],[1089,9,1090,66,1],[1093,9,1093,54,1],[1096,9,1096,60,1],[1097,9,1097,53,1],[1098,9,1098,116,1],[1099,5,1099,6,1],[1103,5,1103,6,1],[1105,9,1105,51,1],[1106,9,1106,107,1],[1107,9,1107,89,1],[1109,9,1110,33,1],[1111,9,1112,51,1],[1113,9,1114,60,1],[1115,9,1116,51,1],[1117,9,1118,51,1],[1121,9,1121,115,1],[1124,9,1124,76,1],[1125,9,1125,58,1],[1126,9,1126,52,1],[1127,9,1127,57,1],[1128,5,1128,6,1],[1132,5,1132,6,1],[1134,9,1134,51,1],[1135,9,1135,107,1],[1137,9,1138,39,1],[1141,9,1141,102,1],[1144,9,1144,47,1],[1145,5,1145,6,1],[1149,5,1149,6,1],[1151,9,1151,51,1],[1152,9,1152,107,1],[1153,9,1153,91,1],[1155,9,1156,33,1],[1157,9,1158,51,1],[1159,9,1160,71,1],[1161,9,1162,51,1],[1163,9,1164,51,1],[1167,9,1167,115,1],[1170,9,1170,76,1],[1171,9,1171,58,1],[1173,9,1173,115,1],[1174,9,1174,85,1],[1175,5,1175,6,1]]);
    </script>
  </body>
</html>