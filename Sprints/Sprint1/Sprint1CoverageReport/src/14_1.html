<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\ahmad\Documents\GitHub\Capstone-Project\code\TaskManager\Controllers\EmployeeController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using TaskManagerWebsite.Data;
using TaskManagerWebsite.Models;

namespace TaskManagerWebsite.Controllers
{
    [Authorize(Roles = &quot;Employee&quot;)]
    public class EmployeeController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager&lt;User&gt; _userManager;
        private readonly RoleManager&lt;IdentityRole&lt;int&gt;&gt; _roleManager;

        public EmployeeController(ApplicationDbContext context, UserManager&lt;User&gt; userManager, RoleManager&lt;IdentityRole&lt;int&gt;&gt; roleManager)
        {
            _context = context;
            _userManager = userManager;
            _roleManager = roleManager;
        }

        public async Task&lt;IActionResult&gt; Users()
        {
            var users = await _context.Users.ToListAsync();
            return View(users);
        }

        public async Task&lt;IActionResult&gt; Groups()
        {
            var groups = await _context.Groups.ToListAsync();
            return View(groups);
        }

        public async Task&lt;IActionResult&gt; Projects()
        {
            int userId = int.Parse(_userManager.GetUserId(User));
            ViewBag.UserId = userId;

            var projects = await _context.Projects
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .ThenInclude(g =&gt; g.Users)
                .Where(p =&gt; p.ProjectGroups.Any(pg =&gt; pg.Group.Users.Any(u =&gt; u.Id == userId)))
                .ToListAsync();

            return View(projects);
        }

        public async Task&lt;IActionResult&gt; ProjectDetails(int id)
        {
            var currentUserId = _userManager.GetUserId(User);
            ViewBag.UserId = currentUserId;

            var groups = await _context.Groups.Include(group =&gt; group.Managers).ToListAsync();
            var managedGroups = groups.Where(group =&gt; group.Managers
                .Any(manager =&gt; manager.UserId == int.Parse(currentUserId))).ToList();

            var managedGroupsToRemove = new List&lt;Group&gt;();

            foreach (var group1 in groups)
            {
                List&lt;Group&gt; groupsWithGivenProject = _context.GroupProjects
                    .Where(gp =&gt; gp.ProjectId == id)
                    .Select(gp =&gt; gp.Group)
                    .Distinct()
                    .ToList();
                foreach (var groupInProject in groupsWithGivenProject)
                {
                    if (groupInProject.Id == group1.Id)
                    {
                        managedGroupsToRemove.Add(group1);
                        break;
                    }
                }
            }

            managedGroups.RemoveAll(group =&gt; managedGroupsToRemove.Contains(group));
            ViewBag.ManagedGroups = managedGroups;

            var unmanagedGroups = groups.Where(group =&gt; !group.Managers
                .Any(manager =&gt; manager.UserId == int.Parse(currentUserId))).ToList();

            var groupsToRemove = new List&lt;Group&gt;();

            foreach (var group in unmanagedGroups)
            {
                List&lt;Group&gt; groupsWithGivenProject = _context.GroupProjects
                    .Where(gp =&gt; gp.ProjectId == id)
                    .Select(gp =&gt; gp.Group)
                    .Distinct()
                    .ToList();
                foreach (var groupInProject in groupsWithGivenProject)
                {
                    if (groupInProject.Id == group.Id)
                    {
                        groupsToRemove.Add(group);
                        break;
                    }
                }
            }

            unmanagedGroups.RemoveAll(group =&gt; groupsToRemove.Contains(group));
            ViewBag.UnmanagedGroups = unmanagedGroups;

            var project = await _context.Projects
                .Include(p =&gt; p.ProjectLead)
                .Include(p =&gt; p.ProjectGroups)
                .ThenInclude(pg =&gt; pg.Group)
                .FirstOrDefaultAsync(p =&gt; p.Id == id);

            if (project == null)
            {
                return NotFound();
            }

            return View(project);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,139,1],[18,9,18,10,1],[19,13,19,32,1],[20,13,20,40,1],[21,13,21,40,1],[22,9,22,10,1],[25,9,25,10,1],[26,13,26,60,1],[27,13,27,32,1],[28,9,28,10,1],[31,9,31,10,1],[32,13,32,62,1],[33,13,33,33,1],[34,9,34,10,1],[37,9,37,10,1],[38,13,38,66,1],[39,13,39,37,1],[41,13,46,32,1],[48,13,48,35,1],[49,9,49,10,1],[52,9,52,10,1],[53,13,53,62,1],[54,13,54,44,1],[56,13,56,95,1],[57,13,57,55,1],[57,55,58,33,1],[58,33,58,75,1],[58,75,58,76,1],[58,76,58,87,1],[60,13,60,59,1],[62,13,62,20,1],[62,22,62,32,1],[62,33,62,35,1],[62,36,62,42,1],[63,13,63,14,1],[64,17,68,31,1],[69,17,69,24,1],[69,26,69,44,1],[69,45,69,47,1],[69,48,69,70,1],[70,17,70,18,1],[71,21,71,56,1],[72,21,72,22,1],[73,25,73,59,1],[74,25,74,31,1],[76,17,76,18,1],[77,13,77,14,1],[79,13,79,46,1],[79,46,79,83,1],[79,83,79,85,1],[80,13,80,51,1],[82,13,82,57,1],[82,57,83,33,1],[83,33,83,75,1],[83,75,83,76,1],[83,76,83,87,1],[85,13,85,52,1],[87,13,87,20,1],[87,22,87,31,1],[87,32,87,34,1],[87,35,87,50,1],[88,13,88,14,1],[89,17,93,31,1],[94,17,94,24,1],[94,26,94,44,1],[94,45,94,47,1],[94,48,94,70,1],[95,17,95,18,1],[96,21,96,55,1],[97,21,97,22,1],[98,25,98,51,1],[99,25,99,31,1],[101,17,101,18,1],[102,13,102,14,1],[104,13,104,48,1],[104,48,104,78,1],[104,78,104,80,1],[105,13,105,55,1],[107,13,111,55,1],[113,13,113,33,1],[114,13,114,14,1],[115,17,115,35,1],[118,13,118,34,1],[119,9,119,10,1]]);
    </script>
  </body>
</html>